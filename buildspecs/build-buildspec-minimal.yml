version: 0.2

env:
  variables:
    PROJECT_NAME: "aws-elasticdrs-orchestrator"
    ENVIRONMENT: "dev"
    DEPLOYMENT_BUCKET: "aws-elasticdrs-orchestrator"

phases:
  install:
    runtime-versions:
      python: 3.12
      nodejs: 18
    commands:
      - echo "Installing build dependencies..."
      - pip install --upgrade pip
      - pip install boto3 crhelper

  pre_build:
    commands:
      - echo "=== BUILD PHASE STARTED ==="
      - echo "Project $PROJECT_NAME"
      - echo "Environment $ENVIRONMENT"

  build:
    commands:
      - echo "=== Building Lambda Packages ==="
      - echo "Building Lambda packages..."
      - echo "=== Uploading Build Artifacts to S3 ==="
      - echo "Uploading Lambda packages..."
      - aws s3 sync lambda/ s3://$DEPLOYMENT_BUCKET/lambda/ --exclude "*" --include "*.zip" --delete
      - echo "Uploading CloudFormation templates..."
      - aws s3 sync cfn/ s3://$DEPLOYMENT_BUCKET/cfn/ --exclude "*.md" --delete

  post_build:
    commands:
      - echo "=== BUILD PHASE COMPLETED ==="
      - echo "Build completed successfully"

artifacts:
  files:
    - '**/*'
  name: BuiltArtifacts

cache:
  paths:
    - '/root/.cache/pip/**/*'