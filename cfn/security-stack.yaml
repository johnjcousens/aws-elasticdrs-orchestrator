AWSTemplateFormatVersion: '2010-09-09'
Description: 'AWS DRS Orchestration - Security Stack (WAF, CloudTrail, Secrets Manager)'

Parameters:
  # Required parameters passed from master template
  ProjectName:
    Type: String
    Description: 'Project name used for resource naming'

  Environment:
    Type: String
    Description: 'Environment name (dev, test, prod)'

  # Optional: API Gateway references for WAF association
  RestApiId:
    Type: String
    Default: ''
    Description: 'API Gateway REST API ID for WAF association'

  ApiStageName:
    Type: String
    Default: ''
    Description: 'API Gateway stage name for WAF association'

  # Optional: DynamoDB table ARNs for CloudTrail data events
  ProtectionGroupsTableArn:
    Type: String
    Default: ''
    Description: 'Protection Groups DynamoDB table ARN'

  RecoveryPlansTableArn:
    Type: String
    Default: ''
    Description: 'Recovery Plans DynamoDB table ARN'

  ExecutionHistoryTableArn:
    Type: String
    Default: ''
    Description: 'Execution History DynamoDB table ARN'

  # Optional: S3 bucket ARN for CloudTrail data events
  FrontendBucketArn:
    Type: String
    Default: ''
    Description: 'Frontend S3 bucket ARN'

  CrossAccountRoleArns:
    Type: CommaDelimitedList
    Default: ''
    Description: 'Optional: Comma-separated list of cross-account role ARNs for DRS operations'

  EnableWAF:
    Type: String
    Default: 'true'
    Description: 'Enable AWS WAF for API Gateway protection'
    AllowedValues:
      - 'true'
      - 'false'

  EnableCloudTrail:
    Type: String
    Default: 'true'
    Description: 'Enable CloudTrail logging for audit trail'
    AllowedValues:
      - 'true'
      - 'false'

  AllowedIPRanges:
    Type: CommaDelimitedList
    Default: '0.0.0.0/0'
    Description: 'Comma-separated list of allowed IP ranges for API access (CIDR notation)'

Conditions:
  HasCrossAccountRoles: !Not [!Equals [!Select [0, !Ref CrossAccountRoleArns], '']]
  EnableWAFCondition: !Equals [!Ref EnableWAF, 'true']
  EnableCloudTrailCondition: !Equals [!Ref EnableCloudTrail, 'true']
  HasRestApi: !Not [!Equals [!Ref RestApiId, '']]
  EnableWAFWithApi: !And [!Condition EnableWAFCondition, !Condition HasRestApi]
  HasDynamoDBTables: !Not [!Equals [!Ref ProtectionGroupsTableArn, '']]
  HasFrontendBucket: !Not [!Equals [!Ref FrontendBucketArn, '']]

# Security Resources to Add:

Resources:
  # ============================================================================
  # AWS SECRETS MANAGER - Secure credential storage
  # ============================================================================
  
  DRSCredentialsSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${ProjectName}/drs-credentials'
      Description: 'Credentials for DRS cross-account operations'
      SecretString: !If
        - HasCrossAccountRoles
        - !Join
          - ''
          - - '{"cross_account_roles": ["'
            - !Join ['","', !Ref CrossAccountRoleArns]
            - '"],"notification_endpoints": [],"api_keys": {}}'
        - '{"cross_account_roles": [],"notification_endpoints": [],"api_keys": {}}'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Secret rotation Lambda (placeholder for future enhancement)
  SecretRotationLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: SecretsManagerAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:DescribeSecret
                  - secretsmanager:GetSecretValue
                  - secretsmanager:PutSecretValue
                  - secretsmanager:UpdateSecretVersionStage
                Resource: !Ref DRSCredentialsSecret
      Tags:
        - Key: Project
          Value: !Ref ProjectName

  # ============================================================================
  # AWS WAF - API Gateway Protection
  # ============================================================================
  
  WAFLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: EnableWAFCondition
    Properties:
      LogGroupName: !Sub 'aws-waf-logs-${ProjectName}'
      RetentionInDays: 30

  WAFWebACL:
    Type: AWS::WAFv2::WebACL
    Condition: EnableWAFCondition
    Properties:
      Name: !Sub '${ProjectName}-waf'
      Scope: REGIONAL
      DefaultAction:
        Allow: {}
      Description: 'WAF rules for DRS Orchestration API'
      Rules:
        # Rule 1: Rate limiting
        - Name: RateLimitRule
          Priority: 1
          Statement:
            RateBasedStatement:
              Limit: 2000
              AggregateKeyType: IP
          Action:
            Block:
              CustomResponse:
                ResponseCode: 429
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: RateLimitRule
        
        # Rule 2: IP allowlist (if not 0.0.0.0/0)
        - Name: IPAllowlistRule
          Priority: 2
          Statement:
            NotStatement:
              Statement:
                IPSetReferenceStatement:
                  Arn: !GetAtt IPAllowlistSet.Arn
          Action:
            Block:
              CustomResponse:
                ResponseCode: 403
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: IPAllowlistRule
        
        # Rule 3: AWS Managed Rules - Core Rule Set
        - Name: AWSManagedRulesCommonRuleSet
          Priority: 3
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesCommonRuleSet
              ExcludedRules: []
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: AWSManagedRulesCommonRuleSet
        
        # Rule 4: AWS Managed Rules - Known Bad Inputs
        - Name: AWSManagedRulesKnownBadInputsRuleSet
          Priority: 4
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesKnownBadInputsRuleSet
              ExcludedRules: []
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: AWSManagedRulesKnownBadInputsRuleSet
        
        # Rule 5: AWS Managed Rules - SQL Injection
        - Name: AWSManagedRulesSQLiRuleSet
          Priority: 5
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesSQLiRuleSet
              ExcludedRules: []
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: AWSManagedRulesSQLiRuleSet
        
        # Rule 6: Geo-blocking (example - block high-risk countries)
        - Name: GeoBlockingRule
          Priority: 6
          Statement:
            GeoMatchStatement:
              CountryCodes:
                - CN
                - RU
                - KP
          Action:
            Block:
              CustomResponse:
                ResponseCode: 403
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: GeoBlockingRule
      
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: !Sub '${ProjectName}-waf'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IP Allowlist Set
  IPAllowlistSet:
    Type: AWS::WAFv2::IPSet
    Condition: EnableWAFCondition
    Properties:
      Name: !Sub '${ProjectName}-ip-allowlist'
      Scope: REGIONAL
      IPAddressVersion: IPV4
      Addresses: !Ref AllowedIPRanges
      Tags:
        - Key: Project
          Value: !Ref ProjectName

  # Associate WAF with API Gateway (only if API Gateway ID is provided)
  WAFAssociation:
    Type: AWS::WAFv2::WebACLAssociation
    Condition: EnableWAFWithApi
    Properties:
      ResourceArn: !Sub 'arn:aws:apigateway:${AWS::Region}::/restapis/${RestApiId}/stages/${ApiStageName}'
      WebACLArn: !GetAtt WAFWebACL.Arn

  # WAF Logging Configuration
  WAFLoggingConfiguration:
    Type: AWS::WAFv2::LoggingConfiguration
    Condition: EnableWAFCondition
    DependsOn: WAFLogGroup
    Properties:
      ResourceArn: !GetAtt WAFWebACL.Arn
      LogDestinationConfigs:
        - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:aws-waf-logs-${ProjectName}'
      RedactedFields:
        - SingleHeader:
            Name: authorization

  # ============================================================================
  # CLOUDTRAIL - Audit Trail and Compliance
  # ============================================================================
  
  CloudTrailBucket:
    Type: AWS::S3::Bucket
    Condition: EnableCloudTrailCondition
    DeletionPolicy: Delete
    Properties:
      BucketName: !Sub '${ProjectName}-cloudtrail-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: 90
          - Id: DeleteIncompleteMultipartUploads
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
          - Id: DeleteNonCurrentVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 1
          - Id: TransitionToIA
            Status: Enabled
            Transitions:
              - TransitionInDays: 30
                StorageClass: STANDARD_IA
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  CloudTrailBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Condition: EnableCloudTrailCondition
    Properties:
      Bucket: !Ref CloudTrailBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AWSCloudTrailAclCheck
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:GetBucketAcl
            Resource: !GetAtt CloudTrailBucket.Arn
          - Sid: AWSCloudTrailWrite
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:PutObject
            Resource: !Sub '${CloudTrailBucket.Arn}/*'
            Condition:
              StringEquals:
                s3:x-amz-acl: bucket-owner-full-control

  CloudTrail:
    Type: AWS::CloudTrail::Trail
    Condition: EnableCloudTrailCondition
    DependsOn: CloudTrailBucketPolicy
    Properties:
      TrailName: !Sub '${ProjectName}-trail'
      S3BucketName: !Ref CloudTrailBucket
      IncludeGlobalServiceEvents: true
      IsLogging: true
      IsMultiRegionTrail: true
      EnableLogFileValidation: true
      EventSelectors:
        # Management events
        - IncludeManagementEvents: true
          ReadWriteType: All
        # Lambda invocations
        - ReadWriteType: All
          DataResources:
            - Type: AWS::Lambda::Function
              Values:
                - !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function/${ProjectName}-*'
      InsightSelectors:
        - InsightType: ApiCallRateInsight
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # CloudWatch Log Group for CloudTrail
  CloudTrailLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: EnableCloudTrailCondition
    Properties:
      LogGroupName: !Sub '/aws/cloudtrail/${ProjectName}'
      RetentionInDays: 90

  CloudTrailLogGroupRole:
    Type: AWS::IAM::Role
    Condition: EnableCloudTrailCondition
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CloudTrailLogPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !GetAtt CloudTrailLogGroup.Arn
      Tags:
        - Key: Project
          Value: !Ref ProjectName

  # ============================================================================
  # API GATEWAY REQUEST MODELS - Input Validation
  # Note: These models require RestApiId to be provided
  # ============================================================================
  
  # Model: Protection Group Create/Update
  ProtectionGroupModel:
    Type: AWS::ApiGateway::Model
    Condition: HasRestApi
    Properties:
      RestApiId: !Ref RestApiId
      Name: ProtectionGroup
      ContentType: application/json
      Schema:
        $schema: 'http://json-schema.org/draft-04/schema#'
        title: Protection Group Schema
        type: object
        required:
          - Name
          - TagFilters
        properties:
          Name:
            type: string
            minLength: 1
            maxLength: 128
            pattern: '^[a-zA-Z0-9-_]+$'
          Description:
            type: string
            maxLength: 512
          TagFilters:
            type: array
            minItems: 1
            items:
              type: object
              required:
                - Key
                - Values
              properties:
                Key:
                  type: string
                  minLength: 1
                  maxLength: 128
                Values:
                  type: array
                  minItems: 1
                  items:
                    type: string
                    minLength: 1
                    maxLength: 256
          CrossAccountRoleArn:
            type: string
            pattern: '^arn:aws:iam::\d{12}:role/.+$'

  # Model: Recovery Plan Create/Update
  RecoveryPlanModel:
    Type: AWS::ApiGateway::Model
    Condition: HasRestApi
    Properties:
      RestApiId: !Ref RestApiId
      Name: RecoveryPlan
      ContentType: application/json
      Schema:
        $schema: 'http://json-schema.org/draft-04/schema#'
        title: Recovery Plan Schema
        type: object
        required:
          - Name
          - ProtectionGroupIds
          - Waves
        properties:
          Name:
            type: string
            minLength: 1
            maxLength: 128
            pattern: '^[a-zA-Z0-9-_]+$'
          Description:
            type: string
            maxLength: 512
          ProtectionGroupIds:
            type: array
            minItems: 1
            items:
              type: string
              pattern: '^pg-[a-zA-Z0-9]+$'
          Waves:
            type: array
            minItems: 1
            maxItems: 10
            items:
              type: object
              required:
                - WaveNumber
                - Name
              properties:
                WaveNumber:
                  type: integer
                  minimum: 1
                  maximum: 10
                Name:
                  type: string
                  minLength: 1
                  maxLength: 64
                WaitTime:
                  type: integer
                  minimum: 0
                  maximum: 3600
                DependsOn:
                  type: array
                  items:
                    type: integer
                    minimum: 1
                    maximum: 10
                Actions:
                  type: object
                  properties:
                    PreWave:
                      type: array
                      items:
                        type: object
                        required:
                          - Type
                        properties:
                          Type:
                            type: string
                            enum:
                              - SSM_COMMAND
                              - LAMBDA_INVOKE
                              - SNS_NOTIFY
                          Parameters:
                            type: object

  # Model: Execution Request
  ExecutionRequestModel:
    Type: AWS::ApiGateway::Model
    Condition: HasRestApi
    Properties:
      RestApiId: !Ref RestApiId
      Name: ExecutionRequest
      ContentType: application/json
      Schema:
        $schema: 'http://json-schema.org/draft-04/schema#'
        title: Execution Request Schema
        type: object
        required:
          - ExecutionType
        properties:
          ExecutionType:
            type: string
            enum:
              - DRILL
              - RECOVERY
          DryRun:
            type: boolean
            default: false
          NotificationEmail:
            type: string
            format: email

  # ============================================================================
  # CROSS-ACCOUNT IAM ROLE - For multi-account DRS operations
  # ============================================================================
  
  CrossAccountAssumeRolePolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: HasCrossAccountRoles
    Properties:
      ManagedPolicyName: !Sub '${ProjectName}-cross-account-assume'
      Description: 'Allows assuming cross-account roles for DRS operations'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - sts:AssumeRole
            Resource: !Ref CrossAccountRoleArns
          - Effect: Allow
            Action:
              - sts:GetCallerIdentity
            Resource: '*'

  # Update Lambda execution role to include cross-account permissions
  # This should be added to the Lambda stack's execution role

  # ============================================================================
  # ENHANCED MONITORING AND ALARMS
  # ============================================================================
  
  # API Gateway 4XX errors alarm
  ApiGateway4xxAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-api-4xx-errors'
      AlarmDescription: 'Alert on high rate of 4XX errors'
      MetricName: 4XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiName
          Value: !Sub '${ProjectName}-api'
      TreatMissingData: notBreaching

  # API Gateway 5XX errors alarm
  ApiGateway5xxAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-api-5xx-errors'
      AlarmDescription: 'Alert on any 5XX errors'
      MetricName: 5XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiName
          Value: !Sub '${ProjectName}-api'
      TreatMissingData: notBreaching

  # DynamoDB throttling alarm
  DynamoDBThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-dynamodb-throttle'
      AlarmDescription: 'Alert on DynamoDB throttling'
      MetricName: SystemErrors
      Namespace: AWS/DynamoDB
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

# Add to Outputs section:
Outputs:
  DRSCredentialsSecretArn:
    Description: 'Secrets Manager ARN for DRS credentials'
    Value: !Ref DRSCredentialsSecret
    Export:
      Name: !Sub '${AWS::StackName}-DRSCredentialsSecret'

  WAFWebACLArn:
    Description: 'WAF Web ACL ARN'
    Condition: EnableWAFCondition
    Value: !GetAtt WAFWebACL.Arn
    Export:
      Name: !Sub '${AWS::StackName}-WAFWebACL'

  CloudTrailArn:
    Description: 'CloudTrail ARN'
    Condition: EnableCloudTrailCondition
    Value: !GetAtt CloudTrail.Arn
    Export:
      Name: !Sub '${AWS::StackName}-CloudTrail'

  CloudTrailBucketName:
    Description: 'CloudTrail S3 Bucket Name'
    Condition: EnableCloudTrailCondition
    Value: !Ref CloudTrailBucket
    Export:
      Name: !Sub '${AWS::StackName}-CloudTrailBucket'
