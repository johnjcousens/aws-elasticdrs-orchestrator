AWSTemplateFormatVersion: '2010-09-09'
Description: 'AWS DRS Orchestration - Lambda Functions Nested Stack'

Parameters:
  ProjectName:
    Type: String
    Description: 'Project name for resource naming'

  Environment:
    Type: String
    Description: 'Environment name'

  SourceBucket:
    Type: String
    Description: 'S3 bucket containing Lambda deployment packages'

  ProtectionGroupsTableName:
    Type: String
    Description: 'DynamoDB table name for Protection Groups'

  RecoveryPlansTableName:
    Type: String
    Description: 'DynamoDB table name for Recovery Plans'

  ExecutionHistoryTableName:
    Type: String
    Description: 'DynamoDB table name for Execution History'

  FrontendBucketName:
    Type: String
    Default: ''
    Description: 'S3 bucket name for frontend hosting'

  CloudFrontDistributionId:
    Type: String
    Default: ''
    Description: 'CloudFront distribution ID'

  NotificationTopicArn:
    Type: String
    Description: 'SNS topic ARN for notifications'
    Default: ''

Conditions:
  HasNotificationTopic: !Not [!Equals [!Ref NotificationTopicArn, '']]
  HasFrontendBucket: !Not [!Equals [!Ref FrontendBucketName, '']]

Resources:
  # IAM Role for API Handler Lambda
  ApiHandlerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !Sub 'arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ProtectionGroupsTableName}'
                  - !Sub 'arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${RecoveryPlansTableName}'
                  - !Sub 'arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}'
                  - !Sub 'arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}/index/*'
        - PolicyName: StepFunctionsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - states:StartExecution
                  - states:DescribeExecution
                  - states:ListExecutions
                Resource:
                  - !Sub 'arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${ProjectName}-orchestration-${Environment}'
                  - !Sub 'arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:execution:${ProjectName}-orchestration-${Environment}:*'
        - PolicyName: DRSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  # Core DRS Operations
                  - drs:DescribeSourceServers
                  - drs:DescribeRecoveryInstances
                  - drs:DescribeJobs
                  - drs:DescribeJobLogItems
                  - drs:DescribeRecoverySnapshots
                  - drs:DescribeReplicationConfigurationTemplates
                  - drs:DescribeLaunchConfigurationTemplates
                  # Recovery Operations
                  - drs:StartRecovery
                  - drs:TerminateRecoveryInstances
                  - drs:DisconnectRecoveryInstance
                  - drs:ReverseReplication
                  - drs:StartFailback
                  - drs:StopFailback
                  # Replication Management
                  - drs:StartReplication
                  - drs:StopReplication
                  - drs:PauseReplication
                  - drs:ResumeReplication
                  - drs:RetryDataReplication
                  # Configuration Management
                  - drs:GetReplicationConfiguration
                  - drs:UpdateReplicationConfiguration
                  - drs:GetLaunchConfiguration
                  - drs:UpdateLaunchConfiguration
                  - drs:CreateReplicationConfigurationTemplate
                  - drs:UpdateReplicationConfigurationTemplate
                  - drs:DeleteReplicationConfigurationTemplate
                  - drs:CreateLaunchConfigurationTemplate
                  - drs:UpdateLaunchConfigurationTemplate
                  - drs:DeleteLaunchConfigurationTemplate
                  # Source Server Management
                  - drs:CreateSourceServer
                  - drs:DeleteSourceServer
                  - drs:MarkAsArchived
                  - drs:UntagResource
                  - drs:TagResource
                  - drs:ListTagsForResource
                  # Extended Recovery Operations
                  - drs:CreateExtendedSourceServer
                  - drs:DeleteJob
                  - drs:GetFailbackReplicationConfiguration
                  - drs:UpdateFailbackReplicationConfiguration
                  # Service Management
                  - drs:InitializeService
                  - drs:GetReplicationConfiguration
                  - drs:DescribeSourceNetworks
                  - drs:CreateSourceNetwork
                  - drs:DeleteSourceNetwork
                  - drs:UpdateSourceNetwork
                Resource: '*'
              - Effect: Allow
                Action:
                  - ec2:DescribeInstances
                  - ec2:DescribeInstanceStatus
                  - ec2:TerminateInstances
                Resource: '*'
              # EC2 permissions for DRS instance launching during conversion
              - Effect: Allow
                Action:
                  - ec2:RunInstances
                  - ec2:CreateVolume
                  - ec2:AttachVolume
                  - ec2:CreateTags
                  - ec2:CreateNetworkInterface
                  - ec2:AttachNetworkInterface
                  - ec2:DescribeVolumes
                  - ec2:DescribeSnapshots
                  - ec2:ModifyInstanceAttribute
                  - ec2:DescribeImages
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeSubnets
                  - ec2:DescribeVpcs
                  - iam:PassRole
                Resource: '*'
              # EC2 Snapshot/AMI permissions for drill conversion (no condition - DRS needs full access)
              - Effect: Allow
                Action:
                  - ec2:CreateSnapshot
                  - ec2:DeleteSnapshot
                  - ec2:CreateImage
                  - ec2:DeregisterImage
                  - ec2:CopyImage
                  - ec2:RegisterImage
                Resource: '*'
        - PolicyName: LambdaInvokeAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: !Sub 'arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${ProjectName}-api-handler-${Environment}'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for Orchestration Lambda
  OrchestrationRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                Resource:
                  - !Sub 'arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ProtectionGroupsTableName}'
                  - !Sub 'arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${RecoveryPlansTableName}'
                  - !Sub 'arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}'
                  - !Sub 'arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}/index/*'
        - PolicyName: DRSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  # Core DRS Operations
                  - drs:DescribeSourceServers
                  - drs:DescribeRecoveryInstances
                  - drs:DescribeJobs
                  - drs:DescribeJobLogItems
                  - drs:DescribeRecoverySnapshots
                  - drs:DescribeReplicationConfigurationTemplates
                  - drs:DescribeLaunchConfigurationTemplates
                  # Recovery Operations
                  - drs:StartRecovery
                  - drs:TerminateRecoveryInstances
                  - drs:DisconnectRecoveryInstance
                  - drs:ReverseReplication
                  - drs:StartFailback
                  - drs:StopFailback
                  # Replication Management
                  - drs:StartReplication
                  - drs:StopReplication
                  - drs:PauseReplication
                  - drs:ResumeReplication
                  - drs:RetryDataReplication
                  # Configuration Management
                  - drs:GetReplicationConfiguration
                  - drs:UpdateReplicationConfiguration
                  - drs:GetLaunchConfiguration
                  - drs:UpdateLaunchConfiguration
                  - drs:CreateReplicationConfigurationTemplate
                  - drs:UpdateReplicationConfigurationTemplate
                  - drs:DeleteReplicationConfigurationTemplate
                  - drs:CreateLaunchConfigurationTemplate
                  - drs:UpdateLaunchConfigurationTemplate
                  - drs:DeleteLaunchConfigurationTemplate
                  # Source Server Management
                  - drs:CreateSourceServer
                  - drs:DeleteSourceServer
                  - drs:MarkAsArchived
                  - drs:UntagResource
                  - drs:TagResource
                  - drs:ListTagsForResource
                  # Extended Recovery Operations
                  - drs:CreateExtendedSourceServer
                  - drs:DeleteJob
                  - drs:GetFailbackReplicationConfiguration
                  - drs:UpdateFailbackReplicationConfiguration
                  # Service Management
                  - drs:InitializeService
                  - drs:DescribeSourceNetworks
                  - drs:CreateSourceNetwork
                  - drs:DeleteSourceNetwork
                  - drs:UpdateSourceNetwork
                Resource: '*'
        - PolicyName: EC2Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ec2:DescribeInstances
                  - ec2:DescribeInstanceStatus
                  - ec2:DescribeTags
                  - ec2:TerminateInstances
                  - ec2:StopInstances
                  - ec2:CreateTags
                Resource: '*'
              - Effect: Allow
                Action:
                  - ec2:DeleteVolume
                Resource: '*'
                Condition:
                  StringEquals:
                    ec2:ResourceTag/AWSElasticDisasterRecoveryManaged: 'true'
              # EC2 permissions for DRS instance launching during conversion
              - Effect: Allow
                Action:
                  - ec2:RunInstances
                  - ec2:CreateVolume
                  - ec2:AttachVolume
                  - ec2:CreateNetworkInterface
                  - ec2:AttachNetworkInterface
                  - ec2:DescribeVolumes
                  - ec2:DescribeSnapshots
                  - ec2:ModifyInstanceAttribute
                  - ec2:DescribeImages
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeSubnets
                  - ec2:DescribeVpcs
                  - iam:PassRole
                Resource: '*'
              # EC2 Snapshot/AMI permissions for drill conversion (no condition - DRS needs full access)
              - Effect: Allow
                Action:
                  - ec2:CreateSnapshot
                  - ec2:DeleteSnapshot
                  - ec2:CreateImage
                  - ec2:DeregisterImage
                  - ec2:CopyImage
                  - ec2:RegisterImage
                Resource: '*'
              # CRITICAL: DRS uses Lambda credentials for DetachVolume during recovery launch
              # CloudTrail shows: invokedBy=drs.amazonaws.com, inScopeOf=Lambda function
              # Without this, DRS recovery fails with UnauthorizedOperation on DetachVolume
              - Effect: Allow
                Action:
                  - ec2:DetachVolume
                Resource: '*'
        - PolicyName: SSMAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ssm:StartAutomationExecution
                  - ssm:DescribeAutomationExecutions
                  - ssm:GetAutomationExecution
                  - ssm:StopAutomationExecution
                  - ssm:SendCommand
                  - ssm:GetCommandInvocation
                Resource: '*'
        - !If
          - HasNotificationTopic
          - PolicyName: SNSAccess
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - sns:Publish
                  Resource: !Ref NotificationTopicArn
          - !Ref 'AWS::NoValue'
        - PolicyName: STSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sts:AssumeRole
                Resource: 'arn:aws:iam::*:role/drs-orchestration-cross-account-role'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for Custom Resource Lambdas
  CustomResourceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:ListBucketVersions
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:DeleteObjectVersion
                Resource:
                  - !Sub 'arn:${AWS::Partition}:s3:::${ProjectName}-fe-${AWS::AccountId}-${Environment}'
                  - !Sub 'arn:${AWS::Partition}:s3:::${ProjectName}-fe-${AWS::AccountId}-${Environment}/*'
        - PolicyName: CloudFrontAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cloudfront:CreateInvalidation
                  - cloudfront:GetInvalidation
                Resource: !Sub 'arn:${AWS::Partition}:cloudfront::${AWS::AccountId}:distribution/*'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for Execution Finder Lambda
  ExecutionFinderRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBQueryAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !Sub 'arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}'
                  - !Sub 'arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}/index/StatusIndex'
        - PolicyName: LambdaInvokeAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: !GetAtt ExecutionPollerFunction.Arn
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for Execution Poller Lambda
  ExecutionPollerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                Resource:
                  - !Sub 'arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}'
        - PolicyName: DRSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  # Job Monitoring (Essential for Poller)
                  - drs:DescribeJobs
                  - drs:DescribeJobLogItems
                  # Recovery Instance Status
                  - drs:DescribeRecoveryInstances
                  # Source Server Status
                  - drs:DescribeSourceServers
                Resource: '*'
        - PolicyName: CloudWatchMetricsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: '*'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # API Handler Lambda Function
  ApiHandlerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-api-handler-${Environment}'
      Description: 'API Gateway handler for DRS Orchestration'
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !GetAtt ApiHandlerRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: 'lambda/api-handler.zip'
      Timeout: 120
      MemorySize: 512
      Environment:
        Variables:
          PROTECTION_GROUPS_TABLE: !Ref ProtectionGroupsTableName
          RECOVERY_PLANS_TABLE: !Ref RecoveryPlansTableName
          EXECUTION_HISTORY_TABLE: !Ref ExecutionHistoryTableName
          NOTIFICATION_TOPIC_ARN: !Ref NotificationTopicArn
          STATE_MACHINE_ARN: !Sub 'arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${ProjectName}-orchestration-${Environment}'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Orchestration Lambda Function
  OrchestrationFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-orchestration-${Environment}'
      Description: 'Step Functions orchestrator for DRS recovery execution'
      Runtime: python3.12
      Handler: drs_orchestrator.lambda_handler
      Role: !GetAtt OrchestrationRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: 'lambda/orchestration.zip'
      Timeout: 120
      MemorySize: 512
      Environment:
        Variables:
          PROTECTION_GROUPS_TABLE: !Ref ProtectionGroupsTableName
          RECOVERY_PLANS_TABLE: !Ref RecoveryPlansTableName
          EXECUTION_HISTORY_TABLE: !Ref ExecutionHistoryTableName
          NOTIFICATION_TOPIC_ARN: !Ref NotificationTopicArn
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Frontend Builder Custom Resource Lambda
  FrontendBuilderFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-frontend-builder-${Environment}'
      Description: 'Custom resource to build and deploy React frontend'
      Runtime: python3.12
      Handler: build_and_deploy.lambda_handler
      Role: !GetAtt CustomResourceRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: 'lambda/frontend-builder.zip'
      Timeout: 900
      MemorySize: 2048
      Environment:
        Variables:
          PROTECTION_GROUPS_TABLE: !Ref ProtectionGroupsTableName
          RECOVERY_PLANS_TABLE: !Ref RecoveryPlansTableName
          EXECUTION_HISTORY_TABLE: !Ref ExecutionHistoryTableName
          NOTIFICATION_TOPIC_ARN: !Ref NotificationTopicArn
          FRONTEND_BUCKET: !If [HasFrontendBucket, !Ref FrontendBucketName, !Ref 'AWS::NoValue']
          CLOUDFRONT_DISTRIBUTION_ID: !If [HasFrontendBucket, !Ref CloudFrontDistributionId, !Ref 'AWS::NoValue']
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Execution Finder Lambda Function
  ExecutionFinderFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-execution-finder-${Environment}'
      Description: 'Queries StatusIndex GSI for executions in POLLING status'
      Runtime: python3.12
      Handler: execution_finder.lambda_handler
      Role: !GetAtt ExecutionFinderRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: 'lambda/execution-finder.zip'
      Timeout: 60
      MemorySize: 256
      Environment:
        Variables:
          EXECUTION_HISTORY_TABLE: !Ref ExecutionHistoryTableName
          EXECUTION_POLLER_FUNCTION: !Sub '${ProjectName}-execution-poller-${Environment}'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Execution Poller Lambda Function
  ExecutionPollerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-execution-poller-${Environment}'
      Description: 'Polls DRS job status and updates execution wave states'
      Runtime: python3.12
      Handler: execution_poller.lambda_handler
      Role: !GetAtt ExecutionPollerRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: 'lambda/execution-poller.zip'
      Timeout: 120
      MemorySize: 256
      Environment:
        Variables:
          EXECUTION_HISTORY_TABLE: !Ref ExecutionHistoryTableName
          TIMEOUT_THRESHOLD_SECONDS: '1800'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # EventBridge Rule for Execution Finder (1 minute minimum)
  ExecutionFinderScheduleRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${ProjectName}-execution-finder-schedule-${Environment}'
      Description: 'Triggers Execution Finder Lambda every 1 minute'
      ScheduleExpression: 'rate(1 minute)'
      State: ENABLED
      Targets:
        - Arn: !GetAtt ExecutionFinderFunction.Arn
          Id: ExecutionFinderTarget

  # Permission for EventBridge to invoke Execution Finder
  ExecutionFinderSchedulePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ExecutionFinderFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt ExecutionFinderScheduleRule.Arn

  # Log Groups with retention
  ApiHandlerLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ApiHandlerFunction}'
      RetentionInDays: 30

  OrchestrationLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub '/aws/lambda/${OrchestrationFunction}'
      RetentionInDays: 30

  FrontendBuilderLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub '/aws/lambda/${FrontendBuilderFunction}'
      RetentionInDays: 7

  ExecutionFinderLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ExecutionFinderFunction}'
      RetentionInDays: 7

  ExecutionPollerLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ExecutionPollerFunction}'
      RetentionInDays: 7

  # Step Functions Orchestration Lambda Function
  OrchestrationStepFunctionsFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-orchestration-stepfunctions-${Environment}'
      Description: 'Step Functions orchestrator for DRS recovery - properly waits for EC2 launch'
      Runtime: python3.12
      Handler: orchestration_stepfunctions.handler
      Role: !GetAtt OrchestrationRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: 'lambda/orchestration-stepfunctions.zip'
      Timeout: 120
      MemorySize: 512
      Environment:
        Variables:
          PROTECTION_GROUPS_TABLE: !Ref ProtectionGroupsTableName
          RECOVERY_PLANS_TABLE: !Ref RecoveryPlansTableName
          EXECUTION_HISTORY_TABLE: !Ref ExecutionHistoryTableName
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  OrchestrationStepFunctionsLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub '/aws/lambda/${OrchestrationStepFunctionsFunction}'
      RetentionInDays: 30

Outputs:
  ApiHandlerFunctionArn:
    Description: 'API Handler Lambda Function ARN'
    Value: !GetAtt ApiHandlerFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ApiHandlerArn'

  ApiHandlerFunctionName:
    Description: 'API Handler Lambda Function Name'
    Value: !Ref ApiHandlerFunction
    Export:
      Name: !Sub '${AWS::StackName}-ApiHandlerName'

  OrchestrationFunctionArn:
    Description: 'Orchestration Lambda Function ARN'
    Value: !GetAtt OrchestrationFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-OrchestrationArn'

  OrchestrationFunctionName:
    Description: 'Orchestration Lambda Function Name'
    Value: !Ref OrchestrationFunction
    Export:
      Name: !Sub '${AWS::StackName}-OrchestrationName'

  OrchestrationStepFunctionsFunctionArn:
    Description: 'Step Functions Orchestration Lambda Function ARN'
    Value: !GetAtt OrchestrationStepFunctionsFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-OrchestrationStepFunctionsArn'

  OrchestrationStepFunctionsFunctionName:
    Description: 'Step Functions Orchestration Lambda Function Name'
    Value: !Ref OrchestrationStepFunctionsFunction
    Export:
      Name: !Sub '${AWS::StackName}-OrchestrationStepFunctionsName'

  FrontendBuilderFunctionArn:
    Description: 'Frontend Builder Lambda Function ARN'
    Value: !GetAtt FrontendBuilderFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-FrontendBuilderArn'

  ExecutionFinderFunctionArn:
    Description: 'Execution Finder Lambda Function ARN'
    Value: !GetAtt ExecutionFinderFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ExecutionFinderArn'

  ExecutionFinderFunctionName:
    Description: 'Execution Finder Lambda Function Name'
    Value: !Ref ExecutionFinderFunction
    Export:
      Name: !Sub '${AWS::StackName}-ExecutionFinderName'

  ExecutionPollerFunctionArn:
    Description: 'Execution Poller Lambda Function ARN'
    Value: !GetAtt ExecutionPollerFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ExecutionPollerArn'

  ExecutionPollerFunctionName:
    Description: 'Execution Poller Lambda Function Name'
    Value: !Ref ExecutionPollerFunction
    Export:
      Name: !Sub '${AWS::StackName}-ExecutionPollerName'

  ExecutionFinderScheduleRuleArn:
    Description: 'EventBridge Schedule Rule ARN'
    Value: !GetAtt ExecutionFinderScheduleRule.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ScheduleRuleArn'
