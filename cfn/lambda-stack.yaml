AWSTemplateFormatVersion: "2010-09-09"
Description: "AWS DRS Orchestration - Lambda Functions Nested Stack"

Parameters:
  ProjectName:
    Type: String
    Description: "Project name for resource naming"

  Environment:
    Type: String
    Description: "Environment name"

  SourceBucket:
    Type: String
    Description: "S3 bucket containing Lambda deployment packages"

  ProtectionGroupsTableName:
    Type: String
    Description: "DynamoDB table name for Protection Groups"

  RecoveryPlansTableName:
    Type: String
    Description: "DynamoDB table name for Recovery Plans"

  ExecutionHistoryTableName:
    Type: String
    Description: "DynamoDB table name for Execution History"

  TargetAccountsTableName:
    Type: String
    Description: "DynamoDB table name for Target Accounts"

  FrontendBucketName:
    Type: String
    Default: ""
    Description: "S3 bucket name for frontend hosting"

  CloudFrontDistributionId:
    Type: String
    Default: ""
    Description: "CloudFront distribution ID"

  NotificationTopicArn:
    Type: String
    Description: "SNS topic ARN for notifications"
    Default: ""

  AdminEmail:
    Type: String
    Description: "Admin email address for pipeline notifications"
    Default: ""

  EnablePipelineNotifications:
    Type: String
    Description: "Enable SNS email notifications for pipeline and security scan failures"
    Default: "false"
    AllowedValues:
      - "true"
      - "false"

  CrossAccountRoleName:
    Type: String
    Default: "drs-orchestration-cross-account-role"
    Description: "Name of the cross-account IAM role for DRS operations"

  ExecutionNotificationsTopicArn:
    Type: String
    Default: ""
    Description: "SNS topic ARN for execution notifications"

  DRSAlertsTopicArn:
    Type: String
    Default: ""
    Description: "SNS topic ARN for DRS operational alerts"

  ApprovalWorkflowTopicArn:
    Type: String
    Default: ""
    Description: "SNS topic ARN for approval workflow notifications"

Conditions:
  HasNotificationTopic: !Not [!Equals [!Ref NotificationTopicArn, ""]]
  HasFrontendBucket: !Not [!Equals [!Ref FrontendBucketName, ""]]
  EnableNotifications: !Equals [!Ref EnablePipelineNotifications, "true"]

Resources:
  # SNS Topic for Pipeline Notifications (Conditional)
  PipelineNotificationsTopic:
    Type: AWS::SNS::Topic
    Condition: EnableNotifications
    Properties:
      TopicName: !Sub '${ProjectName}-pipeline-notifications-${Environment}'
      DisplayName: 'CodePipeline and Security Scan Notifications'
      
  PipelineNotificationsSubscription:
    Type: AWS::SNS::Subscription
    Condition: EnableNotifications
    Properties:
      Protocol: email
      TopicArn: !Ref PipelineNotificationsTopic
      Endpoint: !Ref AdminEmail

  # SNS Topic Policy to allow EventBridge to publish (Conditional)
  PipelineNotificationsTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Condition: EnableNotifications
    Properties:
      Topics:
        - !Ref PipelineNotificationsTopic
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sns:Publish
            Resource: !Ref PipelineNotificationsTopic
  # IAM Role for API Handler Lambda
  ApiHandlerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                  - dynamodb:BatchGetItem
                Resource:
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ProtectionGroupsTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${RecoveryPlansTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}/index/*"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TargetAccountsTableName}"
        - PolicyName: StepFunctionsAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - states:StartExecution
                  - states:DescribeExecution
                  - states:ListExecutions
                  - states:SendTaskSuccess
                  - states:SendTaskFailure
                Resource:
                  - !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${ProjectName}-orchestration-${Environment}"
                  - !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:execution:${ProjectName}-orchestration-${Environment}:*"
                  - !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${ProjectName}-state-machine-${Environment}"
                  - !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:execution:${ProjectName}-state-machine-${Environment}:*"
        - PolicyName: DRSAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # Core DRS read operations (required for all DRS functionality)
              - Effect: Allow
                Action:
                  # Describe operations
                  - drs:DescribeSourceServers
                  - drs:DescribeRecoveryInstances
                  - drs:DescribeJobs
                  - drs:DescribeJobLogItems
                  - drs:DescribeRecoverySnapshots
                  - drs:DescribeReplicationConfigurationTemplates
                  - drs:DescribeLaunchConfigurationTemplates
                  - drs:DescribeSourceNetworks
                  # Get operations
                  - drs:GetReplicationConfiguration
                  - drs:GetLaunchConfiguration
                  - drs:GetFailbackReplicationConfiguration
                  # List operations
                  - drs:ListTagsForResource
                  - drs:ListExtensibleSourceServers
                  - drs:ListLaunchActions
                  - drs:ListStagingAccounts
                Resource: "*"
              # DRS Configuration Management (required for Protection Groups with launch settings)
              - Effect: Allow
                Action:
                  # Configuration updates
                  - drs:UpdateLaunchConfiguration
                  - drs:UpdateReplicationConfiguration
                  - drs:UpdateFailbackReplicationConfiguration
                  # Template management
                  - drs:CreateReplicationConfigurationTemplate
                  - drs:UpdateReplicationConfigurationTemplate
                  - drs:DeleteReplicationConfigurationTemplate
                  - drs:CreateLaunchConfigurationTemplate
                  - drs:UpdateLaunchConfigurationTemplate
                  - drs:DeleteLaunchConfigurationTemplate
                  # Launch actions management
                  - drs:PutLaunchAction
                  - drs:DeleteLaunchAction
                Resource: "*"
                # Restrict to DRS-supported regions for security
                Condition:
                  StringEquals:
                    "aws:RequestedRegion": 
                      - "us-east-1"
                      - "us-east-2"
                      - "us-west-1"
                      - "us-west-2"
                      - "ca-central-1"
                      - "sa-east-1"
                      - "eu-west-1"
                      - "eu-west-2"
                      - "eu-west-3"
                      - "eu-central-1"
                      - "eu-central-2"
                      - "eu-north-1"
                      - "eu-south-1"
                      - "eu-south-2"
                      - "ap-northeast-1"
                      - "ap-northeast-2"
                      - "ap-northeast-3"
                      - "ap-southeast-1"
                      - "ap-southeast-2"
                      - "ap-southeast-3"
                      - "ap-southeast-4"
                      - "ap-south-1"
                      - "ap-south-2"
                      - "ap-east-1"
                      - "me-south-1"
                      - "me-central-1"
                      - "af-south-1"
                      - "il-central-1"
              # DRS Recovery Operations (restricted to supported regions)
              - Effect: Allow
                Action:
                  # Recovery operations
                  - drs:StartRecovery
                  - drs:TerminateRecoveryInstances
                  - drs:DisconnectRecoveryInstance
                  - drs:DeleteRecoveryInstance
                  # Failback operations
                  - drs:ReverseReplication
                  - drs:StartFailbackLaunch
                  - drs:StopFailback
                  # Source network recovery
                  - drs:StartSourceNetworkRecovery
                Resource: "*"
                Condition:
                  StringEquals:
                    "aws:RequestedRegion": 
                      - "us-east-1"
                      - "us-east-2"
                      - "us-west-1"
                      - "us-west-2"
                      - "ca-central-1"
                      - "sa-east-1"
                      - "eu-west-1"
                      - "eu-west-2"
                      - "eu-west-3"
                      - "eu-central-1"
                      - "eu-central-2"
                      - "eu-north-1"
                      - "eu-south-1"
                      - "eu-south-2"
                      - "ap-northeast-1"
                      - "ap-northeast-2"
                      - "ap-northeast-3"
                      - "ap-southeast-1"
                      - "ap-southeast-2"
                      - "ap-southeast-3"
                      - "ap-southeast-4"
                      - "ap-south-1"
                      - "ap-south-2"
                      - "ap-east-1"
                      - "me-south-1"
                      - "me-central-1"
                      - "af-south-1"
                      - "il-central-1"
              # DRS Replication Management
              - Effect: Allow
                Action:
                  - drs:StartReplication
                  - drs:StopReplication
                  - drs:PauseReplication
                  - drs:ResumeReplication
                  - drs:RetryDataReplication
                  - drs:StartSourceNetworkReplication
                  - drs:StopSourceNetworkReplication
                  - drs:DisconnectSourceServer
                Resource: "*"
              # DRS Source Server Management
              - Effect: Allow
                Action:
                  - drs:CreateSourceServer
                  - drs:DeleteSourceServer
                  - drs:MarkAsArchived
                  - drs:CreateExtendedSourceServer
                Resource: "*"
              # DRS Service Management
              - Effect: Allow
                Action:
                  - drs:InitializeService
                  - drs:CreateSourceNetwork
                  - drs:DeleteSourceNetwork
                  - drs:UpdateSourceNetwork
                  - drs:DeleteJob
                  - drs:AssociateSourceNetworkStack
                  - drs:ExportSourceNetworkCfnTemplate
                  # CRITICAL: Required for DRS to register recovery instances
                  - drs:CreateRecoveryInstanceForDrs
                Resource: "*"
              # DRS Tag Management (restricted to DRS resources only)
              - Effect: Allow
                Action:
                  - drs:TagResource
                  - drs:UntagResource
                Resource: 
                  - "arn:aws:drs:*:*:source-server/*"
                  - "arn:aws:drs:*:*:recovery-instance/*"
                  - "arn:aws:drs:*:*:replication-configuration-template/*"
                  - "arn:aws:drs:*:*:launch-configuration-template/*"
        - PolicyName: EC2AccessForDRS
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # EC2 read operations (required for DRS and launch configuration management)
              - Effect: Allow
                Action:
                  - ec2:DescribeInstances
                  - ec2:DescribeInstanceStatus
                  - ec2:DescribeInstanceTypes
                  - ec2:DescribeInstanceTypeOfferings
                  - ec2:DescribeInstanceAttribute
                  - ec2:DescribeImages
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeSubnets
                  - ec2:DescribeVpcs
                  - ec2:DescribeAvailabilityZones
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DescribeVolumes
                  - ec2:DescribeSnapshots
                  - ec2:DescribeLaunchTemplates
                  - ec2:DescribeLaunchTemplateVersions
                  - ec2:DescribeAccountAttributes
                  - ec2:DescribeTags
                  - ec2:DescribeVolumeAttribute
                  - ec2:GetEbsDefaultKmsKeyId
                  - ec2:GetEbsEncryptionByDefault
                Resource: "*"
              # EC2 Launch Template Management (required for Protection Group launch settings)
              - Effect: Allow
                Action:
                  # Launch template operations (comprehensive set)
                  - ec2:CreateLaunchTemplate
                  - ec2:CreateLaunchTemplateVersion
                  - ec2:ModifyLaunchTemplate
                  - ec2:DeleteLaunchTemplate
                  - ec2:DeleteLaunchTemplateVersions
                  - ec2:DescribeLaunchTemplates
                  - ec2:DescribeLaunchTemplateVersions
                  - ec2:GetLaunchTemplateData
                Resource: "*"
              # EC2 Instance Operations (restricted to DRS-managed instances)
              - Effect: Allow
                Action:
                  - ec2:TerminateInstances
                  - ec2:StopInstances
                  - ec2:StartInstances
                  - ec2:ModifyInstanceAttribute
                Resource: "arn:aws:ec2:*:*:instance/*"
                Condition:
                  StringEquals:
                    "ec2:ResourceTag/AWSElasticDisasterRecoveryManaged": "true"
              # EC2 Resource Creation (required for DRS recovery operations)
              - Effect: Allow
                Action:
                  # Instance operations
                  - ec2:RunInstances
                  - ec2:ModifyInstanceAttribute
                  - ec2:ModifyInstancePlacement
                  - ec2:ModifyInstanceCreditSpecification
                  - ec2:ModifyInstanceCapacityReservationAttributes
                  - ec2:ModifyInstanceEventStartTime
                  - ec2:ModifyInstanceMetadataOptions
                  # Volume operations
                  - ec2:CreateVolume
                  - ec2:AttachVolume
                  - ec2:DetachVolume
                  - ec2:DeleteVolume
                  - ec2:ModifyVolume
                  - ec2:ModifyVolumeAttribute
                  # Network operations
                  - ec2:CreateNetworkInterface
                  - ec2:AttachNetworkInterface
                  - ec2:DetachNetworkInterface
                  - ec2:DeleteNetworkInterface
                  - ec2:ModifyNetworkInterfaceAttribute
                  - ec2:AssignPrivateIpAddresses
                  - ec2:UnassignPrivateIpAddresses
                  - ec2:AssignIpv6Addresses
                  - ec2:UnassignIpv6Addresses
                  # Security and tagging
                  - ec2:CreateTags
                  - ec2:DeleteTags
                  - ec2:CreateSecurityGroup
                  - ec2:AuthorizeSecurityGroupIngress
                  - ec2:AuthorizeSecurityGroupEgress
                  - ec2:RevokeSecurityGroupIngress
                  - ec2:RevokeSecurityGroupEgress
                  # Placement groups
                  - ec2:CreatePlacementGroup
                  - ec2:DeletePlacementGroup
                Resource: "*"
              # EC2 Snapshot/AMI Operations (required for DRS drill conversions)
              - Effect: Allow
                Action:
                  # Snapshot operations
                  - ec2:CreateSnapshot
                  - ec2:DeleteSnapshot
                  - ec2:CopySnapshot
                  - ec2:ModifySnapshotAttribute
                  - ec2:ResetSnapshotAttribute
                  - ec2:DescribeSnapshotAttribute
                  - ec2:DescribeSnapshotTierStatus
                  - ec2:ModifySnapshotTier
                  - ec2:RestoreSnapshotTier
                  # AMI operations
                  - ec2:CreateImage
                  - ec2:DeregisterImage
                  - ec2:CopyImage
                  - ec2:RegisterImage
                  - ec2:ModifyImageAttribute
                  - ec2:ResetImageAttribute
                  - ec2:DescribeImageAttribute
                  # Store operations
                  - ec2:CreateStoreImageTask
                  - ec2:DescribeStoreImageTasks
                Resource: "*"
        - PolicyName: IAMAccessForDRS
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # IAM read operations (required for instance profile validation)
              - Effect: Allow
                Action:
                  - iam:ListInstanceProfiles
                  - iam:ListAccountAliases
                  - iam:GetInstanceProfile
                Resource: "*"
              # IAM PassRole (restricted to DRS-related roles and EC2 instance profiles)
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: 
                  - "arn:aws:iam::*:role/EC2InstanceProfileForDRS*"
                  - "arn:aws:iam::*:role/*DRS*"
                  - "arn:aws:iam::*:role/*-drs-*"
                Condition:
                  StringEquals:
                    "iam:PassedToService": 
                      - "ec2.amazonaws.com"
                      - "drs.amazonaws.com"
        - PolicyName: STSAccessForCrossAccount
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # STS AssumeRole (restricted to cross-account DRS roles)
              - Effect: Allow
                Action:
                  - sts:AssumeRole
                Resource: !Sub "arn:aws:iam::*:role/${CrossAccountRoleName}"
                Condition:
                  StringEquals:
                    "sts:ExternalId": !Sub "${ProjectName}-${Environment}"
        - PolicyName: KMSAccessForDRS
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # KMS operations (required for encrypted EBS volumes and snapshots)
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                  - kms:GenerateDataKey
                  - kms:GenerateDataKeyWithoutPlaintext
                  - kms:ReEncrypt*
                  - kms:CreateGrant
                  - kms:ListGrants
                  - kms:RevokeGrant
                Resource: "*"
                Condition:
                  StringEquals:
                    "kms:ViaService": 
                      - "ec2.*.amazonaws.com"
                      - "drs.*.amazonaws.com"
        - PolicyName: CloudFormationAccessForDRS
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # CloudFormation operations (required for source network stack management)
              - Effect: Allow
                Action:
                  - cloudformation:CreateStack
                  - cloudformation:UpdateStack
                  - cloudformation:DeleteStack
                  - cloudformation:DescribeStacks
                  - cloudformation:DescribeStackEvents
                  - cloudformation:DescribeStackResources
                  - cloudformation:GetTemplate
                  - cloudformation:ValidateTemplate
                Resource: 
                  - !Sub "arn:aws:cloudformation:*:*:stack/drs-*/*"
                  - !Sub "arn:aws:cloudformation:*:*:stack/DRS-*/*"
        - PolicyName: LambdaInvokeAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${ProjectName}-api-handler-${Environment}"
        - PolicyName: EventBridgeAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - events:DescribeRule
                  - events:PutRule
                  - events:EnableRule
                  - events:DisableRule
                Resource: !Sub "arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:rule/${ProjectName}-tag-sync-schedule-${Environment}"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for Orchestration Lambda
  OrchestrationRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                Resource:
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ProtectionGroupsTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${RecoveryPlansTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}/index/*"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TargetAccountsTableName}"
        - PolicyName: DRSAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  # Core DRS Operations
                  - drs:DescribeSourceServers
                  - drs:DescribeRecoveryInstances
                  - drs:DescribeJobs
                  - drs:DescribeJobLogItems
                  - drs:DescribeRecoverySnapshots
                  - drs:DescribeReplicationConfigurationTemplates
                  - drs:DescribeLaunchConfigurationTemplates
                  # Recovery Operations
                  - drs:StartRecovery
                  - drs:TerminateRecoveryInstances
                  - drs:DisconnectRecoveryInstance
                  - drs:ReverseReplication
                  - drs:StartFailback
                  - drs:StopFailback
                  # Replication Management
                  - drs:StartReplication
                  - drs:StopReplication
                  - drs:PauseReplication
                  - drs:ResumeReplication
                  - drs:RetryDataReplication
                  # Configuration Management
                  - drs:GetReplicationConfiguration
                  - drs:UpdateReplicationConfiguration
                  - drs:GetLaunchConfiguration
                  - drs:UpdateLaunchConfiguration
                  - drs:CreateReplicationConfigurationTemplate
                  - drs:UpdateReplicationConfigurationTemplate
                  - drs:DeleteReplicationConfigurationTemplate
                  - drs:CreateLaunchConfigurationTemplate
                  - drs:UpdateLaunchConfigurationTemplate
                  - drs:DeleteLaunchConfigurationTemplate
                  # Source Server Management
                  - drs:CreateSourceServer
                  - drs:DeleteSourceServer
                  - drs:MarkAsArchived
                  - drs:UntagResource
                  - drs:TagResource
                  - drs:ListTagsForResource
                  # Extended Recovery Operations
                  - drs:CreateExtendedSourceServer
                  - drs:DeleteJob
                  - drs:GetFailbackReplicationConfiguration
                  - drs:UpdateFailbackReplicationConfiguration
                  # Service Management
                  - drs:InitializeService
                  - drs:DescribeSourceNetworks
                  - drs:CreateSourceNetwork
                  - drs:DeleteSourceNetwork
                  - drs:UpdateSourceNetwork
                  # CRITICAL: Required for DRS to register recovery instances
                  - drs:CreateRecoveryInstanceForDrs
                Resource: "*"
        - PolicyName: EC2Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  # Read permissions (DRS needs all of these)
                  - ec2:DescribeInstances
                  - ec2:DescribeInstanceStatus
                  - ec2:DescribeInstanceTypeOfferings
                  - ec2:DescribeInstanceTypes
                  - ec2:DescribeInstanceAttribute
                  - ec2:DescribeAccountAttributes
                  - ec2:DescribeTags
                  - ec2:DescribeLaunchTemplates
                  - ec2:DescribeLaunchTemplateVersions
                  - ec2:DescribeAvailabilityZones
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DescribeVolumeAttribute
                  - ec2:GetEbsDefaultKmsKeyId
                  - ec2:GetEbsEncryptionByDefault
                  # Instance operations
                  - ec2:TerminateInstances
                  - ec2:StopInstances
                  - ec2:StartInstances
                  - ec2:CreateTags
                  # CRITICAL: Launch template operations (DRS needs these when calling start_recovery)
                  - ec2:CreateLaunchTemplate
                  - ec2:CreateLaunchTemplateVersion
                  - ec2:ModifyLaunchTemplate
                  - ec2:DeleteLaunchTemplate
                  - ec2:DeleteLaunchTemplateVersions
                  # Volume operations (DRS needs for recovery)
                  - ec2:ModifyVolume
                  # Security group operations
                  - ec2:CreateSecurityGroup
                  # Network interface operations
                  - ec2:DeleteNetworkInterface
                  - ec2:ModifyNetworkInterfaceAttribute
                Resource: "*"
              # EC2 permissions for DRS instance launching during conversion
              - Effect: Allow
                Action:
                  - ec2:RunInstances
                  - ec2:CreateVolume
                  - ec2:AttachVolume
                  - ec2:CreateNetworkInterface
                  - ec2:AttachNetworkInterface
                  - ec2:DescribeVolumes
                  - ec2:DescribeSnapshots
                  - ec2:ModifyInstanceAttribute
                  - ec2:DescribeImages
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeSubnets
                  - ec2:DescribeVpcs
                  - ec2:DescribeInstanceTypes
                  - iam:PassRole
                  - iam:ListInstanceProfiles
                Resource: "*"
              # EC2 Snapshot/AMI permissions for drill conversion (no condition - DRS needs full access)
              - Effect: Allow
                Action:
                  - ec2:CreateSnapshot
                  - ec2:DeleteSnapshot
                  - ec2:CreateImage
                  - ec2:DeregisterImage
                  - ec2:CopyImage
                  - ec2:RegisterImage
                Resource: "*"
              # CRITICAL: DRS uses Lambda credentials for volume operations during recovery
              # CloudTrail shows: invokedBy=drs.amazonaws.com, inScopeOf=Lambda function
              # DRS staging volumes use tags: drs.amazonaws.com-job, drs.amazonaws.com-source-server
              # NOT AWSElasticDisasterRecoveryManaged (that's for replication volumes)
              # Without these permissions, DRS recovery fails during cleanup phase
              - Effect: Allow
                Action:
                  - ec2:DetachVolume
                  - ec2:DeleteVolume
                Resource: "*"
        - PolicyName: SSMAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ssm:StartAutomationExecution
                  - ssm:DescribeAutomationExecutions
                  - ssm:GetAutomationExecution
                  - ssm:StopAutomationExecution
                  - ssm:SendCommand
                  - ssm:GetCommandInvocation
                Resource: "*"
        - !If
          - EnableNotifications
          - PolicyName: SNSAccess
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - sns:Publish
                  Resource: !Ref PipelineNotificationsTopic
          - !Ref "AWS::NoValue"
        - PolicyName: SNSNotificationsAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sns:Publish
                Resource:
                  - !Sub "${ExecutionNotificationsTopicArn}"
                  - !Sub "${DRSAlertsTopicArn}"
        - PolicyName: STSAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sts:AssumeRole
                Resource: !Sub "arn:aws:iam::*:role/${CrossAccountRoleName}"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for Custom Resource Lambdas
  CustomResourceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:ListBucketVersions
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:DeleteObjectVersion
                Resource:
                  - !Sub "arn:${AWS::Partition}:s3:::${ProjectName}-fe-${AWS::AccountId}-${Environment}"
                  - !Sub "arn:${AWS::Partition}:s3:::${ProjectName}-fe-${AWS::AccountId}-${Environment}/*"
        - PolicyName: CloudFrontAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudfront:CreateInvalidation
                  - cloudfront:GetInvalidation
                Resource: !Sub "arn:${AWS::Partition}:cloudfront::${AWS::AccountId}:distribution/*"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for Bucket Cleaner Lambda
  BucketCleanerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: S3BucketCleanupAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:ListBucketVersions
                  - s3:GetBucketVersioning
                  - s3:DeleteObject
                  - s3:DeleteObjectVersion
                  - s3:GetObject
                  - s3:GetObjectVersion
                Resource:
                  - !Sub "arn:${AWS::Partition}:s3:::${ProjectName}-*-${AWS::AccountId}-${Environment}"
                  - !Sub "arn:${AWS::Partition}:s3:::${ProjectName}-*-${AWS::AccountId}-${Environment}/*"
              - Effect: Allow
                Action:
                  - s3:HeadBucket
                Resource: "*"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for Execution Finder Lambda
  ExecutionFinderRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBQueryAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}/index/StatusIndex"
        - PolicyName: LambdaInvokeAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: !GetAtt ExecutionPollerFunction.Arn
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for Execution Poller Lambda
  ExecutionPollerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                Resource:
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}"
        - PolicyName: DRSAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  # Job Monitoring (Essential for Poller)
                  - drs:DescribeJobs
                  - drs:DescribeJobLogItems
                  # Recovery Instance Status
                  - drs:DescribeRecoveryInstances
                  # Source Server Status
                  - drs:DescribeSourceServers
                Resource: "*"
        - PolicyName: CloudWatchMetricsAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: "*"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for Notification Formatter Lambda
  NotificationFormatterRole:
    Type: AWS::IAM::Role
    Condition: EnableNotifications
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: SNSPublishAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sns:Publish
                  - sns:ListTopics
                Resource: 
                  - !Ref PipelineNotificationsTopic
                  - !Sub "arn:${AWS::Partition}:sns:${AWS::Region}:${AWS::AccountId}:*"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # API Handler Lambda Function
  ApiHandlerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-api-handler-${Environment}"
      Description: "API Gateway handler for DRS Orchestration"
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !GetAtt ApiHandlerRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: "lambda/api-handler.zip"
      Timeout: 300  # Increased from 120 to 300 seconds to handle security processing overhead
      MemorySize: 512
      Environment:
        Variables:
          PROTECTION_GROUPS_TABLE: !Ref ProtectionGroupsTableName
          RECOVERY_PLANS_TABLE: !Ref RecoveryPlansTableName
          EXECUTION_HISTORY_TABLE: !Ref ExecutionHistoryTableName
          TARGET_ACCOUNTS_TABLE: !Ref TargetAccountsTableName
          NOTIFICATION_TOPIC_ARN: !If
            - EnableNotifications
            - !Ref PipelineNotificationsTopic
            - ""
          PROJECT_NAME: !Ref ProjectName
          ENVIRONMENT: !Ref Environment
          STATE_MACHINE_ARN: !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${ProjectName}-orchestration-${Environment}"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Frontend Builder Custom Resource Lambda
  FrontendBuilderFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-frontend-build-${Environment}"
      Description: "Custom resource to build and deploy React frontend"
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !GetAtt CustomResourceRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: "lambda/frontend-builder.zip"
      Timeout: 900
      MemorySize: 2048
      Environment:
        Variables:
          PROTECTION_GROUPS_TABLE: !Ref ProtectionGroupsTableName
          RECOVERY_PLANS_TABLE: !Ref RecoveryPlansTableName
          EXECUTION_HISTORY_TABLE: !Ref ExecutionHistoryTableName
          NOTIFICATION_TOPIC_ARN: !If
            - EnableNotifications
            - !Ref PipelineNotificationsTopic
            - ""
          FRONTEND_BUCKET:
            !If [
              HasFrontendBucket,
              !Ref FrontendBucketName,
              !Ref "AWS::NoValue",
            ]
          CLOUDFRONT_DISTRIBUTION_ID:
            !If [
              HasFrontendBucket,
              !Ref CloudFrontDistributionId,
              !Ref "AWS::NoValue",
            ]
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Bucket Cleaner Custom Resource Lambda
  BucketCleanerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-bucket-cleaner-${Environment}"
      Description: "Custom resource to empty S3 buckets before stack deletion"
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !GetAtt BucketCleanerRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: "lambda/bucket-cleaner.zip"
      Timeout: 300
      MemorySize: 512
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Execution Finder Lambda Function
  ExecutionFinderFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-execution-finder-${Environment}"
      Description: "Queries StatusIndex GSI for executions in POLLING status"
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !GetAtt ExecutionFinderRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: "lambda/execution-finder.zip"
      Timeout: 60
      MemorySize: 256
      Environment:
        Variables:
          EXECUTION_HISTORY_TABLE: !Ref ExecutionHistoryTableName
          EXECUTION_POLLER_FUNCTION: !Sub "${ProjectName}-execution-poller-${Environment}"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Execution Poller Lambda Function
  ExecutionPollerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-execution-poller-${Environment}"
      Description: "Polls DRS job status and updates execution wave states"
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !GetAtt ExecutionPollerRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: "lambda/execution-poller.zip"
      Timeout: 120
      MemorySize: 256
      Environment:
        Variables:
          EXECUTION_HISTORY_TABLE: !Ref ExecutionHistoryTableName
          TIMEOUT_THRESHOLD_SECONDS: "31536000"  # 1 year (365 * 24 * 60 * 60 seconds) - supports long-term pauses
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # EventBridge Rule for Execution Finder (1 minute minimum)
  ExecutionFinderScheduleRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub "${ProjectName}-execution-finder-schedule-${Environment}"
      Description: "Triggers Execution Finder Lambda every 1 minute"
      ScheduleExpression: "rate(1 minute)"
      State: ENABLED
      Targets:
        - Arn: !GetAtt ExecutionFinderFunction.Arn
          Id: ExecutionFinderTarget

  # Permission for EventBridge to invoke Execution Finder
  ExecutionFinderSchedulePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ExecutionFinderFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt ExecutionFinderScheduleRule.Arn

  # Note: CloudWatch Log Groups are automatically created by Lambda functions
  # Removed explicit log group creation to avoid conflicts

  # Step Functions Orchestration Lambda Function
  OrchestrationStepFunctionsFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-orch-sf-${Environment}"
      Description: "Step Functions orchestrator for DRS recovery - properly waits for EC2 launch"
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !GetAtt OrchestrationRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: "lambda/orchestration-stepfunctions.zip"
      Timeout: 120
      MemorySize: 512
      Environment:
        Variables:
          PROTECTION_GROUPS_TABLE: !Ref ProtectionGroupsTableName
          RECOVERY_PLANS_TABLE: !Ref RecoveryPlansTableName
          EXECUTION_HISTORY_TABLE: !Ref ExecutionHistoryTableName
          EXECUTION_NOTIFICATIONS_TOPIC_ARN: !Ref ExecutionNotificationsTopicArn
          DRS_ALERTS_TOPIC_ARN: !Ref DRSAlertsTopicArn
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Notification Formatter Lambda Function
  NotificationFormatterFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-notification-formatter-${Environment}"
      Description: "Formats DRS orchestration events into user-friendly notifications"
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !GetAtt NotificationFormatterRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: "lambda/notification-formatter.zip"
      Timeout: 60
      MemorySize: 256
      Environment:
        Variables:
          EXECUTION_NOTIFICATIONS_TOPIC_ARN: !Ref ExecutionNotificationsTopicArn
          DRS_ALERTS_TOPIC_ARN: !Ref DRSAlertsTopicArn
          APPROVAL_WORKFLOW_TOPIC_ARN: !Ref ApprovalWorkflowTopicArn
          PROJECT_NAME: !Ref ProjectName
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Note: CloudWatch Log Group automatically created by Lambda

Outputs:
  ApiHandlerFunctionArn:
    Description: "API Handler Lambda Function ARN"
    Value: !GetAtt ApiHandlerFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ApiHandlerArn"

  ApiHandlerFunctionName:
    Description: "API Handler Lambda Function Name"
    Value: !Ref ApiHandlerFunction
    Export:
      Name: !Sub "${AWS::StackName}-ApiHandlerName"

  OrchestrationStepFunctionsFunctionArn:
    Description: "Step Functions Orchestration Lambda Function ARN"
    Value: !GetAtt OrchestrationStepFunctionsFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-OrchestrationStepFunctionsArn"

  OrchestrationStepFunctionsFunctionName:
    Description: "Step Functions Orchestration Lambda Function Name"
    Value: !Ref OrchestrationStepFunctionsFunction
    Export:
      Name: !Sub "${AWS::StackName}-OrchestrationStepFunctionsName"

  FrontendBuilderFunctionArn:
    Description: "Frontend Builder Lambda Function ARN"
    Value: !GetAtt FrontendBuilderFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-FrontendBuilderArn"

  ExecutionFinderFunctionArn:
    Description: "Execution Finder Lambda Function ARN"
    Value: !GetAtt ExecutionFinderFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ExecutionFinderArn"

  ExecutionFinderFunctionName:
    Description: "Execution Finder Lambda Function Name"
    Value: !Ref ExecutionFinderFunction
    Export:
      Name: !Sub "${AWS::StackName}-ExecutionFinderName"

  ExecutionPollerFunctionArn:
    Description: "Execution Poller Lambda Function ARN"
    Value: !GetAtt ExecutionPollerFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ExecutionPollerArn"

  ExecutionPollerFunctionName:
    Description: "Execution Poller Lambda Function Name"
    Value: !Ref ExecutionPollerFunction
    Export:
      Name: !Sub "${AWS::StackName}-ExecutionPollerName"

  ExecutionFinderScheduleRuleArn:
    Description: "EventBridge Schedule Rule ARN"
    Value: !GetAtt ExecutionFinderScheduleRule.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ScheduleRuleArn"

  NotificationFormatterFunctionArn:
    Description: "Notification Formatter Lambda Function ARN"
    Value: !GetAtt NotificationFormatterFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-NotificationFormatterArn"

  NotificationFormatterFunctionName:
    Description: "Notification Formatter Lambda Function Name"
    Value: !Ref NotificationFormatterFunction
    Export:
      Name: !Sub "${AWS::StackName}-NotificationFormatterName"

  PipelineNotificationsTopicArn:
    Description: "Pipeline notifications SNS topic ARN"
    Condition: EnableNotifications
    Value: !Ref PipelineNotificationsTopic
    Export:
      Name: !Sub "${AWS::StackName}-PipelineNotificationsTopicArn"

  BucketCleanerFunctionArn:
    Description: "Bucket Cleaner Lambda Function ARN"
    Value: !GetAtt BucketCleanerFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-BucketCleanerArn"

  BucketCleanerFunctionName:
    Description: "Bucket Cleaner Lambda Function Name"
    Value: !Ref BucketCleanerFunction
    Export:
      Name: !Sub "${AWS::StackName}-BucketCleanerName"
