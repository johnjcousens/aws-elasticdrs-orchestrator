AWSTemplateFormatVersion: "2010-09-09"
Description: "AWS DRS Orchestration - Lambda Functions Nested Stack"

Parameters:
  ProjectName:
    Type: String
    Description: "Project name for resource naming"

  Environment:
    Type: String
    Description: "Environment name"

  SourceBucket:
    Type: String
    Description: "S3 bucket containing Lambda deployment packages"

  ProtectionGroupsTableName:
    Type: String
    Description: "DynamoDB table name for Protection Groups"

  RecoveryPlansTableName:
    Type: String
    Description: "DynamoDB table name for Recovery Plans"

  ExecutionHistoryTableName:
    Type: String
    Description: "DynamoDB table name for Execution History"

  TargetAccountsTableName:
    Type: String
    Description: "DynamoDB table name for Target Accounts"

  FrontendBucketName:
    Type: String
    Default: ""
    Description: "S3 bucket name for frontend hosting"

  CloudFrontDistributionId:
    Type: String
    Default: ""
    Description: "CloudFront distribution ID"

  NotificationTopicArn:
    Type: String
    Description: "SNS topic ARN for notifications"
    Default: ""

  AdminEmail:
    Type: String
    Description: "Admin email address for pipeline notifications"
    Default: ""

  EnablePipelineNotifications:
    Type: String
    Description: "Enable SNS email notifications for pipeline and security scan failures"
    Default: "false"
    AllowedValues:
      - "true"
      - "false"

  CrossAccountRoleName:
    Type: String
    Default: "drs-orchestration-cross-account-role"
    Description: "Name of the cross-account IAM role for DRS operations"

Conditions:
  HasNotificationTopic: !Not [!Equals [!Ref NotificationTopicArn, ""]]
  HasFrontendBucket: !Not [!Equals [!Ref FrontendBucketName, ""]]
  EnableNotifications: !Equals [!Ref EnablePipelineNotifications, "true"]

Resources:
  # SNS Topic for Pipeline Notifications (Conditional)
  PipelineNotificationsTopic:
    Type: AWS::SNS::Topic
    Condition: EnableNotifications
    Properties:
      TopicName: !Sub '${ProjectName}-pipeline-notifications-${Environment}'
      DisplayName: 'CodePipeline and Security Scan Notifications'
      
  PipelineNotificationsSubscription:
    Type: AWS::SNS::Subscription
    Condition: EnableNotifications
    Properties:
      Protocol: email
      TopicArn: !Ref PipelineNotificationsTopic
      Endpoint: !Ref AdminEmail

  # SNS Topic Policy to allow EventBridge to publish (Conditional)
  PipelineNotificationsTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Condition: EnableNotifications
    Properties:
      Topics:
        - !Ref PipelineNotificationsTopic
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sns:Publish
            Resource: !Ref PipelineNotificationsTopic
  # IAM Role for API Handler Lambda
  ApiHandlerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ProtectionGroupsTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${RecoveryPlansTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}/index/*"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TargetAccountsTableName}"
        - PolicyName: StepFunctionsAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - states:StartExecution
                  - states:DescribeExecution
                  - states:ListExecutions
                  - states:SendTaskSuccess
                  - states:SendTaskFailure
                Resource:
                  - !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${ProjectName}-orchestration-${Environment}"
                  - !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:execution:${ProjectName}-orchestration-${Environment}:*"
                  - !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${ProjectName}-state-machine-${Environment}"
                  - !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:execution:${ProjectName}-state-machine-${Environment}:*"
        - PolicyName: DRSAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # Read-only DRS operations (minimal required for API handler)
              - Effect: Allow
                Action:
                  - drs:DescribeSourceServers
                  - drs:DescribeRecoveryInstances
                  - drs:DescribeJobs
                  - drs:DescribeJobLogItems
                  - drs:DescribeRecoverySnapshots
                  - drs:DescribeReplicationConfigurationTemplates
                  - drs:DescribeLaunchConfigurationTemplates
                  - drs:GetReplicationConfiguration
                  - drs:GetLaunchConfiguration
                  - drs:ListTagsForResource
                Resource: "*"
              # Recovery operations (restricted to specific conditions)
              - Effect: Allow
                Action:
                  - drs:StartRecovery
                  - drs:TerminateRecoveryInstances
                Resource: "*"
                Condition:
                  StringEquals:
                    "aws:RequestedRegion": 
                      - "us-east-1"
                      - "us-west-2"
                      - "eu-west-1"
                      - "ap-southeast-2"
              # Tag management (restricted to DRS resources only)
              - Effect: Allow
                Action:
                  - drs:TagResource
                  - drs:UntagResource
                Resource: 
                  - "arn:aws:drs:*:*:source-server/*"
                  - "arn:aws:drs:*:*:recovery-instance/*"
              # EC2 permissions for DRS instance launching during conversion (restricted)
              - Effect: Allow
                Action:
                  - ec2:DescribeInstances
                  - ec2:DescribeInstanceStatus
                  - ec2:DescribeInstanceTypes
                  - ec2:DescribeImages
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeSubnets
                  - ec2:DescribeVpcs
                Resource: "*"
              # Instance termination (restricted to DRS-managed instances only)
              - Effect: Allow
                Action:
                  - ec2:TerminateInstances
                Resource: "arn:aws:ec2:*:*:instance/*"
                Condition:
                  StringEquals:
                    "ec2:ResourceTag/AWSElasticDisasterRecoveryManaged": "true"
              # Launch template operations (restricted to DRS templates)
              - Effect: Allow
                Action:
                  - ec2:CreateLaunchTemplateVersion
                  - ec2:ModifyLaunchTemplate
                  - ec2:DescribeLaunchTemplates
                  - ec2:DescribeLaunchTemplateVersions
                Resource: "*"
                Condition:
                  StringLike:
                    "ec2:ResourceTag/Name": "DRS-*"
              # IAM operations (restricted to DRS-related roles only)
              - Effect: Allow
                Action:
                  - iam:ListInstanceProfiles
                  - iam:ListAccountAliases
                Resource: "*"
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: "arn:aws:iam::*:role/EC2InstanceProfileForDRS*"
        - PolicyName: LambdaInvokeAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${ProjectName}-api-handler-${Environment}"
        - PolicyName: EventBridgeAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - events:DescribeRule
                  - events:PutRule
                  - events:EnableRule
                  - events:DisableRule
                Resource: !Sub "arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:rule/${ProjectName}-tag-sync-schedule-${Environment}"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for Orchestration Lambda
  OrchestrationRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                Resource:
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ProtectionGroupsTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${RecoveryPlansTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}/index/*"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TargetAccountsTableName}"
        - PolicyName: DRSAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  # Core DRS Operations
                  - drs:DescribeSourceServers
                  - drs:DescribeRecoveryInstances
                  - drs:DescribeJobs
                  - drs:DescribeJobLogItems
                  - drs:DescribeRecoverySnapshots
                  - drs:DescribeReplicationConfigurationTemplates
                  - drs:DescribeLaunchConfigurationTemplates
                  # Recovery Operations
                  - drs:StartRecovery
                  - drs:TerminateRecoveryInstances
                  - drs:DisconnectRecoveryInstance
                  - drs:ReverseReplication
                  - drs:StartFailback
                  - drs:StopFailback
                  # Replication Management
                  - drs:StartReplication
                  - drs:StopReplication
                  - drs:PauseReplication
                  - drs:ResumeReplication
                  - drs:RetryDataReplication
                  # Configuration Management
                  - drs:GetReplicationConfiguration
                  - drs:UpdateReplicationConfiguration
                  - drs:GetLaunchConfiguration
                  - drs:UpdateLaunchConfiguration
                  - drs:CreateReplicationConfigurationTemplate
                  - drs:UpdateReplicationConfigurationTemplate
                  - drs:DeleteReplicationConfigurationTemplate
                  - drs:CreateLaunchConfigurationTemplate
                  - drs:UpdateLaunchConfigurationTemplate
                  - drs:DeleteLaunchConfigurationTemplate
                  # Source Server Management
                  - drs:CreateSourceServer
                  - drs:DeleteSourceServer
                  - drs:MarkAsArchived
                  - drs:UntagResource
                  - drs:TagResource
                  - drs:ListTagsForResource
                  # Extended Recovery Operations
                  - drs:CreateExtendedSourceServer
                  - drs:DeleteJob
                  - drs:GetFailbackReplicationConfiguration
                  - drs:UpdateFailbackReplicationConfiguration
                  # Service Management
                  - drs:InitializeService
                  - drs:DescribeSourceNetworks
                  - drs:CreateSourceNetwork
                  - drs:DeleteSourceNetwork
                  - drs:UpdateSourceNetwork
                  # CRITICAL: Required for DRS to register recovery instances
                  - drs:CreateRecoveryInstanceForDrs
                Resource: "*"
        - PolicyName: EC2Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  # Read permissions (DRS needs all of these)
                  - ec2:DescribeInstances
                  - ec2:DescribeInstanceStatus
                  - ec2:DescribeInstanceTypeOfferings
                  - ec2:DescribeInstanceTypes
                  - ec2:DescribeInstanceAttribute
                  - ec2:DescribeAccountAttributes
                  - ec2:DescribeTags
                  - ec2:DescribeLaunchTemplates
                  - ec2:DescribeLaunchTemplateVersions
                  - ec2:DescribeAvailabilityZones
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DescribeVolumeAttribute
                  - ec2:GetEbsDefaultKmsKeyId
                  - ec2:GetEbsEncryptionByDefault
                  # Instance operations
                  - ec2:TerminateInstances
                  - ec2:StopInstances
                  - ec2:StartInstances
                  - ec2:CreateTags
                  # CRITICAL: Launch template operations (DRS needs these when calling start_recovery)
                  - ec2:CreateLaunchTemplate
                  - ec2:CreateLaunchTemplateVersion
                  - ec2:ModifyLaunchTemplate
                  - ec2:DeleteLaunchTemplate
                  - ec2:DeleteLaunchTemplateVersions
                  # Volume operations (DRS needs for recovery)
                  - ec2:ModifyVolume
                  # Security group operations
                  - ec2:CreateSecurityGroup
                  # Network interface operations
                  - ec2:DeleteNetworkInterface
                  - ec2:ModifyNetworkInterfaceAttribute
                Resource: "*"
              # EC2 permissions for DRS instance launching during conversion
              - Effect: Allow
                Action:
                  - ec2:RunInstances
                  - ec2:CreateVolume
                  - ec2:AttachVolume
                  - ec2:CreateNetworkInterface
                  - ec2:AttachNetworkInterface
                  - ec2:DescribeVolumes
                  - ec2:DescribeSnapshots
                  - ec2:ModifyInstanceAttribute
                  - ec2:DescribeImages
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeSubnets
                  - ec2:DescribeVpcs
                  - ec2:DescribeInstanceTypes
                  - iam:PassRole
                  - iam:ListInstanceProfiles
                Resource: "*"
              # EC2 Snapshot/AMI permissions for drill conversion (no condition - DRS needs full access)
              - Effect: Allow
                Action:
                  - ec2:CreateSnapshot
                  - ec2:DeleteSnapshot
                  - ec2:CreateImage
                  - ec2:DeregisterImage
                  - ec2:CopyImage
                  - ec2:RegisterImage
                Resource: "*"
              # CRITICAL: DRS uses Lambda credentials for volume operations during recovery
              # CloudTrail shows: invokedBy=drs.amazonaws.com, inScopeOf=Lambda function
              # DRS staging volumes use tags: drs.amazonaws.com-job, drs.amazonaws.com-source-server
              # NOT AWSElasticDisasterRecoveryManaged (that's for replication volumes)
              # Without these permissions, DRS recovery fails during cleanup phase
              - Effect: Allow
                Action:
                  - ec2:DetachVolume
                  - ec2:DeleteVolume
                Resource: "*"
        - PolicyName: SSMAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ssm:StartAutomationExecution
                  - ssm:DescribeAutomationExecutions
                  - ssm:GetAutomationExecution
                  - ssm:StopAutomationExecution
                  - ssm:SendCommand
                  - ssm:GetCommandInvocation
                Resource: "*"
        - !If
          - EnableNotifications
          - PolicyName: SNSAccess
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - sns:Publish
                  Resource: !Ref PipelineNotificationsTopic
          - !Ref "AWS::NoValue"
        - PolicyName: STSAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sts:AssumeRole
                Resource: !Sub "arn:aws:iam::*:role/${CrossAccountRoleName}"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for Custom Resource Lambdas
  CustomResourceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:ListBucketVersions
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:DeleteObjectVersion
                Resource:
                  - !Sub "arn:${AWS::Partition}:s3:::${ProjectName}-fe-${AWS::AccountId}-${Environment}"
                  - !Sub "arn:${AWS::Partition}:s3:::${ProjectName}-fe-${AWS::AccountId}-${Environment}/*"
        - PolicyName: CloudFrontAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudfront:CreateInvalidation
                  - cloudfront:GetInvalidation
                Resource: !Sub "arn:${AWS::Partition}:cloudfront::${AWS::AccountId}:distribution/*"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for Bucket Cleaner Lambda
  BucketCleanerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: S3BucketCleanupAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:ListBucketVersions
                  - s3:GetBucketVersioning
                  - s3:DeleteObject
                  - s3:DeleteObjectVersion
                  - s3:GetObject
                  - s3:GetObjectVersion
                Resource:
                  - !Sub "arn:${AWS::Partition}:s3:::${ProjectName}-*-${AWS::AccountId}-${Environment}"
                  - !Sub "arn:${AWS::Partition}:s3:::${ProjectName}-*-${AWS::AccountId}-${Environment}/*"
              - Effect: Allow
                Action:
                  - s3:HeadBucket
                Resource: "*"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for Execution Finder Lambda
  ExecutionFinderRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBQueryAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}/index/StatusIndex"
        - PolicyName: LambdaInvokeAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: !GetAtt ExecutionPollerFunction.Arn
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for Execution Poller Lambda
  ExecutionPollerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                Resource:
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ExecutionHistoryTableName}"
        - PolicyName: DRSAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  # Job Monitoring (Essential for Poller)
                  - drs:DescribeJobs
                  - drs:DescribeJobLogItems
                  # Recovery Instance Status
                  - drs:DescribeRecoveryInstances
                  # Source Server Status
                  - drs:DescribeSourceServers
                Resource: "*"
        - PolicyName: CloudWatchMetricsAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: "*"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for Notification Formatter Lambda
  NotificationFormatterRole:
    Type: AWS::IAM::Role
    Condition: EnableNotifications
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: SNSPublishAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sns:Publish
                  - sns:ListTopics
                Resource: 
                  - !Ref PipelineNotificationsTopic
                  - !Sub "arn:${AWS::Partition}:sns:${AWS::Region}:${AWS::AccountId}:*"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # API Handler Lambda Function
  ApiHandlerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-api-handler-${Environment}"
      Description: "API Gateway handler for DRS Orchestration"
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !GetAtt ApiHandlerRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: "lambda/api-handler.zip"
      Timeout: 120
      MemorySize: 512
      Environment:
        Variables:
          PROTECTION_GROUPS_TABLE: !Ref ProtectionGroupsTableName
          RECOVERY_PLANS_TABLE: !Ref RecoveryPlansTableName
          EXECUTION_HISTORY_TABLE: !Ref ExecutionHistoryTableName
          TARGET_ACCOUNTS_TABLE: !Ref TargetAccountsTableName
          NOTIFICATION_TOPIC_ARN: !If
            - EnableNotifications
            - !Ref PipelineNotificationsTopic
            - ""
          PROJECT_NAME: !Ref ProjectName
          ENVIRONMENT: !Ref Environment
          STATE_MACHINE_ARN: !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${ProjectName}-orchestration-${Environment}"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Frontend Builder Custom Resource Lambda
  FrontendBuilderFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-frontend-build-${Environment}"
      Description: "Custom resource to build and deploy React frontend"
      Runtime: python3.12
      Handler: build_and_deploy.lambda_handler
      Role: !GetAtt CustomResourceRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: "lambda/frontend-builder.zip"
      Timeout: 900
      MemorySize: 2048
      Environment:
        Variables:
          PROTECTION_GROUPS_TABLE: !Ref ProtectionGroupsTableName
          RECOVERY_PLANS_TABLE: !Ref RecoveryPlansTableName
          EXECUTION_HISTORY_TABLE: !Ref ExecutionHistoryTableName
          NOTIFICATION_TOPIC_ARN: !If
            - EnableNotifications
            - !Ref PipelineNotificationsTopic
            - ""
          FRONTEND_BUCKET:
            !If [
              HasFrontendBucket,
              !Ref FrontendBucketName,
              !Ref "AWS::NoValue",
            ]
          CLOUDFRONT_DISTRIBUTION_ID:
            !If [
              HasFrontendBucket,
              !Ref CloudFrontDistributionId,
              !Ref "AWS::NoValue",
            ]
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Bucket Cleaner Custom Resource Lambda
  BucketCleanerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-bucket-cleaner-${Environment}"
      Description: "Custom resource to empty S3 buckets before stack deletion"
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !GetAtt BucketCleanerRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: "lambda/bucket-cleaner.zip"
      Timeout: 300
      MemorySize: 512
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Execution Finder Lambda Function
  ExecutionFinderFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-execution-finder-${Environment}"
      Description: "Queries StatusIndex GSI for executions in POLLING status"
      Runtime: python3.12
      Handler: execution_finder.lambda_handler
      Role: !GetAtt ExecutionFinderRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: "lambda/execution-finder.zip"
      Timeout: 60
      MemorySize: 256
      Environment:
        Variables:
          EXECUTION_HISTORY_TABLE: !Ref ExecutionHistoryTableName
          EXECUTION_POLLER_FUNCTION: !Sub "${ProjectName}-execution-poller-${Environment}"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Execution Poller Lambda Function
  ExecutionPollerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-execution-poller-${Environment}"
      Description: "Polls DRS job status and updates execution wave states"
      Runtime: python3.12
      Handler: execution_poller.lambda_handler
      Role: !GetAtt ExecutionPollerRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: "lambda/execution-poller.zip"
      Timeout: 120
      MemorySize: 256
      Environment:
        Variables:
          EXECUTION_HISTORY_TABLE: !Ref ExecutionHistoryTableName
          TIMEOUT_THRESHOLD_SECONDS: "1800"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # EventBridge Rule for Execution Finder (1 minute minimum)
  ExecutionFinderScheduleRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub "${ProjectName}-execution-finder-schedule-${Environment}"
      Description: "Triggers Execution Finder Lambda every 1 minute"
      ScheduleExpression: "rate(1 minute)"
      State: ENABLED
      Targets:
        - Arn: !GetAtt ExecutionFinderFunction.Arn
          Id: ExecutionFinderTarget

  # Permission for EventBridge to invoke Execution Finder
  ExecutionFinderSchedulePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ExecutionFinderFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt ExecutionFinderScheduleRule.Arn

  # Note: CloudWatch Log Groups are automatically created by Lambda functions
  # Removed explicit log group creation to avoid conflicts

  # Step Functions Orchestration Lambda Function
  OrchestrationStepFunctionsFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-orch-sf-${Environment}"
      Description: "Step Functions orchestrator for DRS recovery - properly waits for EC2 launch"
      Runtime: python3.12
      Handler: orchestration_stepfunctions.handler
      Role: !GetAtt OrchestrationRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: "lambda/orchestration-stepfunctions.zip"
      Timeout: 120
      MemorySize: 512
      Environment:
        Variables:
          PROTECTION_GROUPS_TABLE: !Ref ProtectionGroupsTableName
          RECOVERY_PLANS_TABLE: !Ref RecoveryPlansTableName
          EXECUTION_HISTORY_TABLE: !Ref ExecutionHistoryTableName
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Notification Formatter Lambda Function
  NotificationFormatterFunction:
    Type: AWS::Lambda::Function
    Condition: EnableNotifications
    Properties:
      FunctionName: !Sub "${ProjectName}-notif-fmt-${Environment}"
      Description: "Formats CodePipeline and CodeBuild events into user-friendly email notifications"
      Runtime: python3.12
      Handler: notification-formatter/index.lambda_handler
      Role: !GetAtt NotificationFormatterRole.Arn
      Code:
        S3Bucket: !Ref SourceBucket
        S3Key: "lambda/notification-formatter.zip"
      Timeout: 60
      MemorySize: 256
      Environment:
        Variables:
          SNS_TOPIC_ARN: !Ref PipelineNotificationsTopic
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Note: CloudWatch Log Group automatically created by Lambda

Outputs:
  ApiHandlerFunctionArn:
    Description: "API Handler Lambda Function ARN"
    Value: !GetAtt ApiHandlerFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ApiHandlerArn"

  ApiHandlerFunctionName:
    Description: "API Handler Lambda Function Name"
    Value: !Ref ApiHandlerFunction
    Export:
      Name: !Sub "${AWS::StackName}-ApiHandlerName"

  OrchestrationStepFunctionsFunctionArn:
    Description: "Step Functions Orchestration Lambda Function ARN"
    Value: !GetAtt OrchestrationStepFunctionsFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-OrchestrationStepFunctionsArn"

  OrchestrationStepFunctionsFunctionName:
    Description: "Step Functions Orchestration Lambda Function Name"
    Value: !Ref OrchestrationStepFunctionsFunction
    Export:
      Name: !Sub "${AWS::StackName}-OrchestrationStepFunctionsName"

  FrontendBuilderFunctionArn:
    Description: "Frontend Builder Lambda Function ARN"
    Value: !GetAtt FrontendBuilderFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-FrontendBuilderArn"

  ExecutionFinderFunctionArn:
    Description: "Execution Finder Lambda Function ARN"
    Value: !GetAtt ExecutionFinderFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ExecutionFinderArn"

  ExecutionFinderFunctionName:
    Description: "Execution Finder Lambda Function Name"
    Value: !Ref ExecutionFinderFunction
    Export:
      Name: !Sub "${AWS::StackName}-ExecutionFinderName"

  ExecutionPollerFunctionArn:
    Description: "Execution Poller Lambda Function ARN"
    Value: !GetAtt ExecutionPollerFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ExecutionPollerArn"

  ExecutionPollerFunctionName:
    Description: "Execution Poller Lambda Function Name"
    Value: !Ref ExecutionPollerFunction
    Export:
      Name: !Sub "${AWS::StackName}-ExecutionPollerName"

  ExecutionFinderScheduleRuleArn:
    Description: "EventBridge Schedule Rule ARN"
    Value: !GetAtt ExecutionFinderScheduleRule.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ScheduleRuleArn"

  NotificationFormatterFunctionArn:
    Description: "Notification Formatter Lambda Function ARN"
    Condition: EnableNotifications
    Value: !GetAtt NotificationFormatterFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-NotificationFormatterArn"

  NotificationFormatterFunctionName:
    Description: "Notification Formatter Lambda Function Name"
    Condition: EnableNotifications
    Value: !Ref NotificationFormatterFunction
    Export:
      Name: !Sub "${AWS::StackName}-NotificationFormatterName"

  PipelineNotificationsTopicArn:
    Description: "Pipeline notifications SNS topic ARN"
    Condition: EnableNotifications
    Value: !Ref PipelineNotificationsTopic
    Export:
      Name: !Sub "${AWS::StackName}-PipelineNotificationsTopicArn"

  BucketCleanerFunctionArn:
    Description: "Bucket Cleaner Lambda Function ARN"
    Value: !GetAtt BucketCleanerFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-BucketCleanerArn"

  BucketCleanerFunctionName:
    Description: "Bucket Cleaner Lambda Function Name"
    Value: !Ref BucketCleanerFunction
    Export:
      Name: !Sub "${AWS::StackName}-BucketCleanerName"
