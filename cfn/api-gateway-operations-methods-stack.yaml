AWSTemplateFormatVersion: '2010-09-09'
Description: |
  API Gateway Operations Methods Stack - HTTP methods for execution management
  and DRS operations. Handles execution lifecycle (cancel, pause, resume),
  recovery instance monitoring, and DRS failover/failback operations.

# =============================================================================
# STACK OVERVIEW
# =============================================================================
# This stack defines HTTP methods for operational endpoints that manage
# DR execution lifecycle and DRS-specific operations.
#
# Endpoints Covered:
# - /executions/*           - Execution CRUD and lifecycle management
# - /drs/failover/*         - DRS failover operations
# - /drs/failback/*         - DRS failback operations
# - /drs/jobs/*             - DRS job monitoring
#
# Method Pattern:
# Each endpoint has two methods:
# 1. Business method (GET/POST/PUT/DELETE) - Cognito authenticated
# 2. OPTIONS method - CORS preflight (no auth)
#
# Integration:
# - All methods use AWS_PROXY integration with Lambda
# - Single Lambda handler (ExecutionHandler) routes by path/method
# - Request validation enabled for POST/PUT methods
#
# Authentication:
# - COGNITO_USER_POOLS authorizer for all business methods
# - OPTIONS methods have no auth (required for CORS preflight)
#
# CORS Configuration:
# - Access-Control-Allow-Origin: '*'
# - Access-Control-Allow-Headers: 'Content-Type,Authorization'
# - Access-Control-Allow-Methods: varies by endpoint

# =============================================================================
# PARAMETERS
# =============================================================================

Parameters:
  ProjectName:
    Type: String
    Description: Name of the project for resource naming
    Default: hrp-drs-tech-adapter

  Environment:
    Type: String
    Description: Environment name (dev, test, qa, uat, prod)
    AllowedValues: [dev, test, qa, uat, prod]
    Default: dev

  RestApiId:
    Type: String
    Description: REST API ID from Core Stack

  ApiAuthorizerId:
    Type: String
    Description: API Authorizer ID from Core Stack

  ApiRequestValidatorId:
    Type: String
    Description: API Request Validator ID from Core Stack

  ExecutionHandlerArn:
    Type: String
    Description: Execution Handler Function ARN from Lambda Stack

  # Execution Callback Resource ID from Resources Stack
  ExecutionCallbackResourceId:
    Type: String
    Description: Execution Callback Resource ID from Resources Stack

  # Execution Resource IDs from Resources Stack
  ExecutionsResourceId:
    Type: String
    Description: Executions Resource ID from Resources Stack

  ExecutionsDeleteResourceId:
    Type: String
    Description: Executions Delete Resource ID from Resources Stack

  ExecutionByIdResourceId:
    Type: String
    Description: Execution By ID Resource ID from Resources Stack

  ExecutionCancelResourceId:
    Type: String
    Description: Execution Cancel Resource ID from Resources Stack

  ExecutionPauseResourceId:
    Type: String
    Description: Execution Pause Resource ID from Resources Stack

  ExecutionResumeResourceId:
    Type: String
    Description: Execution Resume Resource ID from Resources Stack

  ExecutionTerminateResourceId:
    Type: String
    Description: Execution Terminate Resource ID from Resources Stack

  ExecutionRecoveryInstancesResourceId:
    Type: String
    Description: Execution Recovery Instances Resource ID from Resources Stack

  ExecutionJobLogsResourceId:
    Type: String
    Description: Execution Job Logs Resource ID from Resources Stack

  ExecutionTerminationStatusResourceId:
    Type: String
    Description: Execution Termination Status Resource ID from Resources Stack

  # DRS Failover/Failback Resource IDs from Resources Stack
  DrsFailoverResourceId:
    Type: String
    Description: DRS Failover Resource ID from Resources Stack

  DrsStartRecoveryResourceId:
    Type: String
    Description: DRS Start Recovery Resource ID from Resources Stack

  DrsTerminateRecoveryInstancesResourceId:
    Type: String
    Description: DRS Terminate Recovery Instances Resource ID from Resources Stack

  DrsDisconnectRecoveryInstanceResourceId:
    Type: String
    Description: DRS Disconnect Recovery Instance Resource ID from Resources Stack

  DrsFailbackResourceId:
    Type: String
    Description: DRS Failback Resource ID from Resources Stack

  DrsReverseReplicationResourceId:
    Type: String
    Description: DRS Reverse Replication Resource ID from Resources Stack

  DrsStartFailbackResourceId:
    Type: String
    Description: DRS Start Failback Resource ID from Resources Stack

  DrsStopFailbackResourceId:
    Type: String
    Description: DRS Stop Failback Resource ID from Resources Stack

  DrsFailbackConfigurationResourceId:
    Type: String
    Description: DRS Failback Configuration Resource ID from Resources Stack

  # DRS Job Management Resource IDs from Resources Stack
  DrsJobsResourceId:
    Type: String
    Description: DRS Jobs Resource ID from Resources Stack

  DrsJobByIdResourceId:
    Type: String
    Description: DRS Job By ID Resource ID from Resources Stack

  DrsJobLogsResourceId:
    Type: String
    Description: DRS Job Logs Resource ID from Resources Stack

# =============================================================================
# RESOURCES
# =============================================================================

Resources:
  # ===========================================================================
  # EXECUTION METHODS
  # ===========================================================================
  # /executions                - GET list, POST create, DELETE bulk
  # /executions/delete         - POST bulk delete (alternative to DELETE)
  # /executions/{id}           - GET single execution
  # /executions/{id}/cancel    - POST cancel execution
  # /executions/{id}/pause     - POST pause execution
  # /executions/{id}/resume    - POST resume execution
  # /executions/{id}/terminate-instances - POST terminate recovery instances
  # /executions/{id}/recovery-instances  - GET recovery instance status
  # /executions/{id}/job-logs            - GET DRS job logs
  # /executions/{id}/termination-status  - GET termination progress

  ExecutionsGetMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionsResourceId
      HttpMethod: GET
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref ApiAuthorizerId
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExecutionHandlerArn}/invocations'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionsPostMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionsResourceId
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref ApiAuthorizerId
      RequestValidatorId: !Ref ApiRequestValidatorId
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExecutionHandlerArn}/invocations'
      MethodResponses:
        - StatusCode: 201
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionsDeleteMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionsResourceId
      HttpMethod: DELETE
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref ApiAuthorizerId
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExecutionHandlerArn}/invocations'
      MethodResponses:
        - StatusCode: 204
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionsOptionsMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionsResourceId
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization'"
              method.response.header.Access-Control-Allow-Methods: "'GET,POST,DELETE,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionsDeletePostMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionsDeleteResourceId
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref ApiAuthorizerId
      RequestValidatorId: !Ref ApiRequestValidatorId
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExecutionHandlerArn}/invocations'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionsDeleteOptionsMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionsDeleteResourceId
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionGetMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionByIdResourceId
      HttpMethod: GET
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref ApiAuthorizerId
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExecutionHandlerArn}/invocations'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionOptionsMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionByIdResourceId
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization'"
              method.response.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionCancelMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionCancelResourceId
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref ApiAuthorizerId
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExecutionHandlerArn}/invocations'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionCancelOptionsMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionCancelResourceId
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionPauseMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionPauseResourceId
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref ApiAuthorizerId
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExecutionHandlerArn}/invocations'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionPauseOptionsMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionPauseResourceId
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionResumeMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionResumeResourceId
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref ApiAuthorizerId
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExecutionHandlerArn}/invocations'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionResumeOptionsMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionResumeResourceId
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionTerminateMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionTerminateResourceId
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref ApiAuthorizerId
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExecutionHandlerArn}/invocations'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionTerminateOptionsMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionTerminateResourceId
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionRecoveryInstancesMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    # Provides recovery instance details for active executions
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionRecoveryInstancesResourceId
      HttpMethod: GET
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref ApiAuthorizerId
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExecutionHandlerArn}/invocations'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionRecoveryInstancesOptionsMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    # CORS preflight support for recovery instances endpoint
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionRecoveryInstancesResourceId
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionJobLogsMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionJobLogsResourceId
      HttpMethod: GET
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref ApiAuthorizerId
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExecutionHandlerArn}/invocations'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionJobLogsOptionsMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionJobLogsResourceId
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionTerminationStatusMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionTerminationStatusResourceId
      HttpMethod: GET
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref ApiAuthorizerId
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExecutionHandlerArn}/invocations'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true

  ExecutionTerminationStatusOptionsMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionTerminationStatusResourceId
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  # ===========================================================================
  # DRS FAILOVER OPERATIONS
  # ===========================================================================
  # /drs/failover              - GET failover status
  # /drs/failover/start-recovery - POST initiate recovery
  # /drs/failover/terminate-instances - POST terminate recovery instances
  # /drs/failover/disconnect-instance - POST disconnect recovery instance

  DrsFailoverGetMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref DrsFailoverResourceId
      HttpMethod: GET
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref ApiAuthorizerId
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExecutionHandlerArn}/invocations'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true

  DrsFailoverOptionsMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref DrsFailoverResourceId
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization'"
              method.response.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  DrsStartRecoveryPostMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref DrsStartRecoveryResourceId
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref ApiAuthorizerId
      RequestValidatorId: !Ref ApiRequestValidatorId
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExecutionHandlerArn}/invocations'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true

  DrsStartRecoveryOptionsMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref DrsStartRecoveryResourceId
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  # ===========================================================================
  # DRS JOB MANAGEMENT
  # ===========================================================================
  # /drs/jobs        - GET list DRS jobs with optional filters
  # /drs/jobs/{id}   - GET job details
  # /drs/jobs/{id}/logs - GET job log items

  DrsJobsGetMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref DrsJobsResourceId
      HttpMethod: GET
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref ApiAuthorizerId
      RequestParameters:
        method.request.querystring.region: false
        method.request.querystring.jobType: false
        method.request.querystring.status: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExecutionHandlerArn}/invocations'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true

  DrsJobsOptionsMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref DrsJobsResourceId
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization'"
              method.response.header.Access-Control-Allow-Methods: "'GET,DELETE,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  # ===========================================================================
  # EXECUTION CALLBACK METHODS (UNAUTHENTICATED)
  # ===========================================================================
  # /execution-callback - GET callback for pause/resume from email links
  # No Cognito auth - task token serves as the credential
  # Query parameters: action (resume|cancel), taskToken (Step Functions token)

  ExecutionCallbackGetMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionCallbackResourceId
      HttpMethod: GET
      AuthorizationType: NONE
      RequestParameters:
        method.request.querystring.action: true
        method.request.querystring.taskToken: true
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExecutionHandlerArn}/invocations'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            text/html: Empty
        - StatusCode: 400
          ResponseModels:
            text/html: Empty
        - StatusCode: 500
          ResponseModels:
            text/html: Empty

  ExecutionCallbackOptionsMethod:
    Type: AWS::ApiGateway::Method
    DeletionPolicy: Delete
    Properties:
      RestApiId: !Ref RestApiId
      ResourceId: !Ref ExecutionCallbackResourceId
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Authorization'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  # ===========================================================================
  # LAMBDA PERMISSIONS
  # ===========================================================================
  # Grants API Gateway permission to invoke the Execution Handler Lambda.
  # Uses wildcard source ARN to allow all methods/stages.

  ExecutionHandlerApiPermission:
    Type: AWS::Lambda::Permission
    DeletionPolicy: Delete
    DeletionPolicy: Delete
    Properties:
      FunctionName: !Ref ExecutionHandlerArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApiId}/*'

# =============================================================================
# OUTPUTS
# =============================================================================

Outputs:
  OperationsMethodsStackStatus:
    Description: 'API Gateway Operations Methods Stack deployment status'
    Value: 'Operations methods deployed: Executions (18 methods) + DRS Failover/Failback (16 methods) + DRS Jobs (6 methods) + Execution Callback (2 methods) = 42 methods total'
    Export:
      Name: !Sub '${AWS::StackName}-OperationsMethodsStackStatus'
