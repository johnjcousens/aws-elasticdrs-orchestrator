AWSTemplateFormatVersion: '2010-09-09'
Description: |
  DR Orchestration Master Stack (AWSM-1103)
  
  Deploys complete wave-based disaster recovery orchestration solution via nested stacks:
  - Database: DynamoDB tables for Protection Groups, Recovery Plans, Execution History
  - Notification: SNS topics for execution events, DRS alerts, pause notifications
  - Lambda: 6 functions for API, orchestration, polling, notifications, frontend
  - Step Functions: Wave-based orchestration state machine with Archive Pattern
  - API Gateway: REST API with Cognito authentication (7 nested stacks)
  - EventBridge: DRS event routing and scheduled polling
  - Frontend: React UI hosted on S3/CloudFront (optional)
  
  Unified IAM Role: All Lambda functions share single orchestration role for DRS, DynamoDB,
  Step Functions, SNS, EC2, S3, CloudFront access. Supports cross-account DRS operations.
  
  Reference: docs/user-stories/AWSM-1088/AWSM-1103/IMPLEMTATION.md

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: 'General Configuration'
        Parameters:
          - ProjectName
          - Environment
          - SourceBucket
      - Label:
          default: 'Authentication Configuration'
        Parameters:
          - AdminEmail
          - EnableNotifications

Parameters:
  ProjectName:
    Type: String
    Default: 'aws-drs-orchestration'
    Description: 'Project name used for resource naming'
    AllowedPattern: '^[a-z0-9-]+$'
    ConstraintDescription: 'Must contain only lowercase letters, numbers, and hyphens'

  Environment:
    Type: String
    Default: 'dev'
    Description: 'Environment name (dev, test, prod)'
    AllowedValues:
      - dev
      - test
      - qa
      - uat
      - prod

  SourceBucket:
    Type: String
    Default: 'aws-elasticdrs-orchestrator'
    Description: 'S3 bucket containing nested CloudFormation templates and Lambda code at root level'

  AdminEmail:
    Type: String
    Description: 'Email address for initial Cognito admin user and all notifications'
    AllowedPattern: '^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$'
    ConstraintDescription: 'Must be a valid email address'

  EnableNotifications:
    Type: String
    Default: 'false'
    Description: 'Enable email notifications for execution events (true/false)'
    AllowedValues:
      - 'true'
      - 'false'

  # Deployment Flexibility Parameters
  OrchestrationRoleArn:
    Type: String
    Default: ''
    Description: >-
      Optional ARN of an existing orchestration role for all Lambda functions.
      If empty (default), the stack creates a unified role with all required permissions.
      If provided (e.g., from HRP), all Lambdas use that role instead.
    AllowedPattern: '^(arn:aws:iam::[0-9]{12}:role/.+)?$'
    ConstraintDescription: 'Must be a valid IAM role ARN or empty'

  DeployFrontend:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: >-
      Set to 'false' to skip frontend deployment (S3, CloudFront, frontend-builder).
      Use 'false' for API-only deployments or HRP integration.

  FrontendBuildVersion:
    Type: String
    Default: 'v1'
    Description: 'Frontend build version - auto-generated timestamp to trigger rebuilds'

  EnableTagSync:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: 'Enable scheduled DRS tag synchronization every 1 hour'

Conditions:
  CreateOrchestrationRole: !Equals [!Ref OrchestrationRoleArn, '']
  DeployFrontendCondition: !Equals [!Ref DeployFrontend, 'true']
  EnableNotificationsCondition: !Equals [!Ref EnableNotifications, 'true']
  EnableTagSyncCondition: !Equals [!Ref EnableTagSync, 'true']

Resources:
  # Unified Orchestration IAM Role
  # Created only when OrchestrationRoleArn parameter is empty
  # Consolidates permissions for all 6 Lambda functions (API, orchestration, polling, notifications, frontend)
  # Supports cross-account DRS operations via sts:AssumeRole
  UnifiedOrchestrationRole:
    Type: AWS::IAM::Role
    Condition: CreateOrchestrationRole
    Properties:
      RoleName: !Sub "${ProjectName}-orchestration-role-${Environment}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
                - states.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        # DynamoDB access for all Lambda functions
        # Tables: Protection Groups, Recovery Plans, Execution History, Target Accounts
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                  - dynamodb:BatchGetItem
                  - dynamodb:BatchWriteItem
                Resource:
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ProjectName}-*"
        
        # Step Functions access for API handler and orchestration
        # Includes SendTaskSuccess/SendTaskFailure for pause/resume callback pattern
        - PolicyName: StepFunctionsAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - states:StartExecution
                  - states:DescribeExecution
                  - states:ListExecutions
                  - states:SendTaskSuccess
                  - states:SendTaskFailure
                  - states:SendTaskHeartbeat
                Resource:
                  - !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${ProjectName}-*"
                  - !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:execution:${ProjectName}-*:*"
        
        # DRS read-only operations for status queries and configuration retrieval
        # Resource "*" required by DRS API design
        - PolicyName: DRSReadAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - drs:DescribeSourceServers
                  - drs:DescribeRecoverySnapshots
                  - drs:DescribeRecoveryInstances
                  - drs:DescribeJobs
                  - drs:DescribeJobLogItems
                  - drs:GetLaunchConfiguration
                  - drs:GetReplicationConfiguration
                  - drs:GetFailbackReplicationConfiguration
                  - drs:DescribeLaunchConfigurationTemplates
                  - drs:DescribeReplicationConfigurationTemplates
                  - drs:ListLaunchActions
                  - drs:ListTagsForResource
                  - drs:ListExtensibleSourceServers
                  - drs:ListStagingAccounts
                Resource: "*"
        
        # DRS write operations for recovery execution and configuration updates
        # Includes CreateRecoveryInstanceForDrs for AllowLaunchingIntoThisInstance pattern
        - PolicyName: DRSWriteAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - drs:StartRecovery
                  - drs:CreateRecoveryInstanceForDrs
                  - drs:TerminateRecoveryInstances
                  - drs:DisconnectRecoveryInstance
                  - drs:StartFailbackLaunch
                  - drs:StopFailback
                  - drs:ReverseReplication
                  - drs:UpdateLaunchConfiguration
                  - drs:UpdateReplicationConfiguration
                  - drs:UpdateFailbackReplicationConfiguration
                  - drs:PutLaunchAction
                  - drs:DeleteLaunchAction
                  - drs:TagResource
                  - drs:UntagResource
                  - drs:GetAgentInstallationAssetsForDrs
                  - drs:IssueAgentCertificateForDrs
                  - drs:CreateSourceServerForDrs
                Resource: "*"
        
        # EC2 access for instance queries and launch template management
        # Comprehensive permissions for all DRS operations including failover, failback, and agent installation
        # Based on AWS managed policy: AWSElasticDisasterRecoveryServiceRolePolicy
        - PolicyName: EC2Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  # Instance operations
                  - ec2:DescribeInstances
                  - ec2:DescribeInstanceStatus
                  - ec2:DescribeInstanceTypes
                  - ec2:DescribeInstanceAttribute
                  - ec2:DescribeInstanceTypeOfferings
                  - ec2:StartInstances
                  - ec2:StopInstances
                  - ec2:TerminateInstances
                  - ec2:ModifyInstanceAttribute
                  - ec2:GetConsoleOutput
                  - ec2:GetConsoleScreenshot
                  - ec2:RunInstances
                  # Volume operations
                  - ec2:DescribeVolumes
                  - ec2:DescribeVolumeAttribute
                  - ec2:CreateVolume
                  - ec2:DeleteVolume
                  - ec2:AttachVolume
                  - ec2:DetachVolume
                  - ec2:ModifyVolume
                  # Snapshot operations
                  - ec2:DescribeSnapshots
                  - ec2:CreateSnapshot
                  - ec2:DeleteSnapshot
                  # Image operations (required for DRS drill conversions)
                  - ec2:DescribeImages
                  - ec2:RegisterImage
                  - ec2:DeregisterImage
                  # Network operations
                  - ec2:DescribeSecurityGroups
                  - ec2:CreateSecurityGroup
                  - ec2:AuthorizeSecurityGroupIngress
                  - ec2:AuthorizeSecurityGroupEgress
                  - ec2:RevokeSecurityGroupEgress
                  - ec2:DescribeSubnets
                  - ec2:DescribeVpcs
                  - ec2:DescribeVpcAttribute
                  - ec2:DescribeNetworkInterfaces
                  - ec2:CreateNetworkInterface
                  - ec2:DeleteNetworkInterface
                  - ec2:ModifyNetworkInterfaceAttribute
                  - ec2:CreateNetworkInterfacePermission
                  # VPC networking (required for DRS source network recovery)
                  - ec2:DescribeInternetGateways
                  - ec2:DescribeNetworkAcls
                  - ec2:DescribeRouteTables
                  - ec2:DescribeDhcpOptions
                  - ec2:DescribeManagedPrefixLists
                  - ec2:GetManagedPrefixListEntries
                  - ec2:GetManagedPrefixListAssociations
                  # Availability and capacity
                  - ec2:DescribeAvailabilityZones
                  - ec2:DescribeAccountAttributes
                  - ec2:DescribeCapacityReservations
                  - ec2:DescribeHosts
                  - ec2:DescribeKeyPairs
                  # Encryption
                  - ec2:GetEbsEncryptionByDefault
                  - ec2:GetEbsDefaultKmsKeyId
                  # Tags
                  - ec2:CreateTags
                  - ec2:DeleteTags
                  - ec2:DescribeTags
                  # Launch templates (critical for DRS)
                  - ec2:CreateLaunchTemplate
                  - ec2:CreateLaunchTemplateVersion
                  - ec2:DescribeLaunchTemplates
                  - ec2:DescribeLaunchTemplateVersions
                  - ec2:ModifyLaunchTemplate
                  - ec2:DeleteLaunchTemplate
                  - ec2:DeleteLaunchTemplateVersions
                Resource: "*"
        
        # IAM PassRole for DRS and EC2 service principals
        # Required for DRS to launch EC2 instances with IAM instance profiles
        - PolicyName: IAMAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: "*"
                Condition:
                  StringEquals:
                    iam:PassedToService:
                      - drs.amazonaws.com
                      - ec2.amazonaws.com
              - Effect: Allow
                Action:
                  - iam:GetInstanceProfile
                  - iam:ListInstanceProfiles
                  - iam:ListRoles
                Resource: "*"
        
        # STS AssumeRole for cross-account DRS operations
        # Assumes standardized role (DRSOrchestrationRole) in workload accounts
        # Pattern: arn:aws:iam::{account-id}:role/DRSOrchestrationRole
        - PolicyName: STSAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sts:AssumeRole
                Resource:
                  # Standardized role name pattern (no environment suffix)
                  - !Sub "arn:${AWS::Partition}:iam::*:role/DRSOrchestrationRole"
        
        # KMS access for encrypted EBS volumes and DRS replication
        # Scoped to EC2 and DRS service usage only
        - PolicyName: KMSAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - kms:DescribeKey
                  - kms:ListAliases
                  - kms:CreateGrant
                Resource: "*"
                Condition:
                  StringEquals:
                    kms:ViaService:
                      - !Sub "ec2.${AWS::Region}.amazonaws.com"
                      - !Sub "drs.${AWS::Region}.amazonaws.com"
        
        # CloudFormation access for custom resource handlers
        # Used by frontend deployer for stack queries
        - PolicyName: CloudFormationAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudformation:DescribeStacks
                  - cloudformation:DescribeStackEvents
                  - cloudformation:DescribeStackResource
                  - cloudformation:DescribeStackResources
                  - cloudformation:ListStacks
                Resource: "*"
        
        # Policy 10: S3 Access (from CustomResource, BucketCleaner)
        - PolicyName: S3Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub "arn:${AWS::Partition}:s3:::${ProjectName}-*"
                  - !Sub "arn:${AWS::Partition}:s3:::${ProjectName}-*/*"
        
        # Policy 11: CloudFront Access (from CustomResource)
        - PolicyName: CloudFrontAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudfront:CreateInvalidation
                  - cloudfront:GetInvalidation
                  - cloudfront:ListInvalidations
                Resource: "*"
        
        # Policy 12: Lambda Invoke Access (from ApiHandler, ExecutionFinder)
        - PolicyName: LambdaInvokeAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${ProjectName}-*"
        
        # Policy 13: EventBridge Access (from ApiHandler)
        - PolicyName: EventBridgeAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - events:PutRule
                  - events:DeleteRule
                  - events:DescribeRule
                  - events:EnableRule
                  - events:DisableRule
                  - events:PutTargets
                  - events:RemoveTargets
                Resource:
                  - !Sub "arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:rule/${ProjectName}-*"
        
        # Policy 14: SSM Access (from Orchestration) - CRITICAL: includes ssm:CreateOpsItem
        - PolicyName: SSMAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ssm:DescribeDocument
                  - ssm:DescribeInstanceInformation
                  - ssm:SendCommand
                  - ssm:StartAutomationExecution
                  - ssm:ListDocuments
                  - ssm:ListCommandInvocations
                  - ssm:GetParameter
                  - ssm:PutParameter
                  - ssm:GetDocument
                  - ssm:GetAutomationExecution
                  - ssm:CreateOpsItem
                Resource: "*"
        
        # SNS publish for execution notifications and DRS alerts
        # Scoped to project-specific topics only
        - PolicyName: SNSAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sns:Publish
                Resource:
                  - !Sub "arn:${AWS::Partition}:sns:${AWS::Region}:${AWS::AccountId}:${ProjectName}-*"
        
        # CloudWatch metrics for execution monitoring
        # Used by execution poller for custom metrics and DRS for monitoring
        - PolicyName: CloudWatchAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                  - cloudwatch:GetMetricStatistics
                  - cloudwatch:GetMetricData
                Resource: "*"
        
        # License Manager access for DRS license configuration queries
        # Required for DRS console operations and license tracking
        - PolicyName: LicenseManagerAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - license-manager:ListLicenseConfigurations
                Resource: "*"
        
        # Resource Groups access for DRS resource organization
        # Required for DRS console operations and resource grouping
        - PolicyName: ResourceGroupsAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - resource-groups:ListGroups
                Resource: "*"
        
        # Elastic Load Balancing access for DRS load balancer queries
        # Required for DRS console operations and load balancer integration
        - PolicyName: ELBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - elasticloadbalancing:DescribeLoadBalancers
                Resource: "*"

  # DynamoDB tables for Protection Groups, Recovery Plans, Execution History, Target Accounts
  DatabaseStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${SourceBucket}/cfn/database-stack.yaml'
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: Migration
          Value: CamelCaseV2
      TimeoutInMinutes: 15

  # 6 Lambda functions: API handler, orchestration, polling, notifications, frontend deployer
  # All functions share unified OrchestrationRoleArn
  LambdaStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    DependsOn: 
      - DatabaseStack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${SourceBucket}/cfn/lambda-stack.yaml'
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        SourceBucket: !Ref SourceBucket
        OrchestrationRoleArn: !If
          - CreateOrchestrationRole
          - !GetAtt UnifiedOrchestrationRole.Arn
          - !Ref OrchestrationRoleArn
        ProtectionGroupsTableName: !GetAtt DatabaseStack.Outputs.ProtectionGroupsTableName
        RecoveryPlansTableName: !GetAtt DatabaseStack.Outputs.RecoveryPlansTableName
        ExecutionHistoryTableName: !GetAtt DatabaseStack.Outputs.ExecutionHistoryTableName
        TargetAccountsTableName: !GetAtt DatabaseStack.Outputs.TargetAccountsTableName
        ExecutionNotificationsTopicArn: !If
          - EnableNotificationsCondition
          - !GetAtt NotificationStack.Outputs.ExecutionNotificationsTopicArn
          - !Ref AWS::NoValue
        DRSAlertsTopicArn: !If
          - EnableNotificationsCondition
          - !GetAtt NotificationStack.Outputs.DRSOperationalAlertsTopicArn
          - !Ref AWS::NoValue
        ExecutionPauseTopicArn: !If
          - EnableNotificationsCondition
          - !GetAtt NotificationStack.Outputs.ExecutionPauseTopicArn
          - !Ref AWS::NoValue
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
      TimeoutInMinutes: 30

  # Wave-based orchestration state machine (AWSM-1103)
  # Implements Archive Pattern with pause/resume capability
  StepFunctionsStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    DependsOn:
      - DatabaseStack
      - LambdaStack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${SourceBucket}/cfn/step-functions-stack.yaml'
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        OrchestrationLambdaArn: !GetAtt LambdaStack.Outputs.OrchestrationStepFunctionsFunctionArn
        OrchestrationRoleArn: !If
          - CreateOrchestrationRole
          - !GetAtt UnifiedOrchestrationRole.Arn
          - !Ref OrchestrationRoleArn
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
      TimeoutInMinutes: 10

  # Cognito user pool and authorizer for API Gateway authentication
  ApiAuthStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    DependsOn:
      - DatabaseStack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${SourceBucket}/cfn/api-auth-stack.yaml'
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        AdminEmail: !Ref AdminEmail
        ExecutionHistoryTableArn: !GetAtt DatabaseStack.Outputs.ExecutionHistoryTableArn
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Notification Stack - SNS Topics and EventBridge Rules
  # Conditionally deployed based on EnableNotifications parameter
  NotificationStack:
    Type: AWS::CloudFormation::Stack
    Condition: EnableNotificationsCondition
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${SourceBucket}/cfn/notification-stack.yaml'
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        AdminEmail: !Ref AdminEmail
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
      TimeoutInMinutes: 15

  # Creates REST API foundation with Cognito authorizer and request validator
  # Provides base API Gateway infrastructure for all endpoint methods
  ApiGatewayCoreStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    DependsOn:
      - DatabaseStack
      - LambdaStack
      - ApiAuthStack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${SourceBucket}/cfn/api-gateway-core-stack.yaml'
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        UserPoolId: !GetAtt ApiAuthStack.Outputs.UserPoolId
        UserPoolClientId: !GetAtt ApiAuthStack.Outputs.UserPoolClientId
        ApiHandlerFunctionArn: !GetAtt LambdaStack.Outputs.ApiHandlerFunctionArn
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
      TimeoutInMinutes: 10

  # Defines all API Gateway resource paths for the REST API hierarchy
  # Creates URL structure for health, users, protection groups, recovery plans, executions, DRS operations, and infrastructure endpoints
  ApiGatewayResourcesStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    DependsOn:
      - ApiGatewayCoreStack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${SourceBucket}/cfn/api-gateway-resources-stack.yaml'
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        RestApiId: !GetAtt ApiGatewayCoreStack.Outputs.RestApiId
        RestApiRootResourceId: !GetAtt ApiGatewayCoreStack.Outputs.RestApiRootResourceId
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
      TimeoutInMinutes: 10

  # Implements HTTP methods for core API endpoints: health checks, user management, protection groups, and recovery plans
  # Connects API Gateway resources to Lambda handler with Cognito authorization and request validation
  ApiGatewayCoreMethodsStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    DependsOn:
      - ApiGatewayCoreStack
      - ApiGatewayResourcesStack
      - LambdaStack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${SourceBucket}/cfn/api-gateway-core-methods-stack.yaml'
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        RestApiId: !GetAtt ApiGatewayCoreStack.Outputs.RestApiId
        ApiAuthorizerId: !GetAtt ApiGatewayCoreStack.Outputs.ApiAuthorizerId
        ApiRequestValidatorId: !GetAtt ApiGatewayCoreStack.Outputs.ApiRequestValidatorId
        QueryHandlerArn: !GetAtt LambdaStack.Outputs.QueryHandlerFunctionArn
        DataManagementHandlerArn: !GetAtt LambdaStack.Outputs.DataManagementHandlerFunctionArn
        # Core Resource IDs from Resources Stack
        HealthResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.HealthResourceId
        UserProfileResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.UserProfileResourceId
        UserRolesResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.UserRolesResourceId
        UserPermissionsResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.UserPermissionsResourceId
        ProtectionGroupsResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.ProtectionGroupsResourceId
        ProtectionGroupByIdResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.ProtectionGroupResourceId
        ProtectionGroupResolveResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.ProtectionGroupResolveResourceId
        RecoveryPlansResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.RecoveryPlansResourceId
        RecoveryPlanByIdResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.RecoveryPlanResourceId
        RecoveryPlanExecuteResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.RecoveryPlanExecuteResourceId
        RecoveryPlanCheckInstancesResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.RecoveryPlanCheckExistingInstancesResourceId
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
      TimeoutInMinutes: 10

  # Implements HTTP methods for DR execution operations: list, get, cancel, pause, resume, terminate, and job log retrieval
  # Provides DRS-specific failover and failback endpoints for recovery instance management
  ApiGatewayOperationsMethodsStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    DependsOn:
      - ApiGatewayCoreStack
      - ApiGatewayResourcesStack
      - LambdaStack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${SourceBucket}/cfn/api-gateway-operations-methods-stack.yaml'
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        RestApiId: !GetAtt ApiGatewayCoreStack.Outputs.RestApiId
        ApiAuthorizerId: !GetAtt ApiGatewayCoreStack.Outputs.ApiAuthorizerId
        ApiRequestValidatorId: !GetAtt ApiGatewayCoreStack.Outputs.ApiRequestValidatorId
        ExecutionHandlerArn: !GetAtt LambdaStack.Outputs.ExecutionHandlerFunctionArn
        # Execution Resource IDs from Resources Stack
        ExecutionsResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.ExecutionsResourceId
        ExecutionsDeleteResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.ExecutionsDeleteResourceId
        ExecutionByIdResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.ExecutionResourceId
        ExecutionCancelResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.ExecutionCancelResourceId
        ExecutionPauseResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.ExecutionPauseResourceId
        ExecutionResumeResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.ExecutionResumeResourceId
        ExecutionTerminateResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.ExecutionTerminateInstancesResourceId
        ExecutionRecoveryInstancesResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.ExecutionRecoveryInstancesResourceId
        ExecutionJobLogsResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.ExecutionJobLogsResourceId
        ExecutionTerminationStatusResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.ExecutionTerminationStatusResourceId
        # DRS Failover/Failback Resource IDs from Resources Stack
        DrsFailoverResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSFailoverResourceId
        DrsStartRecoveryResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSStartRecoveryResourceId
        DrsTerminateRecoveryInstancesResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSTerminateRecoveryInstancesResourceId
        DrsDisconnectRecoveryInstanceResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSDisconnectRecoveryInstanceResourceId
        DrsFailbackResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSFailbackResourceId
        DrsReverseReplicationResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSReverseReplicationResourceId
        DrsStartFailbackResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSStartFailbackResourceId
        DrsStopFailbackResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSStopFailbackResourceId
        DrsFailbackConfigurationResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSFailbackConfigurationResourceId
        # DRS Job Management Resource IDs from Resources Stack
        DrsJobsResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSJobsResourceId
        DrsJobByIdResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSJobByIdResourceId
        DrsJobLogsResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSJobLogsResourceId
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
      TimeoutInMinutes: 10

  # Implements HTTP methods for infrastructure management: DRS source servers, EC2 resources, configuration import/export, and target account management
  # Provides comprehensive DRS infrastructure endpoints for replication, launch configuration, source networks, and recovery snapshots
  ApiGatewayInfrastructureMethodsStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    DependsOn:
      - ApiGatewayCoreStack
      - ApiGatewayResourcesStack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${SourceBucket}/cfn/api-gateway-infrastructure-methods-stack.yaml'
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        RestApiId: !GetAtt ApiGatewayCoreStack.Outputs.RestApiId
        ApiAuthorizerId: !GetAtt ApiGatewayCoreStack.Outputs.ApiAuthorizerId
        ApiRequestValidatorId: !GetAtt ApiGatewayCoreStack.Outputs.ApiRequestValidatorId
        ApiHandlerFunctionArn: !GetAtt LambdaStack.Outputs.ApiHandlerFunctionArn
        QueryHandlerArn: !GetAtt LambdaStack.Outputs.QueryHandlerFunctionArn
        # Infrastructure Resource IDs from Resources Stack
        DrsSourceServersResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSSourceServersResourceId
        DrsQuotasResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSQuotasResourceId
        DrsAccountsResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSAccountsResourceId
        DrsTagSyncResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSTagSyncResourceId
        Ec2SubnetsResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.EC2SubnetsResourceId
        Ec2SecurityGroupsResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.EC2SecurityGroupsResourceId
        Ec2InstanceProfilesResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.EC2InstanceProfilesResourceId
        Ec2InstanceTypesResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.EC2InstanceTypesResourceId
        ConfigExportResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.ConfigExportResourceId
        ConfigImportResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.ConfigImportResourceId
        ConfigTagSyncResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.ConfigTagSyncResourceId
        AccountsCurrentResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.AccountsCurrentResourceId
        AccountsTargetsResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.AccountsTargetsResourceId
        AccountsTargetByIdResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.AccountsTargetResourceId
        AccountsTargetValidateResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.AccountsTargetValidateResourceId
        StagingAccountsValidateResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.StagingAccountsValidateResourceId
        AccountsTargetStagingAccountsResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.AccountsTargetStagingAccountsResourceId
        AccountsTargetStagingAccountsDiscoverResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.AccountsTargetStagingAccountsDiscoverResourceId
        AccountsTargetStagingAccountResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.AccountsTargetStagingAccountResourceId
        AccountsTargetCapacityResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.AccountsTargetCapacityResourceId
        # Comprehensive DRS Infrastructure Resource IDs from Resources Stack
        DrsReplicationResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSReplicationResourceId
        DrsStartReplicationResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSStartReplicationResourceId
        DrsStopReplicationResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSStopReplicationResourceId
        DrsPauseReplicationResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSPauseReplicationResourceId
        DrsResumeReplicationResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSResumeReplicationResourceId
        DrsRetryDataReplicationResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSRetryDataReplicationResourceId
        DrsReplicationConfigurationResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSReplicationConfigurationResourceId
        DrsReplicationConfigurationTemplateResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSReplicationConfigurationTemplateResourceId
        DrsSourceServerResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSSourceServerResourceId
        DrsSourceServerByIdResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSSourceServerByIdResourceId
        DrsDisconnectSourceServerResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSDisconnectSourceServerResourceId
        DrsMarkAsArchivedResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSMarkAsArchivedResourceId
        DrsExtendedSourceServersResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSExtendedSourceServersResourceId
        DrsExtensibleSourceServersResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSExtensibleSourceServersResourceId
        DrsSourceNetworksResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSSourceNetworksResourceId
        DrsSourceNetworkByIdResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSSourceNetworkByIdResourceId
        DrsSourceNetworkRecoveryResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSSourceNetworkRecoveryResourceId
        DrsSourceNetworkReplicationResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSSourceNetworkReplicationResourceId
        DrsSourceNetworkStackResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSSourceNetworkStackResourceId
        DrsSourceNetworkTemplateResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSSourceNetworkTemplateResourceId
        DrsLaunchConfigurationResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSLaunchConfigurationResourceId
        DrsLaunchConfigurationTemplateResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSLaunchConfigurationTemplateResourceId
        DrsLaunchActionsResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSLaunchActionsResourceId
        DrsLaunchActionByIdResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSLaunchActionByIdResourceId
        DrsServiceResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSServiceResourceId
        DrsInitializeServiceResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSInitializeServiceResourceId
        DrsRecoveryInstancesResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSRecoveryInstancesResourceId
        DrsRecoveryInstanceByIdResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSRecoveryInstanceByIdResourceId
        DrsRecoverySnapshotsResourceId: !GetAtt ApiGatewayResourcesStack.Outputs.DRSRecoverySnapshotsResourceId
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
      TimeoutInMinutes: 10

  # Creates API Gateway deployment and stage to activate all configured methods
  # Depends on all method stacks to ensure complete API definition before deployment
  ApiGatewayDeploymentStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    DependsOn:
      - ApiGatewayCoreStack
      - ApiGatewayResourcesStack
      - ApiGatewayCoreMethodsStack
      - ApiGatewayOperationsMethodsStack
      - ApiGatewayInfrastructureMethodsStack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${SourceBucket}/cfn/api-gateway-deployment-stack.yaml'
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        RestApiId: !GetAtt ApiGatewayCoreStack.Outputs.RestApiId
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
      TimeoutInMinutes: 10

  # Configures EventBridge rules for automated DR operations: scheduled drills and DRS tag synchronization
  # Weekly drill schedule disabled by default to prevent unintended DR activations
  EventBridgeStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    DependsOn:
      - LambdaStack
      - StepFunctionsStack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${SourceBucket}/cfn/eventbridge-stack.yaml'
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        ModularOrchestratorArn: !GetAtt StepFunctionsStack.Outputs.StateMachineArn
        EnableWeeklyDrill: 'false'  # Disabled by default
        EnableTagSync: !Ref EnableTagSync
        ApiHandlerFunctionArn: !GetAtt LambdaStack.Outputs.ApiHandlerFunctionArn
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
      TimeoutInMinutes: 10

  # Deploys React frontend to S3 with CloudFront distribution for global content delivery
  # Injects runtime configuration (API endpoint, Cognito pools) during deployment via custom resource
  # 60-minute timeout accommodates frontend build, S3 sync, and CloudFront invalidation
  FrontendStack:
    Type: AWS::CloudFormation::Stack
    Condition: DeployFrontendCondition
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    DependsOn:
      - LambdaStack
      - ApiGatewayDeploymentStack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${SourceBucket}/cfn/frontend-stack.yaml'
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        UserPoolId: !GetAtt ApiAuthStack.Outputs.UserPoolId
        UserPoolClientId: !GetAtt ApiAuthStack.Outputs.UserPoolClientId
        IdentityPoolId: !GetAtt ApiAuthStack.Outputs.IdentityPoolId
        ApiEndpoint: !GetAtt ApiGatewayDeploymentStack.Outputs.ApiEndpoint
        FrontendDeployerFunctionArn: !GetAtt LambdaStack.Outputs.FrontendDeployerFunctionArn
        SourceBucket: !Ref SourceBucket
        FrontendBuildVersion: !Ref FrontendBuildVersion
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
      TimeoutInMinutes: 60

Outputs:
  # Database Stack Outputs
  ProtectionGroupsTableName:
    Description: 'DynamoDB table for Protection Groups'
    Value: !GetAtt DatabaseStack.Outputs.ProtectionGroupsTableName
    Export:
      Name: !Sub '${AWS::StackName}-ProtectionGroupsTable'

  RecoveryPlansTableName:
    Description: 'DynamoDB table for Recovery Plans'
    Value: !GetAtt DatabaseStack.Outputs.RecoveryPlansTableName
    Export:
      Name: !Sub '${AWS::StackName}-RecoveryPlansTable'

  ExecutionHistoryTableName:
    Description: 'DynamoDB table for Execution History'
    Value: !GetAtt DatabaseStack.Outputs.ExecutionHistoryTableName
    Export:
      Name: !Sub '${AWS::StackName}-ExecutionHistoryTable'

  ProtectionGroupsTableArn:
    Description: 'DynamoDB table ARN for Protection Groups'
    Value: !GetAtt DatabaseStack.Outputs.ProtectionGroupsTableArn
    Export:
      Name: !Sub '${AWS::StackName}-ProtectionGroupsTableArn'

  RecoveryPlansTableArn:
    Description: 'DynamoDB table ARN for Recovery Plans'
    Value: !GetAtt DatabaseStack.Outputs.RecoveryPlansTableArn
    Export:
      Name: !Sub '${AWS::StackName}-RecoveryPlansTableArn'

  ExecutionHistoryTableArn:
    Description: 'DynamoDB table ARN for Execution History'
    Value: !GetAtt DatabaseStack.Outputs.ExecutionHistoryTableArn
    Export:
      Name: !Sub '${AWS::StackName}-ExecutionHistoryTableArn'

  TargetAccountsTableName:
    Description: 'DynamoDB table for Target Accounts'
    Value: !GetAtt DatabaseStack.Outputs.TargetAccountsTableName
    Export:
      Name: !Sub '${AWS::StackName}-TargetAccountsTable'

  TargetAccountsTableArn:
    Description: 'DynamoDB table ARN for Target Accounts'
    Value: !GetAtt DatabaseStack.Outputs.TargetAccountsTableArn
    Export:
      Name: !Sub '${AWS::StackName}-TargetAccountsTableArn'

  # Lambda Stack Outputs
  DataManagementHandlerFunctionArn:
    Description: 'Data Management Handler Lambda Function ARN'
    Value: !GetAtt LambdaStack.Outputs.DataManagementHandlerFunctionArn
    Export:
      Name: !Sub '${AWS::StackName}-DataManagementHandlerArn'

  ExecutionHandlerFunctionArn:
    Description: 'Execution Handler Lambda Function ARN'
    Value: !GetAtt LambdaStack.Outputs.ExecutionHandlerFunctionArn
    Export:
      Name: !Sub '${AWS::StackName}-ExecutionHandlerArn'

  QueryHandlerFunctionArn:
    Description: 'Query Handler Lambda Function ARN'
    Value: !GetAtt LambdaStack.Outputs.QueryHandlerFunctionArn
    Export:
      Name: !Sub '${AWS::StackName}-QueryHandlerArn'

  OrchestrationFunctionArn:
    Description: 'Orchestration Lambda Function ARN'
    Value: !GetAtt LambdaStack.Outputs.OrchestrationStepFunctionsFunctionArn
    Export:
      Name: !Sub '${AWS::StackName}-OrchestrationArn'

  # API Stack Outputs
  UserPoolId:
    Description: 'Cognito User Pool ID'
    Value: !GetAtt ApiAuthStack.Outputs.UserPoolId
    Export:
      Name: !Sub '${AWS::StackName}-UserPoolId'

  UserPoolClientId:
    Description: 'Cognito User Pool Client ID'
    Value: !GetAtt ApiAuthStack.Outputs.UserPoolClientId
    Export:
      Name: !Sub '${AWS::StackName}-UserPoolClientId'

  IdentityPoolId:
    Description: 'Cognito Identity Pool ID'
    Value: !GetAtt ApiAuthStack.Outputs.IdentityPoolId
    Export:
      Name: !Sub '${AWS::StackName}-IdentityPoolId'

  ApiEndpoint:
    Description: 'API Gateway endpoint URL'
    Value: !GetAtt ApiGatewayDeploymentStack.Outputs.ApiEndpoint
    Export:
      Name: !Sub '${AWS::StackName}-ApiEndpoint'

  ApiId:
    Description: 'API Gateway ID'
    Value: !GetAtt ApiGatewayCoreStack.Outputs.RestApiId
    Export:
      Name: !Sub '${AWS::StackName}-ApiId'

  StateMachineArn:
    Description: 'Step Functions State Machine ARN'
    Value: !GetAtt StepFunctionsStack.Outputs.StateMachineArn
    Export:
      Name: !Sub '${AWS::StackName}-StateMachineArn'

  # EventBridge Stack Outputs
  EventBridgeRoleArn:
    Description: 'EventBridge invoke role ARN'
    Value: !GetAtt EventBridgeStack.Outputs.EventBridgeInvokeRoleArn
    Export:
      Name: !Sub '${AWS::StackName}-EventBridgeRoleArn'

  TagSyncScheduleRuleName:
    Description: 'Tag sync schedule rule name'
    Value: !GetAtt EventBridgeStack.Outputs.TagSyncScheduleRuleName
    Export:
      Name: !Sub '${AWS::StackName}-TagSyncScheduleRuleName'
    Condition: EnableTagSyncCondition

  TagSyncScheduleExpression:
    Description: 'Tag sync schedule expression'
    Value: !GetAtt EventBridgeStack.Outputs.TagSyncScheduleExpression
    Export:
      Name: !Sub '${AWS::StackName}-TagSyncScheduleExpression'
    Condition: EnableTagSyncCondition


  # Frontend Stack Outputs
  CloudFrontUrl:
    Condition: DeployFrontendCondition
    Description: 'CloudFront Distribution URL'
    Value: !GetAtt FrontendStack.Outputs.CloudFrontUrl
    Export:
      Name: !Sub '${AWS::StackName}-CloudFrontUrl'

  CloudFrontDistributionId:
    Condition: DeployFrontendCondition
    Description: 'CloudFront Distribution ID'
    Value: !GetAtt FrontendStack.Outputs.CloudFrontDistributionId
    Export:
      Name: !Sub '${AWS::StackName}-CloudFrontDistributionId'

  FrontendBucketName:
    Condition: DeployFrontendCondition
    Description: 'S3 bucket for frontend hosting'
    Value: !GetAtt FrontendStack.Outputs.FrontendBucketName
    Export:
      Name: !Sub '${AWS::StackName}-FrontendBucket'

  # Orchestration Role Output
  OrchestrationRoleArn:
    Description: 'ARN of the orchestration role used by all Lambda functions'
    Value: !If
      - CreateOrchestrationRole
      - !GetAtt UnifiedOrchestrationRole.Arn
      - !Ref OrchestrationRoleArn
    Export:
      Name: !Sub '${AWS::StackName}-OrchestrationRoleArn'



  # General Outputs
  Region:
    Description: 'AWS Region'
    Value: !Ref AWS::Region
    Export:
      Name: !Sub '${AWS::StackName}-Region'

  DeploymentBucket:
    Description: 'S3 bucket used for deployment artifacts'
    Value: !Ref SourceBucket
    Export:
      Name: !Sub '${AWS::StackName}-DeploymentBucket'
