AWSTemplateFormatVersion: '2010-09-09'
Description: |
  DRS Orchestration Database Stack - DynamoDB tables for protection groups,
  recovery plans, execution history, and target accounts. Uses camelCase schema,
  PAY_PER_REQUEST billing, encryption at rest, and point-in-time recovery.

# =============================================================================
# DATABASE ARCHITECTURE
# =============================================================================
# Four DynamoDB tables store all application state:
#
# 1. Protection Groups Table (groupId)
#    - Stores protection group definitions
#    - Groups organize source servers for coordinated DR operations
#    - Contains server lists, configurations, and metadata
#
# 2. Recovery Plans Table (planId)
#    - Stores recovery plan definitions
#    - Plans define DR workflows: drill, failover, failback
#    - References protection groups and target configurations
#
# 3. Execution History Table (executionId + planId)
#    - Tracks all DR operation executions
#    - Composite key: executionId (HASH) + planId (RANGE)
#    - GSIs: StatusIndex (query by status), planIdIndex (query by plan)
#    - Records start time, end time, status, results, errors
#
# 4. Target Accounts Table (accountId)
#    - Stores cross-account configuration
#    - Contains IAM role ARNs, region mappings, credentials
#    - Enables hub-and-spoke DR architecture
#
# Schema Convention:
# - All attribute names use camelCase (groupId, planId, executionId, accountId)
# - Consistent with JavaScript/TypeScript frontend conventions
# - Simplifies API response handling without case transformation
#
# Security Features:
# - SSE (Server-Side Encryption) enabled on all tables
# - Point-in-time recovery enabled for data protection
# - TTL attribute available for automatic record expiration
#
# Billing:
# - PAY_PER_REQUEST (on-demand) mode for all tables
# - No capacity planning required
# - Scales automatically with workload

# =============================================================================
# PARAMETERS
# =============================================================================

Parameters:
  ProjectName:
    Type: String
    Default: 'hrp-drs-tech-adapter'
    Description: 'Project name used for resource naming'

  Environment:
    Type: String
    Default: 'dev'
    Description: 'Environment name (dev, test, prod)'

  ForceRecreation:
    Type: String
    Default: 'false'
    Description: 'Force table recreation (true/false) - WARNING: deletes all data'
    AllowedValues:
      - 'true'
      - 'false'

# =============================================================================
# CONDITIONS
# =============================================================================

Conditions:
  # Triggers table recreation when set to true
  ForceRecreationCondition: !Equals [!Ref ForceRecreation, 'true']

# =============================================================================
# RESOURCES
# =============================================================================

Resources:
  # ===========================================================================
  # RECREATION TRIGGER
  # ===========================================================================
  # Only created when ForceRecreation=true to trigger table recreation.
  # Used when tables need to be dropped and recreated (e.g., changing
  # partition key names which cannot be modified in place).
  #
  # WARNING: Setting ForceRecreation=true will DELETE all existing data!
  # Always backup data before using this option.
  RecreationTrigger:
    Type: AWS::CloudFormation::WaitConditionHandle
    DeletionPolicy: Delete
    Condition: ForceRecreationCondition
    Metadata:
      RecreationTimestamp: !Ref 'AWS::StackId'

  # ===========================================================================
  # PROTECTION GROUPS TABLE
  # ===========================================================================
  # Stores protection group definitions that organize source servers.
  #
  # Primary Key: groupId (String)
  #
  # Example Item:
  # {
  #   "groupId": "pg-web-servers",
  #   "name": "Web Server Group",
  #   "description": "Production web servers",
  #   "sourceServers": ["s-abc123", "s-def456"],
  #   "targetAccountId": "111122223333",
  #   "createdAt": "2025-01-15T10:30:00Z",
  #   "updatedAt": "2025-01-20T14:45:00Z"
  # }
  ProtectionGroupsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub '${ProjectName}-protection-groups-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: groupId
          AttributeType: S
      KeySchema:
        - AttributeName: groupId
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: TTL
        Enabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: Schema
          Value: camelCase

  # ===========================================================================
  # RECOVERY PLANS TABLE
  # ===========================================================================
  # Stores recovery plan definitions for DR operations.
  #
  # Primary Key: planId (String)
  #
  # Example Item:
  # {
  #   "planId": "rp-prod-failover",
  #   "name": "Production Failover Plan",
  #   "type": "failover",
  #   "protectionGroupIds": ["pg-web-servers", "pg-app-servers"],
  #   "targetRegion": "us-west-2",
  #   "launchConfiguration": {...},
  #   "createdAt": "2025-01-15T10:30:00Z"
  # }
  RecoveryPlansTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub '${ProjectName}-recovery-plans-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: planId
          AttributeType: S
      KeySchema:
        - AttributeName: planId
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: TTL
        Enabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: Schema
          Value: camelCase

  # ===========================================================================
  # EXECUTION HISTORY TABLE
  # ===========================================================================
  # Tracks all DR operation executions with full audit trail.
  #
  # Primary Key: executionId (HASH) + planId (RANGE)
  # - Composite key allows multiple executions per plan
  # - Efficient queries for specific execution or all executions of a plan
  #
  # Global Secondary Indexes:
  # - StatusIndex: Query executions by status (PENDING, RUNNING, COMPLETED, FAILED)
  # - planIdIndex: Query all executions for a specific plan
  #
  # Example Item:
  # {
  #   "executionId": "exec-20250115-abc123",
  #   "planId": "rp-prod-failover",
  #   "status": "COMPLETED",
  #   "type": "drill",
  #   "startTime": "2025-01-15T10:30:00Z",
  #   "endTime": "2025-01-15T11:45:00Z",
  #   "initiatedBy": "user@example.com",
  #   "results": {...}
  # }
  ExecutionHistoryTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub '${ProjectName}-execution-history-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: executionId
          AttributeType: S
        - AttributeName: planId
          AttributeType: S
        - AttributeName: status
          AttributeType: S
      KeySchema:
        - AttributeName: executionId
          KeyType: HASH
        - AttributeName: planId
          KeyType: RANGE
      GlobalSecondaryIndexes:
        # StatusIndex: Query executions by status
        # Example: Get all RUNNING executions
        - IndexName: StatusIndex
          KeySchema:
            - AttributeName: status
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        # planIdIndex: Query all executions for a plan
        # Example: Get execution history for a specific recovery plan
        - IndexName: planIdIndex
          KeySchema:
            - AttributeName: planId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: TTL
        Enabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: Schema
          Value: camelCase

  # ===========================================================================
  # TARGET ACCOUNTS TABLE
  # ===========================================================================
  # Stores cross-account configuration for hub-and-spoke DR architecture.
  #
  # Primary Key: accountId (String - 12-digit AWS account ID)
  #
  # Example Item:
  # {
  #   "accountId": "111122223333",
  #   "accountName": "Production Account",
  #   "crossAccountRoleArn": "arn:aws:iam::111122223333:role/DRSCrossAccountRole",
  #   "regions": ["us-east-1", "us-west-2"],
  #   "status": "ACTIVE",
  #   "lastSyncTime": "2025-01-20T14:45:00Z"
  # }
  TargetAccountsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub '${ProjectName}-target-accounts-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: accountId
          AttributeType: S
      KeySchema:
        - AttributeName: accountId
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: TTL
        Enabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: Schema
          Value: camelCase

  # ===========================================================================
  # DRS REGION STATUS TABLE
  # ===========================================================================
  # Tracks DRS service availability and health per region.
  # Separate from server inventory for cleaner data model.
  #
  # Key Schema:
  #   region (HASH) - AWS region code (e.g., "us-east-1")
  #
  # Item Schema:
  # {
  #   "region": "us-east-1",
  #   "status": "AVAILABLE",
  #   "serverCount": 42,
  #   "replicatingCount": 38,
  #   "lastChecked": "2026-02-15T06:00:00Z",
  #   "errorMessage": null
  # }
  DRSRegionStatusTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub '${ProjectName}-drs-region-status-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: region
          AttributeType: S
      KeySchema:
        - AttributeName: region
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: TTL
        Enabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: Schema
          Value: camelCase

  # ===========================================================================
  # SOURCE SERVER INVENTORY TABLE
  # ===========================================================================
  # Tracks DRS agent installations and source server metadata for failback.
  # Captures pre-disaster state: network, IP, security groups, tags, etc.
  #
  # Key Schema:
  #   sourceServerArn (HASH) - Globally unique DRS source server ARN
  #   stagingAccountId (RANGE) - Account where agent replicates to
  #
  # GSIs:
  #   SourceAccountIndex - Query by source EC2 account
  #   StagingAccountIndex - Query all servers in a staging account
  #
  # Item Schema:
  # {
  #   "sourceServerArn": "arn:aws:drs:us-east-2:338552098570:source-server/s-xxx",
  #   "stagingAccountId": "338552098570",
  #   "sourceServerID": "s-xxx",
  #   "sourceAccountId": "851725249649",
  #   "sourceRegion": "us-east-1",
  #   "hostname": "hrp-dev-db-az4-001",
  #   "instanceId": "i-xxx",
  #   "agentVersion": "5.x.x",
  #   "agentInstalledAt": "2026-02-14T03:00:00Z",
  #   "replicationRegion": "us-east-2",
  #   "networkConfig": {
  #     "vpcId": "vpc-xxx",
  #     "subnetId": "subnet-xxx",
  #     "privateIp": "10.229.143.101",
  #     "securityGroups": ["sg-xxx"],
  #     "instanceProfile": "ec2-baseline-role"
  #   },
  #   "sourceTags": {"Name": "hrp-dev-db-az4-001", "Service": "DatabaseServer", ...},
  #   "replicationState": "CONTINUOUS",
  #   "lastUpdated": "2026-02-14T03:00:00Z"
  # }
  SourceServerInventoryTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub '${ProjectName}-source-server-inventory-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: sourceServerArn
          AttributeType: S
        - AttributeName: stagingAccountId
          AttributeType: S
        - AttributeName: sourceAccountId
          AttributeType: S
      KeySchema:
        - AttributeName: sourceServerArn
          KeyType: HASH
        - AttributeName: stagingAccountId
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: SourceAccountIndex
          KeySchema:
            - AttributeName: sourceAccountId
              KeyType: HASH
            - AttributeName: sourceServerArn
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: StagingAccountIndex
          KeySchema:
            - AttributeName: stagingAccountId
              KeyType: HASH
            - AttributeName: sourceServerArn
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: TTL
        Enabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: Schema
          Value: camelCase

  # ===========================================================================
  # RECOVERY INSTANCES CACHE TABLE
  # ===========================================================================
  # Caches recovery instance data to reduce Recovery Plans page load time.
  # Synced via wave completion and background EventBridge schedule.
  #
  # Key Schema:
  #   sourceServerId (HASH) - DRS source server ID
  #
  # Item Schema:
  # {
  #   "sourceServerId": "s-1234567890abcdef0",
  #   "recoveryInstanceId": "ri-abcdef1234567890",
  #   "ec2InstanceId": "i-0123456789abcdef0",
  #   "ec2InstanceState": "running",
  #   "sourceServerName": "web-server-01",
  #   "name": "Recovery of web-server-01",
  #   "privateIp": "10.0.1.100",
  #   "publicIp": "54.123.45.67",
  #   "instanceType": "t3.medium",
  #   "launchTime": "2025-02-17T10:30:00Z",
  #   "region": "us-east-2",
  #   "accountId": "891376951562",
  #   "sourceExecutionId": "exec-abc123",
  #   "sourcePlanName": "Web Servers Recovery",
  #   "lastSyncTime": "2025-02-17T10:35:00Z",
  #   "replicationStagingAccountId": "123456789012",
  #   "sourceVpcId": "vpc-abc123def456",
  #   "sourceSubnetId": "subnet-xyz789abc123",
  #   "sourceSecurityGroupIds": ["sg-111222333444"],
  #   "sourceInstanceProfile": "arn:aws:iam::891376951562:instance-profile/MyAppRole"
  # }
  RecoveryInstancesCacheTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub '${ProjectName}-recovery-instances-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: sourceServerId
          AttributeType: S
      KeySchema:
        - AttributeName: sourceServerId
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: TTL
        Enabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: Schema
          Value: camelCase

# =============================================================================
# OUTPUTS
# =============================================================================
# Exported values for cross-stack references and Lambda environment variables.

Outputs:
  # ---------------------------------------------------------------------------
  # Schema Information
  # ---------------------------------------------------------------------------
  SchemaVersion:
    Description: 'Database schema version'
    Value: 'v1.0'
    Export:
      Name: !Sub '${AWS::StackName}-SchemaVersion'

  # ---------------------------------------------------------------------------
  # Protection Groups Table
  # ---------------------------------------------------------------------------
  ProtectionGroupsTableName:
    Description: 'Protection Groups table name'
    Value: !Ref ProtectionGroupsTable
    Export:
      Name: !Sub '${AWS::StackName}-ProtectionGroupsTableName'

  ProtectionGroupsTableArn:
    Description: 'Protection Groups table ARN'
    Value: !GetAtt ProtectionGroupsTable.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ProtectionGroupsTableArn'

  # ---------------------------------------------------------------------------
  # Recovery Plans Table
  # ---------------------------------------------------------------------------
  RecoveryPlansTableName:
    Description: 'Recovery Plans table name'
    Value: !Ref RecoveryPlansTable
    Export:
      Name: !Sub '${AWS::StackName}-RecoveryPlansTableName'

  RecoveryPlansTableArn:
    Description: 'Recovery Plans table ARN'
    Value: !GetAtt RecoveryPlansTable.Arn
    Export:
      Name: !Sub '${AWS::StackName}-RecoveryPlansTableArn'

  # ---------------------------------------------------------------------------
  # Execution History Table
  # ---------------------------------------------------------------------------
  ExecutionHistoryTableName:
    Description: 'Execution History table name'
    Value: !Ref ExecutionHistoryTable
    Export:
      Name: !Sub '${AWS::StackName}-ExecutionHistoryTableName'

  ExecutionHistoryTableArn:
    Description: 'Execution History table ARN'
    Value: !GetAtt ExecutionHistoryTable.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ExecutionHistoryTableArn'

  # ---------------------------------------------------------------------------
  # Target Accounts Table
  # ---------------------------------------------------------------------------
  TargetAccountsTableName:
    Description: 'Target Accounts table name'
    Value: !Ref TargetAccountsTable
    Export:
      Name: !Sub '${AWS::StackName}-TargetAccountsTableName'

  TargetAccountsTableArn:
    Description: 'Target Accounts table ARN'
    Value: !GetAtt TargetAccountsTable.Arn
    Export:
      Name: !Sub '${AWS::StackName}-TargetAccountsTableArn'

  # ---------------------------------------------------------------------------
  # DRS Region Status Table
  # ---------------------------------------------------------------------------
  DRSRegionStatusTableName:
    Description: 'DRS Region Status table name'
    Value: !Ref DRSRegionStatusTable
    Export:
      Name: !Sub '${AWS::StackName}-DRSRegionStatusTableName'

  DRSRegionStatusTableArn:
    Description: 'DRS Region Status table ARN'
    Value: !GetAtt DRSRegionStatusTable.Arn
    Export:
      Name: !Sub '${AWS::StackName}-DRSRegionStatusTableArn'

  # ---------------------------------------------------------------------------
  # Source Server Inventory Table
  # ---------------------------------------------------------------------------
  SourceServerInventoryTableName:
    Description: 'Source Server Inventory table name'
    Value: !Ref SourceServerInventoryTable
    Export:
      Name: !Sub '${AWS::StackName}-SourceServerInventoryTableName'

  SourceServerInventoryTableArn:
    Description: 'Source Server Inventory table ARN'
    Value: !GetAtt SourceServerInventoryTable.Arn
    Export:
      Name: !Sub '${AWS::StackName}-SourceServerInventoryTableArn'

  # ---------------------------------------------------------------------------
  # Recovery Instances Cache Table
  # ---------------------------------------------------------------------------
  RecoveryInstancesCacheTableName:
    Description: 'Recovery Instances Cache table name'
    Value: !Ref RecoveryInstancesCacheTable
    Export:
      Name: !Sub '${AWS::StackName}-RecoveryInstancesCacheTableName'

  RecoveryInstancesCacheTableArn:
    Description: 'Recovery Instances Cache table ARN'
    Value: !GetAtt RecoveryInstancesCacheTable.Arn
    Export:
      Name: !Sub '${AWS::StackName}-RecoveryInstancesCacheTableArn'
