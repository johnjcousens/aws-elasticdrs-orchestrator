AWSTemplateFormatVersion: '2010-09-09'
Description: |
  API Gateway Deployment Stack - Creates API deployments and stages using a
  Lambda-based orchestrator for reliable deployment management.

# =============================================================================
# STACK OVERVIEW
# =============================================================================
# This stack handles API Gateway deployment lifecycle using a custom Lambda
# orchestrator instead of direct AWS::ApiGateway::Deployment resources.
#
# Why Use a Deployment Orchestrator?
# ----------------------------------
# CloudFormation's native API Gateway deployment has limitations:
# 1. Deployments are immutable - can't update, only replace
# 2. Timing issues when methods are created in parallel stacks
# 3. No built-in retry logic for transient failures
# 4. Difficult to coordinate with dependent resources
#
# The orchestrator Lambda solves these by:
# - Adding a delay to ensure all methods are created
# - Using unique deployment IDs per stack update
# - Providing detailed logging for troubleshooting
# - Returning deployment metadata to CloudFormation
#
# Deployment Flow:
# ----------------
# 1. Method stacks create all API methods (parallel)
# 2. This stack waits for method stacks (DependsOn in master)
# 3. Gateway responses are created (CORS headers for errors)
# 4. Orchestrator Lambda creates deployment via API call
# 5. Stage resource references the new deployment ID
#
# Gateway Responses:
# ------------------
# CORS headers must be returned even on errors (4XX, 5XX, auth failures).
# Without gateway responses, browsers block error responses due to missing
# Access-Control-Allow-Origin headers.
#
# Forcing New Deployments:
# ------------------------
# To trigger a new API deployment, update the Version property in
# ApiDeploymentOrchestrator. This forces CloudFormation to invoke the
# Lambda and create a fresh deployment.
#
# Example: Version: "2026-02-06-new-feature"

# =============================================================================
# PARAMETERS
# =============================================================================
# All parameters are passed from the master template for consistency.

Parameters:
  ProjectName:
    Type: String
    Description: Project name passed from master template
    Default: hrp-drs-tech-adapter

  Environment:
    Type: String
    Description: Environment name passed from master template
    AllowedValues: [dev, test, qa, uat, prod]
    Default: dev

  RestApiId:
    Type: String
    Description: REST API ID from API Gateway Core Stack

  OrchestrationRoleArn:
    Type: String
    Description: ARN of the unified orchestration role from master stack

# =============================================================================
# RESOURCES
# =============================================================================

Resources:
  # ===========================================================================
  # DEAD LETTER QUEUE FOR DEPLOYMENT ORCHESTRATOR
  # ===========================================================================
  # ===========================================================================
  # API GATEWAY CLOUDWATCH LOGS ACCOUNT SETTING
  # ===========================================================================
  # API Gateway requires an account-level IAM role to write to CloudWatch Logs.
  # Without this, stage creation fails when AccessLogSetting is configured.
  # Uses the orchestration role (apigateway.amazonaws.com added to trust policy).

  ApiGatewayAccount:
    Type: AWS::ApiGateway::Account
    Properties:
      CloudWatchRoleArn: !Ref OrchestrationRoleArn

  # ===========================================================================
  # SQS queue to capture failed Lambda invocations for debugging
  # Required for CKV_AWS_116 (Lambda DLQ configuration)
  
  DeploymentOrchestratorDLQ:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      QueueName: !Sub "${ProjectName}-deployment-dlq-${Environment}"
      MessageRetentionPeriod: 1209600  # 14 days
      KmsMasterKeyId: alias/aws/sqs
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # ===========================================================================
  # DEPLOYMENT ORCHESTRATOR LAMBDA
  # ===========================================================================
  # Custom Lambda function that creates API Gateway deployments.
  # Uses boto3 to call create_deployment API with proper error handling.
  # Returns DeploymentId and ApiEndpoint to CloudFormation for use by Stage.
  #
  # NOTE: CloudWatch Log Group is NOT explicitly created here.
  # Lambda automatically creates log groups on first invocation.
  # This avoids "already exists" errors during CloudFormation updates.
  
  DeploymentOrchestratorFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-deployment-orchestrator-${Environment}'
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !Ref OrchestrationRoleArn
      Timeout: 300
      ReservedConcurrentExecutions: 5
      DeadLetterConfig:
        TargetArn: !GetAtt DeploymentOrchestratorDLQ.Arn
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Code:
        ZipFile: |
          import boto3
          import json
          import cfnresponse
          import time
          import logging
          from datetime import datetime
          
          logger = logging.getLogger()
          logger.setLevel(logging.INFO)
          
          def lambda_handler(event, context):
              try:
                  logger.info(f"Deployment orchestrator started")
                  
                  props = event['ResourceProperties']
                  rest_api_id = props['RestApiId']
                  stage_name = props['StageName']
                  timestamp = context.aws_request_id  # Use Lambda request ID as unique identifier
                  
                  api_client = boto3.client('apigateway')
                  
                  if event['RequestType'] in ['Create', 'Update']:
                      # Small delay to ensure all methods are fully created
                      time.sleep(2)
                      
                      # Create deployment with timestamp (no stageName in create_deployment)
                      deployment = api_client.create_deployment(
                          restApiId=rest_api_id,
                          description=f"Deployment {timestamp}"
                      )
                      
                      deployment_id = deployment['id']
                      region = boto3.Session().region_name
                      # API endpoint available after stage is created
                      api_endpoint = f"https://{rest_api_id}.execute-api.{region}.amazonaws.com/{stage_name}"
                      
                      logger.info(f"Deployment successful: {deployment_id}")
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {
                          'DeploymentId': deployment_id,
                          'ApiEndpoint': api_endpoint,
                          'DeploymentTimestamp': timestamp
                      })
                  
                  elif event['RequestType'] == 'Delete':
                      logger.info("Delete request - cleanup not required")
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                  
              except Exception as e:
                  logger.error(f"Deployment failed: {str(e)}")
                  logger.error(f"Event: {json.dumps(event)}")
                  logger.error(f"Context: {context}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {
                      'Error': str(e)
                  })

  # ===========================================================================
  # GATEWAY RESPONSES (CORS FOR ERROR RESPONSES)
  # ===========================================================================
  # API Gateway returns errors (401, 403, 500) before reaching Lambda.
  # Without gateway responses, these errors lack CORS headers and browsers
  # block them. Each response type needs explicit CORS configuration.
  #
  # Response Types:
  # - DEFAULT_4XX: All 4XX errors not explicitly configured
  # - DEFAULT_5XX: All 5XX errors not explicitly configured
  # - UNAUTHORIZED: 401 from Cognito authorizer (invalid/expired token)
  # - ACCESS_DENIED: 403 from IAM or resource policy
  
  # ---------------------------------------------------------------------------
  # 4XX Client Errors (bad request, not found, validation errors)
  # ---------------------------------------------------------------------------
  GatewayResponse4XX:
    Type: AWS::ApiGateway::GatewayResponse
    Properties:
      RestApiId: !Ref RestApiId
      ResponseType: DEFAULT_4XX
      ResponseParameters:
        gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
        gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
        gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
      ResponseTemplates:
        application/json: '{"message":"Client Error"}'

  # ---------------------------------------------------------------------------
  # 5XX Server Errors (Lambda errors, timeouts, integration failures)
  # ---------------------------------------------------------------------------
  GatewayResponse5XX:
    Type: AWS::ApiGateway::GatewayResponse
    Properties:
      RestApiId: !Ref RestApiId
      ResponseType: DEFAULT_5XX
      ResponseParameters:
        gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
        gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
        gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
      ResponseTemplates:
        application/json: '{"message":"Server Error"}'

  # ---------------------------------------------------------------------------
  # 401 Unauthorized (invalid or expired Cognito token)
  # ---------------------------------------------------------------------------
  GatewayResponseUnauthorized:
    Type: AWS::ApiGateway::GatewayResponse
    Properties:
      RestApiId: !Ref RestApiId
      ResponseType: UNAUTHORIZED
      ResponseParameters:
        gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
        gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
        gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
      ResponseTemplates:
        application/json: '{"message":"Unauthorized"}'

  # ---------------------------------------------------------------------------
  # 403 Access Denied (valid token but insufficient permissions)
  # ---------------------------------------------------------------------------
  GatewayResponseAccessDenied:
    Type: AWS::ApiGateway::GatewayResponse
    Properties:
      RestApiId: !Ref RestApiId
      ResponseType: ACCESS_DENIED
      ResponseParameters:
        gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
        gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
        gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
      ResponseTemplates:
        application/json: '{"message":"Access Denied"}'

  # ===========================================================================
  # DEPLOYMENT CUSTOM RESOURCE
  # ===========================================================================
  # Invokes the orchestrator Lambda to create a new API deployment.
  # DependsOn ensures gateway responses exist before deployment.
  # Version property forces new deployment on each update.
  
  ApiDeploymentOrchestrator:
    Type: AWS::CloudFormation::CustomResource
    DependsOn:
      # CRITICAL: Gateway Responses must exist before deployment
      - GatewayResponse4XX
      - GatewayResponse5XX
      - GatewayResponseUnauthorized
      - GatewayResponseAccessDenied
    Properties:
      ServiceToken: !GetAtt DeploymentOrchestratorFunction.Arn
      RestApiId: !Ref RestApiId
      StageName: !Ref Environment
      StackName: !Ref AWS::StackName
      # Force update on every stack update using StackId
      ForceUpdate: !Ref AWS::StackId
      # Force replacement - increment version to trigger new deployment
      Version: "2026-02-15-source-server-inventory-endpoint"

  # ===========================================================================
  # API GATEWAY ACCESS LOG GROUP
  # ===========================================================================
  # CloudWatch Log Group for API Gateway access logs.
  # Stores request/response metadata for debugging and compliance.
  ApiGatewayAccessLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      LogGroupName: !Sub '/aws/apigateway/${ProjectName}-${Environment}-access-logs'
      RetentionInDays: 30
      # Note: CloudWatch Logs are encrypted at rest by default with AWS-managed keys.
      # CMK encryption (KmsKeyId) requires creating a dedicated KMS key with proper
      # resource policy allowing logs.{region}.amazonaws.com service principal.
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # ===========================================================================
  # API STAGE
  # ===========================================================================
  # The stage is the deployed API accessible via URL.
  # References the deployment created by the orchestrator.
  # Includes throttling, logging, and X-Ray tracing configuration.
  #
  # Stage URL: https://{rest-api-id}.execute-api.{region}.amazonaws.com/{stage}
  
  ApiStage:
    Type: AWS::ApiGateway::Stage
    DependsOn:
      - ApiDeploymentOrchestrator
      - ApiGatewayAccessLogGroup
      - ApiGatewayAccount
    Properties:
      StageName: !Ref Environment
      RestApiId: !Ref RestApiId
      DeploymentId: !GetAtt ApiDeploymentOrchestrator.DeploymentId
      TracingEnabled: true
      # Access logging for compliance and debugging
      AccessLogSetting:
        DestinationArn: !GetAtt ApiGatewayAccessLogGroup.Arn
        Format: '{"requestId":"$context.requestId","ip":"$context.identity.sourceIp","caller":"$context.identity.caller","user":"$context.identity.user","requestTime":"$context.requestTime","httpMethod":"$context.httpMethod","resourcePath":"$context.resourcePath","status":"$context.status","protocol":"$context.protocol","responseLength":"$context.responseLength"}'
      # Enterprise monitoring and throttling
      MethodSettings:
        - ResourcePath: '/*'
          HttpMethod: '*'
          LoggingLevel: INFO
          DataTraceEnabled: true
          MetricsEnabled: true
          ThrottlingBurstLimit: 2000
          ThrottlingRateLimit: 1000
        - ResourcePath: '/health'
          HttpMethod: 'GET'
          ThrottlingBurstLimit: 5000
          ThrottlingRateLimit: 2000
      Variables:
        stackName: !Ref AWS::StackName
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

# =============================================================================
# OUTPUTS
# =============================================================================
# Export deployment metadata for use by other stacks and monitoring.

Outputs:
  ApiEndpoint:
    Description: 'API Gateway endpoint URL'
    Value: !GetAtt ApiDeploymentOrchestrator.ApiEndpoint
    Export:
      Name: !Sub '${AWS::StackName}-ApiEndpoint'

  DeploymentId:
    Description: 'API Gateway Deployment ID'
    Value: !GetAtt ApiDeploymentOrchestrator.DeploymentId
    Export:
      Name: !Sub '${AWS::StackName}-DeploymentId'

  ApiStageArn:
    Description: 'API Gateway Stage ARN'
    Value: !Sub 'arn:aws:apigateway:${AWS::Region}::/restapis/${RestApiId}/stages/${Environment}'
    Export:
      Name: !Sub '${AWS::StackName}-ApiStageArn'