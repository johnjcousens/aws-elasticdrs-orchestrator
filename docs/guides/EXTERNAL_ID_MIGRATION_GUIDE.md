# External ID Migration Guide

## Overview

The DRS Orchestration Platform has migrated from a hardcoded External ID to a dynamic, account-specific pattern for improved security and multi-environment support.

## What Changed

### Old Pattern (Deprecated)
```
External ID: DRSOrchestration2024
```

**Problems**:
- Hardcoded year (2024) requires annual updates
- Same External ID across all environments (dev, test, prod)
- Same External ID for all accounts
- Security risk: predictable pattern

### New Pattern (Current)
```
External ID: {ProjectName}-{Environment}-{AccountId}
```

**Examples**:
- Target account (dev): `drs-orchestration-dev-111122223333`
- Staging account (dev): `drs-orchestration-dev-444455556666`
- Target account (prod): `drs-orchestration-prod-111122223333`

**Benefits**:
- ✅ Unique per account
- ✅ Unique per environment
- ✅ No annual updates required
- ✅ Better security through unpredictability
- ✅ Self-documenting (includes project, environment, account)

## Architecture

### Account Structure
- **Orchestration Account**: 777788889999 (where Lambda functions run)
- **Target Account**: 111122223333 (recovery destination)
- **Staging Account**: 444455556666 (extended source servers)
- **Networking Account**: 555566667777 (shared VPC via AWS RAM)

### Cross-Account Role Pattern

Each target/staging account has a role that trusts the orchestration account:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::777788889999:root"
      },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": {
          "sts:ExternalId": "drs-orchestration-dev-111122223333"
        }
      }
    }
  ]
}
```

## Implementation Details

### CloudFormation Template

The `cfn/cross-account-role-stack.yaml` template now auto-generates the External ID:

```yaml
Parameters:
  ExternalId:
    Description: 'External ID for secure cross-account access (leave default for auto-generated value)'
    Type: String
    Default: 'USE_AUTO_GENERATED'

Conditions:
  UseAutoGeneratedExternalId: !Equals [!Ref ExternalId, 'USE_AUTO_GENERATED']

Resources:
  DRSOrchestrationRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'DRSOrchestrationRole-${Environment}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:${AWS::Partition}:iam::${OrchestrationAccountId}:root'
            Action: 'sts:AssumeRole'
            Condition:
              StringEquals:
                'sts:ExternalId': !If
                  - UseAutoGeneratedExternalId
                  - !Sub '${ProjectName}-${Environment}-${AWS::AccountId}'
                  - !Ref ExternalId

Outputs:
  ExternalId:
    Description: 'External ID for secure cross-account access'
    Value: !If
      - UseAutoGeneratedExternalId
      - !Sub '${ProjectName}-${Environment}-${AWS::AccountId}'
      - !Ref ExternalId
```

### Lambda Function

The `lambda/drs-agent-deployer/index.py` function auto-generates External ID if not provided:

```python
# External ID: Use event value, or auto-generate from environment
external_id = event.get('external_id')
if not external_id:
    project_name = os.environ.get('PROJECT_NAME', 'drs-orchestration')
    environment = os.environ.get('ENVIRONMENT', 'dev')
    # Use source account for External ID (where role is being assumed)
    external_id = f"{project_name}-{environment}-{source_account_id}"
    print(f"Auto-generated External ID: {external_id}")
```

### Lambda Environment Variables

The `cfn/lambda-stack.yaml` no longer includes hardcoded `EXTERNAL_ID`:

```yaml
# OLD (removed)
Environment:
  Variables:
    EXTERNAL_ID: DRSOrchestration2024

# NEW (dynamic)
Environment:
  Variables:
    PROJECT_NAME: !Ref ProjectName
    ENVIRONMENT: !Ref Environment
```

## Migration Steps

### 1. Deploy Updated Cross-Account Roles

Deploy the updated role stack to both target and staging accounts:

```bash
# Deploy to target account (111122223333)
./scripts/deploy-cross-account-roles.sh

# Or manually:
aws cloudformation deploy \
  --template-file cfn/cross-account-role-stack.yaml \
  --stack-name drs-orchestration-cross-account-role-dev \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameter-overrides \
    OrchestrationAccountId=777788889999 \
    Environment=dev \
    ProjectName=drs-orchestration \
  --profile target-account

aws cloudformation deploy \
  --template-file cfn/cross-account-role-stack.yaml \
  --stack-name drs-orchestration-cross-account-role-dev \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameter-overrides \
    OrchestrationAccountId=777788889999 \
    Environment=dev \
    ProjectName=drs-orchestration \
  --profile staging-account
```

### 2. Verify Role Creation

Check that roles were created with correct External IDs:

```bash
# Verify target account role
aws cloudformation describe-stacks \
  --stack-name drs-orchestration-cross-account-role-dev \
  --query 'Stacks[0].Outputs[?OutputKey==`ExternalId`].OutputValue' \
  --output text \
  --profile target-account

# Expected: drs-orchestration-dev-111122223333

# Verify staging account role
aws cloudformation describe-stacks \
  --stack-name drs-orchestration-cross-account-role-dev \
  --query 'Stacks[0].Outputs[?OutputKey==`ExternalId`].OutputValue' \
  --output text \
  --profile staging-account

# Expected: drs-orchestration-dev-444455556666
```

### 3. Test Role Assumption

Test that orchestration account can assume roles with new External IDs:

```bash
./scripts/verify-cross-account-roles.sh
```

### 4. Update Lambda Function

Deploy updated Lambda function (removes hardcoded EXTERNAL_ID):

```bash
./scripts/deploy.sh dev --lambda-only
```

### 5. Test DRS Agent Deployment

Test agent deployment with auto-generated External ID:

```bash
# Event no longer needs external_id field
aws lambda invoke \
  --function-name drs-orchestration-drs-agent-deployer-dev \
  --payload '{
    "source_account_id": "111122223333",
    "staging_account_id": "444455556666",
    "source_region": "us-east-1",
    "target_region": "us-west-2",
    "source_role_arn": "arn:aws:iam::111122223333:role/DRSOrchestrationRole-dev",
    "staging_role_arn": "arn:aws:iam::444455556666:role/DRSOrchestrationRole-dev"
  }' \
  response.json
```

## Event Structure Changes

### Before (Old)
```json
{
  "source_account_id": "111122223333",
  "source_role_arn": "arn:aws:iam::111122223333:role/DRSOrchestrationRole",
  "external_id": "DRSOrchestration2024"
}
```

### After (New)
```json
{
  "source_account_id": "111122223333",
  "source_role_arn": "arn:aws:iam::111122223333:role/DRSOrchestrationRole-dev"
}
```

**Note**: `external_id` field is now optional and auto-generated if omitted.

## Backward Compatibility

The Lambda function supports both patterns:

1. **Auto-generated** (recommended): Omit `external_id` from event
2. **Explicit**: Provide `external_id` in event (for custom patterns)

## Security Considerations

### Why External ID?

External ID prevents the "confused deputy" problem in cross-account access:

1. Without External ID: Any AWS account could potentially assume your role if they know the ARN
2. With External ID: Only accounts that know both the role ARN AND the External ID can assume the role

### Why Dynamic Pattern?

1. **Uniqueness**: Each account/environment combination has a unique External ID
2. **Unpredictability**: Harder to guess than hardcoded patterns
3. **Maintainability**: No annual updates required
4. **Auditability**: External ID includes account ID for easy tracking

## Troubleshooting

### Error: "Not authorized to perform sts:AssumeRole"

**Cause**: External ID mismatch

**Solution**: Verify External ID matches between:
1. Role trust policy in target/staging account
2. Lambda function's assume role call

```bash
# Check role trust policy
aws iam get-role \
  --role-name DRSOrchestrationRole-dev \
  --query 'Role.AssumeRolePolicyDocument' \
  --profile target-account

# Check CloudFormation stack output
aws cloudformation describe-stacks \
  --stack-name drs-orchestration-cross-account-role-dev \
  --query 'Stacks[0].Outputs[?OutputKey==`ExternalId`].OutputValue' \
  --output text \
  --profile target-account
```

### Error: "Role not found"

**Cause**: Role name changed from `DRSOrchestrationRole` to `DRSOrchestrationRole-{Environment}`

**Solution**: Update role ARNs in Lambda events to include environment suffix:
- Old: `arn:aws:iam::111122223333:role/DRSOrchestrationRole`
- New: `arn:aws:iam::111122223333:role/DRSOrchestrationRole-dev`

## Related Documentation

- [Cross-Account Setup Verification](DRS_CROSS_ACCOUNT_SETUP_VERIFICATION.md)
- [Capacity Scaling Architecture](DRS_CAPACITY_SCALING_ARCHITECTURE.md)
- [DRS Agent Deployer Spec](.kiro/specs/drs-agent-deployer/)

## Summary

The migration to dynamic External IDs improves security, maintainability, and multi-environment support. The pattern is now:

```
{ProjectName}-{Environment}-{AccountId}
```

This change requires:
1. ✅ Redeploying cross-account role stacks
2. ✅ Updating Lambda function
3. ✅ Updating role ARNs to include environment suffix
4. ✅ Removing hardcoded `external_id` from Lambda events (now auto-generated)
