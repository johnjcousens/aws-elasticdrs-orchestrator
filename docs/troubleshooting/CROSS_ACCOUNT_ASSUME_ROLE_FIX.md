# Cross-Account AssumeRole Permission Error - Fix Guide

## Error Description

```
An error occurred (AccessDenied) when calling the AssumeRole operation: 
User: arn:aws:sts::111122223333:assumed-role/DRSOrchestrationRole/test-drs-query 
is not authorized to perform: sts:AssumeRole on resource: 
arn:aws:iam::111122223333:role/DRSOrchestrationRole
```

## Root Cause

**ACTUAL ISSUE**: The error shows the Lambda is **already running with an assumed role** in account 111122223333:

```
arn:aws:sts::111122223333:assumed-role/DRSOrchestrationRole/test-drs-query
```

This means:
1. The Lambda successfully assumed `DRSOrchestrationRole` in account 111122223333
2. But then it's trying to assume the **same role again** in the **same account**
3. The role's trust policy doesn't allow itself to assume itself

**Root Cause in Code**: The `get_current_account_id()` function in `lambda/shared/cross_account.py` uses `sts:GetCallerIdentity`, which returns the account ID of the **current credentials**. When running with assumed role credentials, it returns the target account ID (111122223333), not the original orchestration account ID (777788889999).

This causes the logic to incorrectly think it's running in the target account when it's actually running in the orchestration account with assumed credentials.

## Current Trust Policy (In Target Account)

```yaml
AssumeRolePolicyDocument:
  Version: '2012-10-17'
  Statement:
    - Effect: Allow
      Principal:
        AWS: !Sub 'arn:${AWS::Partition}:iam::${OrchestrationAccountId}:root'
      Action: 'sts:AssumeRole'
      Condition:
        StringEquals:
          'sts:ExternalId': !If
            - UseAutoGeneratedExternalId
            - !Sub '${ProjectName}-${AWS::AccountId}'
            - !Ref ExternalId
```

This trust policy allows:
- ✅ Direct calls from IAM users in orchestration account
- ❌ Calls from Lambda functions (which use assumed role sessions)

## Solution

Update the trust policy to allow the **orchestration role** (not just root) to assume the cross-account role.

### Option 1: Allow Specific Orchestration Role (Recommended)

```yaml
AssumeRolePolicyDocument:
  Version: '2012-10-17'
  Statement:
    - Effect: Allow
      Principal:
        AWS: 
          - !Sub 'arn:${AWS::Partition}:iam::${OrchestrationAccountId}:root'
          - !Sub 'arn:${AWS::Partition}:iam::${OrchestrationAccountId}:role/${ProjectName}-orchestration-role-${Environment}'
      Action: 'sts:AssumeRole'
      Condition:
        StringEquals:
          'sts:ExternalId': !If
            - UseAutoGeneratedExternalId
            - !Sub '${ProjectName}-${AWS::AccountId}'
            - !Ref ExternalId
```

### Option 2: Allow All Roles in Orchestration Account (More Flexible)

```yaml
AssumeRolePolicyDocument:
  Version: '2012-10-17'
  Statement:
    - Effect: Allow
      Principal:
        AWS: !Sub 'arn:${AWS::Partition}:iam::${OrchestrationAccountId}:root'
      Action: 'sts:AssumeRole'
      Condition:
        StringEquals:
          'sts:ExternalId': !If
            - UseAutoGeneratedExternalId
            - !Sub '${ProjectName}-${AWS::AccountId}'
            - !Ref ExternalId
```

**Note**: The `root` principal with proper External ID condition is actually secure and allows all IAM entities (users, roles, assumed role sessions) in the orchestration account to assume the role.

## Why This Happens

1. Lambda function runs with execution role: `arn:aws:iam::777788889999:role/aws-drs-orchestration-orchestration-role-test`
2. When Lambda calls `sts:AssumeRole`, it creates a session: `arn:aws:sts::777788889999:assumed-role/aws-drs-orchestration-orchestration-role-test/test-drs-query`
3. The cross-account role's trust policy checks if this session is allowed
4. Current policy only allows `arn:aws:iam::777788889999:root`, not assumed role sessions
5. AssumeRole fails with AccessDenied

## Verification

The current trust policy **should work** because it uses `:root` principal, which includes all IAM entities in the account. The issue might be:

1. **External ID mismatch**: The External ID being passed doesn't match the expected value
2. **Role doesn't exist**: The `DRSOrchestrationRole` doesn't exist in account 111122223333
3. **Wrong account**: The code is trying to assume the role in the wrong account

## Debugging Steps

### 1. Verify the Role Exists

```bash
aws iam get-role \
  --role-name DRSOrchestrationRole \
  --profile target-account
```

### 2. Check the Trust Policy

```bash
aws iam get-role \
  --role-name DRSOrchestrationRole \
  --query 'Role.AssumeRolePolicyDocument' \
  --profile target-account
```

### 3. Verify External ID

Check what External ID is being used:

```python
# In lambda/shared/cross_account.py
# Add logging before assume_role call:
print(f"Assuming role: {role_arn}")
print(f"External ID: {external_id}")
```

### 4. Test AssumeRole Manually

```bash
# From orchestration account
aws sts assume-role \
  --role-arn arn:aws:iam::111122223333:role/DRSOrchestrationRole \
  --role-session-name test-manual \
  --external-id drs-orchestration-111122223333
```

## Common Issues

### Issue 1: External ID Mismatch

**Symptom**: AccessDenied even though role exists

**Solution**: Ensure the External ID matches:
- Default: `${ProjectName}-${AWS::AccountId}` = `drs-orchestration-111122223333`
- Check DynamoDB `TARGET_ACCOUNTS_TABLE` for the account's `externalId` field

### Issue 2: Role Not Deployed

**Symptom**: InvalidUserID.NotFound or NoSuchEntity

**Solution**: Deploy the cross-account role stack in the target account:

```bash
aws cloudformation deploy \
  --template-file cfn/cross-account-role-stack.yaml \
  --stack-name drs-orchestration-cross-account-role \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameter-overrides \
    OrchestrationAccountId=777788889999 \
    ProjectName=drs-orchestration \
  --profile target-account
```

### Issue 3: Wrong Account ID

**Symptom**: Trying to assume role in same account

**Solution**: Verify the Protection Group's `accountId` field in DynamoDB

```bash
aws dynamodb get-item \
  --table-name aws-drs-orchestration-protection-groups-test \
  --key '{"groupId": {"S": "your-pg-id"}}'
```

## Quick Fix Commands

### Deploy Cross-Account Role in Target Account

```bash
# Set variables
ORCHESTRATION_ACCOUNT=777788889999
TARGET_ACCOUNT=111122223333
PROJECT_NAME=drs-orchestration

# Deploy the role
aws cloudformation deploy \
  --template-file cfn/cross-account-role-stack.yaml \
  --stack-name ${PROJECT_NAME}-cross-account-role \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameter-overrides \
    OrchestrationAccountId=${ORCHESTRATION_ACCOUNT} \
    ProjectName=${PROJECT_NAME} \
  --profile target-account-profile
```

### Register Target Account in DynamoDB

```bash
# Get the External ID from CloudFormation output
EXTERNAL_ID=$(aws cloudformation describe-stacks \
  --stack-name drs-orchestration-cross-account-role \
  --query 'Stacks[0].Outputs[?OutputKey==`ExternalId`].OutputValue' \
  --output text \
  --profile target-account-profile)

# Add to TARGET_ACCOUNTS_TABLE
aws dynamodb put-item \
  --table-name aws-drs-orchestration-target-accounts-test \
  --item "{
    \"accountId\": {\"S\": \"${TARGET_ACCOUNT}\"},
    \"assumeRoleName\": {\"S\": \"DRSOrchestrationRole\"},
    \"externalId\": {\"S\": \"${EXTERNAL_ID}\"},
    \"region\": {\"S\": \"us-east-1\"}
  }"
```

## Related Files

- `cfn/cross-account-role-stack.yaml` - Cross-account role template
- `cfn/master-template.yaml` - Orchestration role with STS permissions
- `lambda/shared/cross_account.py` - Role assumption logic
- `docs/guides/DRS_CROSS_ACCOUNT_SETUP_VERIFICATION.md` - Setup guide

## References

- [AWS IAM Trust Policies](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_terms-and-concepts.html)
- [STS AssumeRole](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html)
- [External ID Best Practices](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user_externalid.html)
