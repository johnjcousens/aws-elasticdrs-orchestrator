schemaVersion: '0.3'
description: |
  EC2 Instance Terminate and Restore Automation
  
  This automation terminates an existing EC2 instance and restores it from the most recent
  launch template with matching Name tag, using CreationDate for selection when multiple exist.
  
  Workflow:
  
  1. Identifies target instance by Name tag
  
  2. Finds launch templates with matching Name tag (stops if none found)
  
  3. Selects latest template using CreationDate tag
  
  4. Disables termination protection on existing instance
  
  5. Force terminates the existing instance (hard shutdown)
  
  6. Launches new instance from the selected launch template
  
  7. Waits for new instance to be running
  
  8. Waits for instance status checks to complete
  
  9. Enables termination protection on the restored instance
  
  Key Features:
  - Name tag based instance identification
  - Launch template discovery by matching Name tags
  - CreationDate based selection for multiple templates
  - AMI availability validation before restore
  - Complete instance replacement with preserved configuration
  - Comprehensive error handling and status reporting
  
  Use Cases:
  - Disaster recovery from backup
  - Instance refresh from known good state
  - Rollback to previous configuration
  - Testing restore procedures

assumeRole: 'arn:aws:iam::140023385391:role/drs-plan-automation-lambda-prod-iam-usw2'
parameters:

  InstanceName:
    type: String
    default: 'MyServerName'
    description: 'Name tag of the instance to restore (e.g., MyServer). The automation will find launch templates with matching Name tags.'
    
  TargetRegion:
    type: String
    default: 'us-west-2'
    allowedValues:
      - 'us-east-1'         # US East (N. Virginia)
      - 'us-east-2'         # US East (Ohio)
      - 'us-west-1'         # US West (N. California)
      - 'us-west-2'         # US West (Oregon)
      - 'ca-central-1'      # Canada (Central)
      - 'ca-west-1'         # Canada (West)
      - 'eu-central-1'      # Europe (Frankfurt)
      - 'eu-central-2'      # Europe (Zurich)
      - 'eu-west-1'         # Europe (Ireland)
      - 'eu-west-2'         # Europe (London)
      - 'eu-west-3'         # Europe (Paris)
      - 'eu-north-1'        # Europe (Stockholm)
      - 'eu-south-1'        # Europe (Milan)
      - 'eu-south-2'        # Europe (Spain)
      - 'ap-east-1'         # Asia Pacific (Hong Kong)
      - 'ap-south-1'        # Asia Pacific (Mumbai)
      - 'ap-south-2'        # Asia Pacific (Hyderabad)
      - 'ap-southeast-1'    # Asia Pacific (Singapore)
      - 'ap-southeast-2'    # Asia Pacific (Sydney)
      - 'ap-southeast-3'    # Asia Pacific (Jakarta)
      - 'ap-southeast-4'    # Asia Pacific (Melbourne)
      - 'ap-northeast-1'    # Asia Pacific (Tokyo)
      - 'ap-northeast-2'    # Asia Pacific (Seoul)
      - 'ap-northeast-3'    # Asia Pacific (Osaka)
      - 'me-south-1'        # Middle East (Bahrain)
      - 'af-south-1'        # Africa (Cape Town)
      - 'sa-east-1'         # South America (SÃ£o Paulo)
    description: 'AWS region where your instance is located. Select from the dropdown list.'

mainSteps:
  - name: ResolveInstance
    action: 'aws:executeScript'
    description: 'Find target instance by Name tag'
    inputs:
      Runtime: python3.11
      Handler: resolve_instance
      Script: |
        import boto3
        
        def resolve_instance(events, context):
            instance_name = events['InstanceName']
            region = events['TargetRegion']
            
            ec2 = boto3.client('ec2', region_name=region)
            
            response = ec2.describe_instances(
                Filters=[
                    {'Name': 'tag:Name', 'Values': [instance_name]},
                    {'Name': 'instance-state-name', 'Values': ['running', 'stopped', 'stopping', 'pending']}
                ]
            )
            
            if not response['Reservations']:
                raise Exception(f"No instance found with Name tag: {instance_name}")
            
            instance = response['Reservations'][0]['Instances'][0]
            
            return {
                'InstanceId': instance['InstanceId'],
                'InstanceName': instance_name
            }
      
      InputPayload:
        InstanceName: '{{ InstanceName }}'
        TargetRegion: '{{ TargetRegion }}'
    
    outputs:
      - Name: InstanceId
        Selector: $.Payload.InstanceId
        Type: String
      - Name: InstanceName
        Selector: $.Payload.InstanceName
        Type: String

  - name: FindLatestLaunchTemplate
    action: 'aws:executeScript'
    description: 'Find launch template with matching Name tag and validate corresponding AMI exists'
    inputs:
      Runtime: python3.11
      Handler: find_template
      Script: |
        import boto3
        from datetime import datetime
        
        def find_template(events, context):
            region = events['TargetRegion']
            instance_name = events['InstanceName']
            
            ec2 = boto3.client('ec2', region_name=region)
            
            # Find launch templates with matching Name tag
            templates = ec2.describe_launch_templates()
            
            matching_templates = []
            for template in templates['LaunchTemplates']:
                # Get template tags
                template_tags = ec2.describe_tags(
                    Filters=[
                        {'Name': 'resource-id', 'Values': [template['LaunchTemplateId']]},
                        {'Name': 'resource-type', 'Values': ['launch-template']}
                    ]
                )['Tags']
                
                # Check if template has matching Name tag
                template_name_tag = next((tag['Value'] for tag in template_tags if tag['Key'] == 'Name'), None)
                if template_name_tag == instance_name:
                    # Get CreationDate tag for sorting
                    creation_date_tag = next((tag['Value'] for tag in template_tags if tag['Key'] == 'CreationDate'), None)
                    if creation_date_tag:
                        matching_templates.append({
                            'template': template,
                            'creation_date': creation_date_tag
                        })
            
            if not matching_templates:
                raise Exception(f"No launch templates found with Name tag: {instance_name}")
            
            # Sort by CreationDate (most recent first)
            matching_templates.sort(key=lambda x: x['creation_date'], reverse=True)
            
            # Get the most recent template
            latest_template = matching_templates[0]['template']
            
            # Get the latest version of the template
            template_versions = ec2.describe_launch_template_versions(
                LaunchTemplateId=latest_template['LaunchTemplateId']
            )
            
            latest_version = max(template_versions['LaunchTemplateVersions'], key=lambda x: x['VersionNumber'])
            
            # Validate that the AMI referenced in the template exists and is available
            ami_id = latest_version['LaunchTemplateData']['ImageId']
            try:
                ami_response = ec2.describe_images(ImageIds=[ami_id])
                if not ami_response['Images']:
                    raise Exception(f"AMI {ami_id} referenced in launch template not found")
                
                ami = ami_response['Images'][0]
                if ami['State'] != 'available':
                    raise Exception(f"AMI {ami_id} is in state '{ami['State']}', not available for launch")
            except Exception as e:
                if 'InvalidAMIID.NotFound' in str(e):
                    raise Exception(f"AMI {ami_id} referenced in launch template does not exist")
                raise e
            
            return {
                'LaunchTemplateId': latest_template['LaunchTemplateId'],
                'LaunchTemplateName': latest_template['LaunchTemplateName'],
                'VersionNumber': str(latest_version['VersionNumber']),
                'CreationDate': matching_templates[0]['creation_date'],
                'AmiId': ami_id,
                'AmiState': ami['State']
            }
      
      InputPayload:
        TargetRegion: '{{ TargetRegion }}'
        InstanceName: '{{ ResolveInstance.InstanceName }}'
    
    outputs:
      - Name: LaunchTemplateId
        Selector: $.Payload.LaunchTemplateId
        Type: String
      - Name: LaunchTemplateName
        Selector: $.Payload.LaunchTemplateName
        Type: String
      - Name: VersionNumber
        Selector: $.Payload.VersionNumber
        Type: String
      - Name: CreationDate
        Selector: $.Payload.CreationDate
        Type: String
      - Name: AmiId
        Selector: $.Payload.AmiId
        Type: String
      - Name: AmiState
        Selector: $.Payload.AmiState
        Type: String

  - name: DisableTerminationProtection
    action: 'aws:executeAwsApi'
    description: 'Disable termination protection before terminating instance'
    inputs:
      Service: ec2
      Api: ModifyInstanceAttribute
      InstanceId: '{{ ResolveInstance.InstanceId }}'
      DisableApiTermination:
        Value: false

  - name: TerminateInstance
    action: 'aws:executeAwsApi'
    description: 'Force terminate the existing instance (hard shutdown)'
    inputs:
      Service: ec2
      Api: TerminateInstances
      InstanceIds:
        - '{{ ResolveInstance.InstanceId }}'
      Force: true

  - name: WaitForTermination
    action: 'aws:waitForAwsResourceProperty'
    description: 'Wait for instance to be fully terminated'
    inputs:
      Service: ec2
      Api: DescribeInstances
      InstanceIds:
        - '{{ ResolveInstance.InstanceId }}'
      PropertySelector: '$.Reservations[0].Instances[0].State.Name'
      DesiredValues:
        - terminated
    timeoutSeconds: 600

  - name: LaunchNewInstance
    action: 'aws:executeAwsApi'
    description: 'Launch new instance from backup launch template'
    inputs:
      Service: ec2
      Api: RunInstances
      LaunchTemplate:
        LaunchTemplateId: '{{ FindLatestLaunchTemplate.LaunchTemplateId }}'
        Version: '{{ FindLatestLaunchTemplate.VersionNumber }}'
      MinCount: 1
      MaxCount: 1
    
    outputs:
      - Name: NewInstanceId
        Selector: $.Instances[0].InstanceId
        Type: String

  - name: WaitForRunning
    action: 'aws:waitForAwsResourceProperty'
    description: 'Wait for new instance to be running'
    inputs:
      Service: ec2
      Api: DescribeInstances
      InstanceIds:
        - '{{ LaunchNewInstance.NewInstanceId }}'
      PropertySelector: '$.Reservations[0].Instances[0].State.Name'
      DesiredValues:
        - running
    timeoutSeconds: 600

  - name: WaitForStatusChecks
    action: 'aws:waitForAwsResourceProperty'
    description: 'Wait for instance status checks to complete'
    inputs:
      Service: ec2
      Api: DescribeInstanceStatus
      InstanceIds:
        - '{{ LaunchNewInstance.NewInstanceId }}'
      PropertySelector: '$.InstanceStatuses[0].InstanceStatus.Status'
      DesiredValues:
        - ok
    timeoutSeconds: 900

  - name: EnableTerminationProtection
    action: 'aws:executeAwsApi'
    description: 'Enable termination protection on the restored instance'
    inputs:
      Service: ec2
      Api: ModifyInstanceAttribute
      InstanceId: '{{ LaunchNewInstance.NewInstanceId }}'
      DisableApiTermination:
        Value: true

  - name: CleanupBackupResources
    action: 'aws:executeScript'
    description: 'Delete all launch templates, AMIs, and snapshots for this instance'
    inputs:
      Runtime: python3.11
      Handler: cleanup_resources
      Script: |
        import boto3
        
        def cleanup_resources(events, context):
            region = events['TargetRegion']
            instance_name = events['InstanceName']
            
            ec2 = boto3.client('ec2', region_name=region)
            
            # Find all launch templates with matching Name tag
            templates = ec2.describe_launch_templates()
            deleted_templates = []
            deleted_amis = []
            deleted_snapshots = []
            
            for template in templates['LaunchTemplates']:
                template_tags = ec2.describe_tags(
                    Filters=[
                        {'Name': 'resource-id', 'Values': [template['LaunchTemplateId']]},
                        {'Name': 'resource-type', 'Values': ['launch-template']}
                    ]
                )['Tags']
                
                template_name_tag = next((tag['Value'] for tag in template_tags if tag['Key'] == 'Name'), None)
                if template_name_tag == instance_name:
                    # Get AMI ID from template before deleting
                    template_versions = ec2.describe_launch_template_versions(
                        LaunchTemplateId=template['LaunchTemplateId']
                    )
                    
                    for version in template_versions['LaunchTemplateVersions']:
                        ami_id = version['LaunchTemplateData']['ImageId']
                        
                        # Get snapshots associated with AMI
                        try:
                            ami_response = ec2.describe_images(ImageIds=[ami_id])
                            if ami_response['Images']:
                                ami = ami_response['Images'][0]
                                for block_device in ami.get('BlockDeviceMappings', []):
                                    if 'Ebs' in block_device and 'SnapshotId' in block_device['Ebs']:
                                        snapshot_id = block_device['Ebs']['SnapshotId']
                                        try:
                                            ec2.delete_snapshot(SnapshotId=snapshot_id)
                                            deleted_snapshots.append(snapshot_id)
                                        except Exception:
                                            pass
                                
                                # Delete AMI
                                try:
                                    ec2.deregister_image(ImageId=ami_id)
                                    deleted_amis.append(ami_id)
                                except Exception:
                                    pass
                        except Exception:
                            pass
                    
                    # Delete launch template
                    try:
                        ec2.delete_launch_template(LaunchTemplateId=template['LaunchTemplateId'])
                        deleted_templates.append(template['LaunchTemplateName'])
                    except Exception:
                        pass
            
            return {
                'DeletedTemplates': deleted_templates,
                'DeletedAMIs': deleted_amis,
                'DeletedSnapshots': deleted_snapshots
            }
      
      InputPayload:
        TargetRegion: '{{ TargetRegion }}'
        InstanceName: '{{ ResolveInstance.InstanceName }}'
    
    outputs:
      - Name: DeletedTemplates
        Selector: $.Payload.DeletedTemplates
        Type: StringList
      - Name: DeletedAMIs
        Selector: $.Payload.DeletedAMIs
        Type: StringList
      - Name: DeletedSnapshots
        Selector: $.Payload.DeletedSnapshots
        Type: StringList

outputs:
  - LaunchNewInstance.NewInstanceId
  - FindLatestLaunchTemplate.LaunchTemplateName
  - FindLatestLaunchTemplate.AmiId
  - FindLatestLaunchTemplate.CreationDate
  - ResolveInstance.InstanceId
  - CleanupBackupResources.DeletedTemplates
  - CleanupBackupResources.DeletedAMIs
  - CleanupBackupResources.DeletedSnapshots