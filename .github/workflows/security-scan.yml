name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read

jobs:
  python-security:
    runs-on: ubuntu-latest
    name: Python Security Scan
    continue-on-error: true
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install security tools
      run: |
        pip install bandit semgrep safety
    
    - name: Run Bandit security scan
      run: |
        bandit -r lambda/ -f json -o bandit-report.json || true
        bandit -r lambda/ -ll || true
    
    - name: Run Semgrep security scan
      run: |
        semgrep --config=auto lambda/ --json --output=semgrep-report.json || true
        semgrep --config=auto lambda/ || true
    
    - name: Run Safety dependency scan
      run: |
        safety scan --json --output safety-report.json || true
        safety scan || true
    
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: python-security-reports
        path: |
          bandit-report.json
          semgrep-report.json
          safety-report.json

  frontend-security:
    runs-on: ubuntu-latest
    name: Frontend Security Scan
    continue-on-error: true
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Run npm audit
      run: |
        cd frontend
        npm audit --audit-level moderate --json > npm-audit-report.json || true
        npm audit --audit-level moderate || true
    
    - name: Install ESLint security plugin
      run: |
        cd frontend
        npm install --save-dev eslint-plugin-security
    
    - name: Run ESLint security scan
      run: |
        cd frontend
        npx eslint src/ --ext .ts,.tsx --format json --output-file eslint-security-report.json || true
        npx eslint src/ --ext .ts,.tsx || true
    
    - name: Upload frontend security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: frontend-security-reports
        path: |
          frontend/npm-audit-report.json
          frontend/eslint-security-report.json

  cloudformation-security:
    runs-on: ubuntu-latest
    name: CloudFormation Security Scan
    continue-on-error: true
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install cfn-lint
      run: |
        pip install cfn-lint
    
    - name: Run CloudFormation security scan
      run: |
        cfn-lint cfn/*.yaml --format json --output-file cfn-lint-report.json || true
        cfn-lint cfn/*.yaml || true
    
    - name: Upload CloudFormation security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cloudformation-security-reports
        path: cfn-lint-report.json

  security-summary:
    runs-on: ubuntu-latest
    name: Security Summary
    needs: [python-security, frontend-security, cloudformation-security]
    if: always()
    
    steps:
    - name: Download all security reports
      uses: actions/download-artifact@v4
    
    - name: Generate security summary
      run: |
        echo "# Security Scan Summary" > security-summary.md
        echo "" >> security-summary.md
        echo "## Scan Results" >> security-summary.md
        echo "" >> security-summary.md
        
        if [ -f python-security-reports/bandit-report.json ]; then
          echo "### Python Security (Bandit)" >> security-summary.md
          echo "- Report available: bandit-report.json" >> security-summary.md
        fi
        
        if [ -f frontend-security-reports/npm-audit-report.json ]; then
          echo "### Frontend Security (npm audit)" >> security-summary.md
          echo "- Report available: npm-audit-report.json" >> security-summary.md
        fi
        
        if [ -f cloudformation-security-reports/cfn-lint-report.json ]; then
          echo "### CloudFormation Security (cfn-lint)" >> security-summary.md
          echo "- Report available: cfn-lint-report.json" >> security-summary.md
        fi
        
        echo "" >> security-summary.md
        echo "## Next Steps" >> security-summary.md
        echo "1. Review all security reports" >> security-summary.md
        echo "2. Fix critical and high severity issues" >> security-summary.md
        echo "3. Update dependencies with known vulnerabilities" >> security-summary.md
        echo "4. Implement additional security controls as needed" >> security-summary.md
        
        cat security-summary.md
    
    - name: Upload security summary
      uses: actions/upload-artifact@v4
      with:
        name: security-summary
        path: security-summary.md